Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 1
scall.ASM



      1				     $comm   macro   name,dist,size,count
      2					     comm    dist name[size]:BYTE:count
      3					     endm
      4					     ?debug  V 300h
      5					     ?debug  S "scall.c"
      6					     ?debug  C E913A27947077363616C6C2E63
      7					     ?debug  C E927A07947086D696E69534F2E68
      8					     ?debug  C E9359E7947077363616C6C2E68
      9					     ?debug  C E9789C7947056C69622E68
     10	0000			     _TEXT   segment byte public 'CODE'
     11	0000			     _TEXT   ends
     12				     DGROUP  group   _DATA,_BSS
     13					     assume  cs:_TEXT,ds:DGROUP
     14	0000			     _DATA   segment word public 'DATA'
     15	0000			     d@	     label   byte
     16	0000			     d@w     label   word
     17	0000			     _DATA   ends
     18	0000			     _BSS    segment word public 'BSS'
     19	0000			     b@	     label   byte
     20	0000			     b@w     label   word
     21	0000			     _BSS    ends
     22	0000			     _DATA   segment word public 'DATA'
     23	0000			     miniSO_col	     label   byte
     24	0000  50			     db	     80
     25	0001			     miniSO_cor	     label   byte
     26	0001  07			     db	     7
     27	0002			     miniSO_pag	     label   byte
     28	0002  00			     db	     0
     29	0003			     miniSO_iskey    label   byte
     30	0003  00			     db	     0
     31	0004			     miniSO_key	     label   byte
     32	0004  00			     db	     0
     33	0005			     nextsemid	     label   word
     34	0005  00			     db	     0
     35	0006  00			     db	     0
     36	0007			     _miniSO_ready   label   word
     37	0007  FF			     db	     255
     38	0008  FF			     db	     255
     39	0009			     _miniSO_free    label   word
     40	0009  FF			     db	     255
     41	000A  FF			     db	     255
     42	000B			     _miniSO_scall_table     label   word
     43	000B  00			     db	     0
     44	000C  01			     db	     1
     45	000D  00			     db	     0
     46	000E  00DAr			     dw	     _sc_putch
     47	0010  01			     db	     1
     48	0011  00			     db	     0
     49	0012  00			     db	     0
     50	0013  0170r			     dw	     _sc_getch
     51	0015  02			     db	     2
     52	0016  00			     db	     0
     53	0017  00			     db	     0
     54	0018  01C0r			     dw	     _sc_clrscr
     55	001A  03			     db	     3
     56	001B  00			     db	     0
     57	001C  00			     db	     0
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 2
scall.ASM



     58	001D  01E2r			     dw	     _sc_getcolor
     59	001F  04			     db	     4
     60	0020  01			     db	     1
     61	0021  00			     db	     0
     62	0022  01EDr			     dw	     _sc_setcolor
     63	0024  05			     db	     5
     64	0025  00			     db	     0
     65	0026  00			     db	     0
     66	0027  01FCr			     dw	     _sc_wherex
     67	0029  06			     db	     6
     68	002A  00			     db	     0
     69	002B  00			     db	     0
     70	002C  0209r			     dw	     _sc_wherey
     71	002E  07			     db	     7
     72	002F  02			     db	     2
     73	0030  00			     db	     0
     74	0031  021Ar			     dw	     _sc_gotoxy
     75	0033  08			     db	     8
     76	0034  02			     db	     2
     77	0035  00			     db	     0
     78	0036  0248r			     dw	     _sc_getdate
     79	0038  09			     db	     9
     80	0039  02			     db	     2
     81	003A  00			     db	     0
     82	003B  02F8r			     dw	     _sc_gettime
     83	003D  0A			     db	     10
     84	003E  00			     db	     0
     85	003F  00			     db	     0
     86	0040  05B8r			     dw	     _sc_reboot
     87	0042  0B			     db	     11
     88	0043  02			     db	     2
     89	0044  00			     db	     0
     90	0045  05D8r			     dw	     _sc_fork
     91	0047  0C			     db	     12
     92	0048  01			     db	     1
     93	0049  00			     db	     0
     94	004A  0825r			     dw	     _sc_kill
     95	004C  0D			     db	     13
     96	004D  03			     db	     3
     97	004E  00			     db	     0
     98	004F  0B21r			     dw	     _sc_waitpid
     99	0051  0E			     db	     14
    100	0052  02			     db	     2
    101	0053  00			     db	     0
    102	0054  0CDCr			     dw	     _sc_wait
    103	0056  0F			     db	     15
    104	0057  01			     db	     1
    105	0058  00			     db	     0
    106	0059  0E56r			     dw	     _sc_exit
    107	005B  10			     db	     16
    108	005C  00			     db	     0
    109	005D  00			     db	     0
    110	005E  10F5r			     dw	     _sc_getpid
    111	0060  11			     db	     17
    112	0061  00			     db	     0
    113	0062  00			     db	     0
    114	0063  110Ar			     dw	     _sc_getppid
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 3
scall.ASM



    115	0065  12			     db	     18
    116	0066  02			     db	     2
    117	0067  00			     db	     0
    118	0068  111Fr			     dw	     _sc_sendsignal
    119	006A  13			     db	     19
    120	006B  01			     db	     1
    121	006C  00			     db	     0
    122	006D  121Fr			     dw	     _sc_waitsignal
    123	006F  14			     db	     20
    124	0070  01			     db	     1
    125	0071  00			     db	     0
    126	0072  1355r			     dw	     _sc_semcreate
    127	0074  15			     db	     21
    128	0075  02			     db	     2
    129	0076  00			     db	     0
    130	0077  13E0r			     dw	     _sc_semset
    131	0079  16			     db	     22
    132	007A  01			     db	     1
    133	007B  00			     db	     0
    134	007C  1419r			     dw	     _sc_semup
    135	007E  17			     db	     23
    136	007F  01			     db	     1
    137	0080  00			     db	     0
    138	0081  1506r			     dw	     _sc_semdown
    139	0083  18			     db	     24
    140	0084  01			     db	     1
    141	0085  00			     db	     0
    142	0086  164Cr			     dw	     _sc_semdestroy
    143	0088  19			     db	     25
    144	0089  01			     db	     1
    145	008A  00			     db	     0
    146	008B  1684r			     dw	     _sc_stop
    147	008D  1A			     db	     26
    148	008E  01			     db	     1
    149	008F  00			     db	     0
    150	0090  172Br			     dw	     _sc_resume
    151	0092			     _DATA   ends
    152	0000			     _TEXT   segment byte public 'CODE'
    153					;
    154					;    int scall(unsigned	servico,unsigned bx,unsigned cx,unsigned dx)
    155					;
    156					     assume  cs:_TEXT
    157	0000			     _scall  proc    near
    158	0000  55			     push    bp
    159	0001  8B EC			     mov     bp,sp
    160	0003  56			     push    si
    161	0004  57			     push    di
    162	0005  8B 7E 06			     mov     di,word ptr [bp+6]
    163					;
    164					;    {
    165					;	     int     i;
    166					;
    167					;	     for     (i=0;i<miniSO_NUMSCALL;++i) {
    168					;
    169	0008  33 F6			     xor     si,si
    170	000A  EB 7C 90			     jmp     @1@338
    171	000D			     @1@58:
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 4
scall.ASM



    172					;
    173					;		     if	     (servico==(unsigned)miniSO_scall_table[i].ah) {
    174					;
    175	000D  8B C6			     mov     ax,si
    176	000F  BA 0005			     mov     dx,5
    177	0012  F7 EA			     imul    dx
    178	0014  8B D8			     mov     bx,ax
    179	0016  8A 87 000Br		     mov     al,byte ptr DGROUP:_miniSO_scall_table[bx]
    180	001A  98			     cbw
    181	001B  3B 46 04			     cmp     ax,word ptr [bp+4]
    182	001E  75 67			     jne     short @1@310
    183					;
    184					;			     switch  (miniSO_scall_table[i].numparam)  {
    185					;
    186	0020  8B C6			     mov     ax,si
    187	0022  BA 0005			     mov     dx,5
    188	0025  F7 EA			     imul    dx
    189	0027  8B D8			     mov     bx,ax
    190	0029  8B 9F 000Cr		     mov     bx,word ptr DGROUP:_miniSO_scall_table[bx+1]
    191	002D  83 FB 03			     cmp     bx,3
    192	0030  77 55			     ja	     short @1@310
    193	0032  D1 E3			     shl     bx,1
    194	0034  2E: FF A7	0098r		     jmp     word ptr cs:@1@C434[bx]
    195	0039			     @1@170:
    196					;
    197					;				     case    0:
    198					;					     return miniSO_scall_table[i].function.p0();
    199					;
    200	0039  8B C6			     mov     ax,si
    201	003B  BA 0005			     mov     dx,5
    202	003E  F7 EA			     imul    dx
    203	0040  8B D8			     mov     bx,ax
    204	0042  FF 97 000Er		     call    word ptr DGROUP:_miniSO_scall_table[bx+3]
    205	0046			     @1@198:
    206	0046  EB 4C			     jmp     short @1@394
    207	0048			     @1@226:
    208					;
    209					;				     case    1:
    210					;					     return miniSO_scall_table[i].function.p1(bx);
    211					;
    212	0048  57			     push    di
    213	0049  8B C6			     mov     ax,si
    214	004B  BA 0005			     mov     dx,5
    215	004E  F7 EA			     imul    dx
    216	0050  8B D8			     mov     bx,ax
    217	0052  FF 97 000Er		     call    word ptr DGROUP:_miniSO_scall_table[bx+3]
    218	0056  59			     pop     cx
    219	0057  EB ED			     jmp     short @1@198
    220	0059			     @1@254:
    221					;
    222					;				     case    2:
    223					;					     return miniSO_scall_table[i].function.p2(bx,cx);
    224					;
    225	0059  FF 76 08			     push    word ptr [bp+8]
    226	005C  57			     push    di
    227	005D  8B C6			     mov     ax,si
    228	005F  BA 0005			     mov     dx,5
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 5
scall.ASM



    229	0062  F7 EA			     imul    dx
    230	0064  8B D8			     mov     bx,ax
    231	0066  FF 97 000Er		     call    word ptr DGROUP:_miniSO_scall_table[bx+3]
    232	006A  59			     pop     cx
    233	006B  59			     pop     cx
    234	006C  EB D8			     jmp     short @1@198
    235	006E			     @1@282:
    236					;
    237					;				     case    3:
    238					;					     return miniSO_scall_table[i].function.p3(bx,cx,+
    239				     dx);
    240					;
    241	006E  FF 76 0A			     push    word ptr [bp+10]
    242	0071  FF 76 08			     push    word ptr [bp+8]
    243	0074  57			     push    di
    244	0075  8B C6			     mov     ax,si
    245	0077  BA 0005			     mov     dx,5
    246	007A  F7 EA			     imul    dx
    247	007C  8B D8			     mov     bx,ax
    248	007E  FF 97 000Er		     call    word ptr DGROUP:_miniSO_scall_table[bx+3]
    249	0082  83 C4 06			     add     sp,6
    250	0085  EB BF			     jmp     short @1@198
    251	0087			     @1@310:
    252	0087  46			     inc     si
    253	0088			     @1@338:
    254	0088  83 FE 1B			     cmp     si,27
    255	008B  7D 03			     jge     @@0
    256	008D  E9 FF7D			     jmp     @1@58
    257	0090			     @@0:
    258					;
    259					;			     }
    260					;		     }
    261					;	     }
    262					;	     return 0;
    263					;
    264	0090  33 C0			     xor     ax,ax
    265	0092  EB B2			     jmp     short @1@198
    266	0094			     @1@394:
    267					;
    268					;    }
    269					;
    270	0094  5F			     pop     di
    271	0095  5E			     pop     si
    272	0096  5D			     pop     bp
    273	0097  C3			     ret
    274	0098			     _scall  endp
    275	0098			     @1@C434 label   word
    276	0098  0039r			     dw	     @1@170
    277	009A  0048r			     dw	     @1@226
    278	009C  0059r			     dw	     @1@254
    279	009E  006Er			     dw	     @1@282
    280					;
    281					;    void setCursorPosition(int	pos)
    282					;
    283					     assume  cs:_TEXT
    284	00A0			     setCursorPosition	     proc    near
    285	00A0  55			     push    bp
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 6
scall.ASM



    286	00A1  8B EC			     mov     bp,sp
    287					;
    288					;    {
    289					;	     mov_dx(pos);
    290					;
    291	00A3  8B 56 04			     mov     dx,word ptr [bp+4]
    292					;
    293					;	     mov_bh(miniSO_pag);
    294					;
    295	00A6  8A 3E 0002r		     mov     bh,byte ptr DGROUP:miniSO_pag
    296					;
    297					;	     mov_ah(2);
    298					;
    299	00AA  B4 02			     mov     ah,2
    300					;
    301					;	     int_10h();
    302					;
    303	00AC  CD 10			     int      10h
    304					;
    305					;    }
    306					;
    307	00AE  5D			     pop     bp
    308	00AF  C3			     ret
    309	00B0			     setCursorPosition	     endp
    310					;
    311					;    int getCursorPosition()
    312					;
    313					     assume  cs:_TEXT
    314	00B0			     getCursorPosition	     proc    near
    315	00B0  55			     push    bp
    316	00B1  8B EC			     mov     bp,sp
    317					;
    318					;    {
    319					;	     mov_bh(miniSO_pag);
    320					;
    321	00B3  8A 3E 0002r		     mov     bh,byte ptr DGROUP:miniSO_pag
    322					;
    323					;	     mov_ah(3);
    324					;
    325	00B7  B4 03			     mov     ah,3
    326					;
    327					;	     int_10h();
    328					;
    329	00B9  CD 10			     int      10h
    330					;
    331					;	     return _DX;
    332					;
    333	00BB  8B C2			     mov     ax,dx
    334	00BD  EB 00			     jmp     short @3@114
    335	00BF			     @3@114:
    336					;
    337					;    }
    338					;
    339	00BF  5D			     pop     bp
    340	00C0  C3			     ret
    341	00C1			     getCursorPosition	     endp
    342					;
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 7
scall.ASM



    343					;    void scroll()
    344					;
    345					     assume  cs:_TEXT
    346	00C1			     scroll  proc    near
    347	00C1  55			     push    bp
    348	00C2  8B EC			     mov     bp,sp
    349					;
    350					;    {
    351					;	     mov_al(1);	/* número de linhas para scroll	*/
    352					;
    353	00C4  B0 01			     mov     al,1
    354					;
    355					;	     mov_cx(0);
    356					;
    357	00C6  33 C9			     xor     cx,cx
    358					;
    359					;	     mov_ah(6);
    360					;
    361	00C8  B4 06			     mov     ah,6
    362					;
    363					;	     mov_dh(24);
    364					;
    365	00CA  B6 18			     mov     dh,24
    366					;
    367					;	     mov_dl(miniSO_col);
    368					;
    369	00CC  8A 16 0000r		     mov     dl,byte ptr DGROUP:miniSO_col
    370					;
    371					;	     dec_dl();
    372					;
    373	00D0  FE CA			     dec      dl
    374					;
    375					;	     mov_bh(miniSO_cor);
    376					;
    377	00D2  8A 3E 0001r		     mov     bh,byte ptr DGROUP:miniSO_cor
    378					;
    379					;	     int_10h();
    380					;
    381	00D6  CD 10			     int      10h
    382					;
    383					;    }
    384					;
    385	00D8  5D			     pop     bp
    386	00D9  C3			     ret
    387	00DA			     scroll  endp
    388					;
    389					;    int sc_putch(int car)
    390					;
    391					     assume  cs:_TEXT
    392	00DA			     _sc_putch	     proc    near
    393	00DA  55			     push    bp
    394	00DB  8B EC			     mov     bp,sp
    395	00DD  83 EC 02			     sub     sp,2
    396	00E0  56			     push    si
    397	00E1  57			     push    di
    398					;
    399					;    {
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 8
scall.ASM



    400					;	     int     curpos,lin,col;
    401					;
    402					;	     car = car & 0x00ff;
    403					;
    404	00E2  8B 46 04			     mov     ax,word ptr [bp+4]
    405	00E5  25 00FF			     and     ax,255
    406	00E8  89 46 04			     mov     word ptr [bp+4],ax
    407					;
    408					;	     if	     (car==10)	{
    409					;
    410	00EB  83 7E 04 0A		     cmp     word ptr [bp+4],10
    411	00EF  75 22			     jne     short @5@170
    412					;
    413					;		     curpos = getCursorPosition();
    414					;
    415	00F1  E8 FFBC			     call    near ptr getCursorPosition
    416	00F4  8B F8			     mov     di,ax
    417					;
    418					;		     lin = (curpos >> 8) & 0x00ff;
    419					;
    420	00F6  8B C7			     mov     ax,di
    421	00F8  B1 08			     mov     cl,8
    422	00FA  D3 F8			     sar     ax,cl
    423	00FC  25 00FF			     and     ax,255
    424	00FF  8B F0			     mov     si,ax
    425					;
    426					;		     col = 0;
    427					;
    428	0101  C7 46 FE 0000		     mov     word ptr [bp-2],0
    429					;
    430					;		     if	     (lin<24)
    431					;
    432	0106  83 FE 18			     cmp     si,24
    433	0109  7D 03			     jge     short @5@114
    434					;
    435					;			     ++lin;
    436					;
    437	010B  46			     inc     si
    438	010C  EB 03			     jmp     short @5@142
    439	010E			     @5@114:
    440					;
    441					;		     else
    442					;			     scroll();
    443					;
    444	010E  E8 FFB0			     call    near ptr scroll
    445	0111			     @5@142:
    446					;
    447					;	     }
    448					;
    449	0111  EB 43			     jmp     short @5@338
    450	0113			     @5@170:
    451					;
    452					;	     else    {
    453					;		     /*	Imprime	o caracter */
    454					;		     mov_bl(miniSO_cor);
    455					;
    456	0113  8A 1E 0001r		     mov     bl,byte ptr DGROUP:miniSO_cor
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 9
scall.ASM



    457					;
    458					;		     mov_bh(miniSO_pag);
    459					;
    460	0117  8A 3E 0002r		     mov     bh,byte ptr DGROUP:miniSO_pag
    461					;
    462					;		     mov_cx(1);
    463					;
    464	011B  B9 0001			     mov     cx,1
    465					;
    466					;		     mov_ah(0x9);
    467					;
    468	011E  B4 09			     mov     ah,9
    469					;
    470					;		     int_10h();
    471					;
    472	0120  CD 10			     int      10h
    473					;
    474					;		     curpos = getCursorPosition();
    475					;
    476	0122  E8 FF8B			     call    near ptr getCursorPosition
    477	0125  8B F8			     mov     di,ax
    478					;
    479					;		     lin = (curpos >> 8) & 0x00ff;
    480					;
    481	0127  8B C7			     mov     ax,di
    482	0129  B1 08			     mov     cl,8
    483	012B  D3 F8			     sar     ax,cl
    484	012D  25 00FF			     and     ax,255
    485	0130  8B F0			     mov     si,ax
    486					;
    487					;		     col = curpos & 0x00ff;
    488					;
    489	0132  8B C7			     mov     ax,di
    490	0134  25 00FF			     and     ax,255
    491	0137  89 46 FE			     mov     word ptr [bp-2],ax
    492					;
    493					;		     ++col;
    494					;
    495	013A  FF 46 FE			     inc     word ptr [bp-2]
    496					;
    497					;		     if	     (col==miniSO_col)	{
    498					;
    499	013D  A0 0000r			     mov     al,byte ptr DGROUP:miniSO_col
    500	0140  98			     cbw
    501	0141  3B 46 FE			     cmp     ax,word ptr [bp-2]
    502	0144  75 10			     jne     short @5@338
    503					;
    504					;			     col = 0;
    505					;
    506	0146  C7 46 FE 0000		     mov     word ptr [bp-2],0
    507					;
    508					;			     if	     (lin<24)
    509					;
    510	014B  83 FE 18			     cmp     si,24
    511	014E  7D 03			     jge     short @5@310
    512					;
    513					;				     ++lin;
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 10
scall.ASM



    514					;
    515	0150  46			     inc     si
    516	0151  EB 03			     jmp     short @5@338
    517	0153			     @5@310:
    518					;
    519					;			     else
    520					;				     scroll();
    521					;
    522	0153  E8 FF6B			     call    near ptr scroll
    523	0156			     @5@338:
    524					;
    525					;		     }
    526					;	     }
    527					;	     curpos = (lin << 8)|col;
    528					;
    529	0156  8B C6			     mov     ax,si
    530	0158  B1 08			     mov     cl,8
    531	015A  D3 E0			     shl     ax,cl
    532	015C  0B 46 FE			     or	     ax,word ptr [bp-2]
    533	015F  8B F8			     mov     di,ax
    534					;
    535					;	     setCursorPosition(curpos);
    536					;
    537	0161  57			     push    di
    538	0162  E8 FF3B			     call    near ptr setCursorPosition
    539	0165  59			     pop     cx
    540					;
    541					;	     return 0;
    542					;
    543	0166  33 C0			     xor     ax,ax
    544	0168  EB 00			     jmp     short @5@366
    545	016A			     @5@366:
    546					;
    547					;    }
    548					;
    549	016A  5F			     pop     di
    550	016B  5E			     pop     si
    551	016C  8B E5			     mov     sp,bp
    552	016E  5D			     pop     bp
    553	016F  C3			     ret
    554	0170			     _sc_putch	     endp
    555					;
    556					;    int sc_getch()
    557					;
    558					     assume  cs:_TEXT
    559	0170			     _sc_getch	     proc    near
    560	0170  55			     push    bp
    561	0171  8B EC			     mov     bp,sp
    562	0173  83 EC 02			     sub     sp,2
    563					;
    564					;    {
    565					;      int ax,al,ah;
    566					;
    567					;      if (miniSO_iskey!=0)  {
    568					;
    569	0176  80 3E 0003r 00		     cmp     byte ptr DGROUP:miniSO_iskey,0
    570	017B  74 0B			     je	     short @6@114
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 11
scall.ASM



    571					;
    572					;	  miniSO_iskey = 0;
    573					;
    574	017D  C6 06 0003r 00		     mov     byte ptr DGROUP:miniSO_iskey,0
    575					;
    576					;	  return miniSO_key;
    577					;
    578	0182  A0 0004r			     mov     al,byte ptr DGROUP:miniSO_key
    579	0185  98			     cbw
    580	0186			     @6@86:
    581	0186  EB 34			     jmp     short @6@282
    582	0188			     @6@114:
    583					;
    584					;      }
    585					;
    586					;      mov_ah(0x10);
    587					;
    588	0188  B4 10			     mov     ah,16
    589					;
    590					;      int_16h();
    591					;
    592	018A  CD 16			     int      16h
    593					;
    594					;
    595					;      ax = get_ax();
    596					;
    597	018C  8B D8			     mov     bx,ax
    598					;
    599					;      ah = (ax	>> 8) &	0x00ff;
    600					;
    601	018E  8B C3			     mov     ax,bx
    602	0190  B1 08			     mov     cl,8
    603	0192  D3 F8			     sar     ax,cl
    604	0194  25 00FF			     and     ax,255
    605	0197  89 46 FE			     mov     word ptr [bp-2],ax
    606					;
    607					;      al = 0x00ff & ax;
    608					;
    609	019A  B8 00FF			     mov     ax,255
    610	019D  23 C3			     and     ax,bx
    611	019F  8B D0			     mov     dx,ax
    612					;
    613					;
    614					;      if (al==0xe0 || al==0x00)  {
    615					;
    616	01A1  81 FA 00E0		     cmp     dx,224
    617	01A5  74 04			     je	     short @6@226
    618	01A7  0B D2			     or	     dx,dx
    619	01A9  75 0D			     jne     short @6@254
    620	01AB			     @6@226:
    621					;
    622					;	  miniSO_iskey = 1;
    623					;
    624	01AB  C6 06 0003r 01		     mov     byte ptr DGROUP:miniSO_iskey,1
    625					;
    626					;	  miniSO_key = ah;
    627					;
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 12
scall.ASM



    628	01B0  8A 46 FE			     mov     al,byte ptr [bp-2]
    629	01B3  A2 0004r			     mov     byte ptr DGROUP:miniSO_key,al
    630					;
    631					;	  al = 0;
    632					;
    633	01B6  33 D2			     xor     dx,dx
    634	01B8			     @6@254:
    635					;
    636					;      }
    637					;      return al;
    638					;
    639	01B8  8B C2			     mov     ax,dx
    640	01BA  EB CA			     jmp     short @6@86
    641	01BC			     @6@282:
    642					;
    643					;    }
    644					;
    645	01BC  8B E5			     mov     sp,bp
    646	01BE  5D			     pop     bp
    647	01BF  C3			     ret
    648	01C0			     _sc_getch	     endp
    649					;
    650					;    int sc_clrscr()
    651					;
    652					     assume  cs:_TEXT
    653	01C0			     _sc_clrscr	     proc    near
    654	01C0  55			     push    bp
    655	01C1  8B EC			     mov     bp,sp
    656					;
    657					;    {
    658					;      mov_al(0);
    659					;
    660	01C3  B0 00			     mov     al,0
    661					;
    662					;      mov_cx(0);
    663					;
    664	01C5  33 C9			     xor     cx,cx
    665					;
    666					;      mov_dh(24);
    667					;
    668	01C7  B6 18			     mov     dh,24
    669					;
    670					;      mov_dl(miniSO_col);
    671					;
    672	01C9  8A 16 0000r		     mov     dl,byte ptr DGROUP:miniSO_col
    673					;
    674					;      dec_dl();
    675					;
    676	01CD  FE CA			     dec      dl
    677					;
    678					;      mov_ah(6);
    679					;
    680	01CF  B4 06			     mov     ah,6
    681					;
    682					;      mov_bh(7);
    683					;
    684	01D1  B7 07			     mov     bh,7
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 13
scall.ASM



    685					;
    686					;      int_10h();
    687					;
    688	01D3  CD 10			     int      10h
    689					;
    690					;      setCursorPosition(0);
    691					;
    692	01D5  33 C0			     xor     ax,ax
    693	01D7  50			     push    ax
    694	01D8  E8 FEC5			     call    near ptr setCursorPosition
    695	01DB  59			     pop     cx
    696					;
    697					;      return 0;
    698					;
    699	01DC  33 C0			     xor     ax,ax
    700	01DE  EB 00			     jmp     short @7@170
    701	01E0			     @7@170:
    702					;
    703					;    }
    704					;
    705	01E0  5D			     pop     bp
    706	01E1  C3			     ret
    707	01E2			     _sc_clrscr	     endp
    708					;
    709					;    int sc_getcolor()
    710					;
    711					     assume  cs:_TEXT
    712	01E2			     _sc_getcolor    proc    near
    713	01E2  55			     push    bp
    714	01E3  8B EC			     mov     bp,sp
    715					;
    716					;    {
    717					;      return miniSO_cor;
    718					;
    719	01E5  A0 0001r			     mov     al,byte ptr DGROUP:miniSO_cor
    720	01E8  98			     cbw
    721	01E9  EB 00			     jmp     short @8@58
    722	01EB			     @8@58:
    723					;
    724					;    }
    725					;
    726	01EB  5D			     pop     bp
    727	01EC  C3			     ret
    728	01ED			     _sc_getcolor    endp
    729					;
    730					;    int sc_setcolor(int cor)
    731					;
    732					     assume  cs:_TEXT
    733	01ED			     _sc_setcolor    proc    near
    734	01ED  55			     push    bp
    735	01EE  8B EC			     mov     bp,sp
    736					;
    737					;    {
    738					;      miniSO_cor = cor;
    739					;
    740	01F0  8A 46 04			     mov     al,byte ptr [bp+4]
    741	01F3  A2 0001r			     mov     byte ptr DGROUP:miniSO_cor,al
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 14
scall.ASM



    742					;
    743					;      return 0;
    744					;
    745	01F6  33 C0			     xor     ax,ax
    746	01F8  EB 00			     jmp     short @9@58
    747	01FA			     @9@58:
    748					;
    749					;    }
    750					;
    751	01FA  5D			     pop     bp
    752	01FB  C3			     ret
    753	01FC			     _sc_setcolor    endp
    754					;
    755					;    int sc_wherex()
    756					;
    757					     assume  cs:_TEXT
    758	01FC			     _sc_wherex	     proc    near
    759	01FC  55			     push    bp
    760	01FD  8B EC			     mov     bp,sp
    761					;
    762					;    {
    763					;      return getCursorPosition() & 0x00ff;
    764					;
    765	01FF  E8 FEAE			     call    near ptr getCursorPosition
    766	0202  25 00FF			     and     ax,255
    767	0205  EB 00			     jmp     short @10@58
    768	0207			     @10@58:
    769					;
    770					;    }
    771					;
    772	0207  5D			     pop     bp
    773	0208  C3			     ret
    774	0209			     _sc_wherex	     endp
    775					;
    776					;    int sc_wherey()
    777					;
    778					     assume  cs:_TEXT
    779	0209			     _sc_wherey	     proc    near
    780	0209  55			     push    bp
    781	020A  8B EC			     mov     bp,sp
    782					;
    783					;    {
    784					;      return (getCursorPosition()>>8) & 0x00ff;
    785					;
    786	020C  E8 FEA1			     call    near ptr getCursorPosition
    787	020F  B1 08			     mov     cl,8
    788	0211  D3 F8			     sar     ax,cl
    789	0213  25 00FF			     and     ax,255
    790	0216  EB 00			     jmp     short @11@58
    791	0218			     @11@58:
    792					;
    793					;    }
    794					;
    795	0218  5D			     pop     bp
    796	0219  C3			     ret
    797	021A			     _sc_wherey	     endp
    798					;
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 15
scall.ASM



    799					;    int sc_gotoxy(int x, int y)
    800					;
    801					     assume  cs:_TEXT
    802	021A			     _sc_gotoxy	     proc    near
    803	021A  55			     push    bp
    804	021B  8B EC			     mov     bp,sp
    805	021D  56			     push    si
    806	021E  57			     push    di
    807	021F  8B 76 04			     mov     si,word ptr [bp+4]
    808	0222  8B 7E 06			     mov     di,word ptr [bp+6]
    809					;
    810					;    {
    811					;      x = x & 0x00ff;
    812					;
    813	0225  8B C6			     mov     ax,si
    814	0227  25 00FF			     and     ax,255
    815	022A  8B F0			     mov     si,ax
    816					;
    817					;      y = (y<<8) & 0xff00;
    818					;
    819	022C  8B C7			     mov     ax,di
    820	022E  B1 08			     mov     cl,8
    821	0230  D3 E0			     shl     ax,cl
    822	0232  25 FF00			     and     ax,-256
    823	0235  8B F8			     mov     di,ax
    824					;
    825					;      setCursorPosition(x|y);
    826					;
    827	0237  8B C6			     mov     ax,si
    828	0239  0B C7			     or	     ax,di
    829	023B  50			     push    ax
    830	023C  E8 FE61			     call    near ptr setCursorPosition
    831	023F  59			     pop     cx
    832					;
    833					;      return 0;
    834					;
    835	0240  33 C0			     xor     ax,ax
    836	0242  EB 00			     jmp     short @12@58
    837	0244			     @12@58:
    838					;
    839					;    }
    840					;
    841	0244  5F			     pop     di
    842	0245  5E			     pop     si
    843	0246  5D			     pop     bp
    844	0247  C3			     ret
    845	0248			     _sc_gotoxy	     endp
    846					;
    847					;    int sc_getdate(unsigned seg, unsigned off)
    848					;
    849					     assume  cs:_TEXT
    850	0248			     _sc_getdate     proc    near
    851	0248  55			     push    bp
    852	0249  8B EC			     mov     bp,sp
    853	024B  83 EC 08			     sub     sp,8
    854	024E  56			     push    si
    855					;
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 16
scall.ASM



    856					;    {
    857					;      struct date far *dt;
    858					;      unsigned	d,m,a;
    859					;
    860					;      dt = MK_FP(seg,off);
    861					;
    862	024F  FF 76 06			     push    word ptr [bp+6]
    863	0252  FF 76 04			     push    word ptr [bp+4]
    864	0255  E8 0000e			     call    near ptr _MK_FP
    865	0258  59			     pop     cx
    866	0259  59			     pop     cx
    867	025A  89 56 FE			     mov     word ptr [bp-2],dx
    868	025D  89 46 FC			     mov     word ptr [bp-4],ax
    869					;
    870					;      mov_ah(4);
    871					;
    872	0260  B4 04			     mov     ah,4
    873					;
    874					;      int_1ah();
    875					;
    876	0262  CD 1A			     int      1ah
    877					;
    878					;      d=get_dl();
    879					;
    880	0264  8A C2			     mov     al,dl
    881	0266  B4 00			     mov     ah,0
    882	0268  89 46 FA			     mov     word ptr [bp-6],ax
    883					;
    884					;      m=get_dh();
    885					;
    886	026B  8A C6			     mov     al,dh
    887	026D  B4 00			     mov     ah,0
    888	026F  89 46 F8			     mov     word ptr [bp-8],ax
    889					;
    890					;      a=get_cx();
    891					;
    892	0272  8B F1			     mov     si,cx
    893					;
    894					;      dt->da_day  = 10*((d & 0xf0)>>4)	+ (d & 0x0f);
    895					;
    896	0274  8B 46 FA			     mov     ax,word ptr [bp-6]
    897	0277  25 00F0			     and     ax,240
    898	027A  B1 04			     mov     cl,4
    899	027C  D3 E8			     shr     ax,cl
    900	027E  BA 000A			     mov     dx,10
    901	0281  F7 EA			     imul    dx
    902	0283  8A 56 FA			     mov     dl,byte ptr [bp-6]
    903	0286  80 E2 0F			     and     dl,15
    904	0289  02 C2			     add     al,dl
    905	028B  C4 5E FC			     les     bx,dword ptr [bp-4]
    906	028E  26: 88 47	02		     mov     byte ptr es:[bx+2],al
    907					;
    908					;      dt->da_mon  = 10*((m & 0xf0)>>4)	+ (m & 0x0f);
    909					;
    910	0292  8B 46 F8			     mov     ax,word ptr [bp-8]
    911	0295  25 00F0			     and     ax,240
    912	0298  B1 04			     mov     cl,4
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 17
scall.ASM



    913	029A  D3 E8			     shr     ax,cl
    914	029C  BA 000A			     mov     dx,10
    915	029F  F7 EA			     imul    dx
    916	02A1  8A 56 F8			     mov     dl,byte ptr [bp-8]
    917	02A4  80 E2 0F			     and     dl,15
    918	02A7  02 C2			     add     al,dl
    919	02A9  C4 5E FC			     les     bx,dword ptr [bp-4]
    920	02AC  26: 88 47	03		     mov     byte ptr es:[bx+3],al
    921					;
    922					;      dt->da_year = 1000*((a &	0xf000)>>12) + 100*((a & 0x0f00)>>8) + 10*((a &	0x00f0)>>4) +
    923				     + (a & 0x000f);
    924					;
    925	02B0  8B C6			     mov     ax,si
    926	02B2  25 F000			     and     ax,-4096
    927	02B5  B1 0C			     mov     cl,12
    928	02B7  D3 E8			     shr     ax,cl
    929	02B9  BA 03E8			     mov     dx,1000
    930	02BC  F7 EA			     imul    dx
    931	02BE  50			     push    ax
    932	02BF  8B C6			     mov     ax,si
    933	02C1  25 0F00			     and     ax,3840
    934	02C4  B1 08			     mov     cl,8
    935	02C6  D3 E8			     shr     ax,cl
    936	02C8  BA 0064			     mov     dx,100
    937	02CB  F7 EA			     imul    dx
    938	02CD  5A			     pop     dx
    939	02CE  03 D0			     add     dx,ax
    940	02D0  8B C6			     mov     ax,si
    941	02D2  25 00F0			     and     ax,240
    942	02D5  B1 04			     mov     cl,4
    943	02D7  D3 E8			     shr     ax,cl
    944	02D9  BB 000A			     mov     bx,10
    945	02DC  52			     push    dx
    946	02DD  F7 EB			     imul    bx
    947	02DF  5A			     pop     dx
    948	02E0  03 D0			     add     dx,ax
    949	02E2  8B C6			     mov     ax,si
    950	02E4  25 000F			     and     ax,15
    951	02E7  03 D0			     add     dx,ax
    952	02E9  C4 5E FC			     les     bx,dword ptr [bp-4]
    953	02EC  26: 89 17			     mov     word ptr es:[bx],dx
    954					;
    955					;      return 0;
    956					;
    957	02EF  33 C0			     xor     ax,ax
    958	02F1  EB 00			     jmp     short @13@114
    959	02F3			     @13@114:
    960					;
    961					;    }
    962					;
    963	02F3  5E			     pop     si
    964	02F4  8B E5			     mov     sp,bp
    965	02F6  5D			     pop     bp
    966	02F7  C3			     ret
    967	02F8			     _sc_getdate     endp
    968					;
    969					;    int sc_gettime(unsigned seg,unsigned off)
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 18
scall.ASM



    970					;
    971					     assume  cs:_TEXT
    972	02F8			     _sc_gettime     proc    near
    973	02F8  55			     push    bp
    974	02F9  8B EC			     mov     bp,sp
    975	02FB  83 EC 0A			     sub     sp,10
    976					;
    977					;    {
    978					;      struct time far *tm;
    979					;      unsigned	h,m,s;
    980					;
    981					;      tm = MK_FP(seg,off);
    982					;
    983	02FE  FF 76 06			     push    word ptr [bp+6]
    984	0301  FF 76 04			     push    word ptr [bp+4]
    985	0304  E8 0000e			     call    near ptr _MK_FP
    986	0307  59			     pop     cx
    987	0308  59			     pop     cx
    988	0309  89 56 FE			     mov     word ptr [bp-2],dx
    989	030C  89 46 FC			     mov     word ptr [bp-4],ax
    990					;
    991					;      mov_ah(2);
    992					;
    993	030F  B4 02			     mov     ah,2
    994					;
    995					;      int_1ah();
    996					;
    997	0311  CD 1A			     int      1ah
    998					;
    999					;      h=get_ch();
   1000					;
   1001	0313  8A C5			     mov     al,ch
   1002	0315  B4 00			     mov     ah,0
   1003	0317  89 46 FA			     mov     word ptr [bp-6],ax
   1004					;
   1005					;      m=get_cl();
   1006					;
   1007	031A  8A C1			     mov     al,cl
   1008	031C  B4 00			     mov     ah,0
   1009	031E  89 46 F8			     mov     word ptr [bp-8],ax
   1010					;
   1011					;      s=get_dh();
   1012					;
   1013	0321  8A C6			     mov     al,dh
   1014	0323  B4 00			     mov     ah,0
   1015	0325  89 46 F6			     mov     word ptr [bp-10],ax
   1016					;
   1017					;      tm->ti_hour = 10*((h & 0xf0)>>4)	+ (h & 0x0f);
   1018					;
   1019	0328  8B 46 FA			     mov     ax,word ptr [bp-6]
   1020	032B  25 00F0			     and     ax,240
   1021	032E  B1 04			     mov     cl,4
   1022	0330  D3 E8			     shr     ax,cl
   1023	0332  BA 000A			     mov     dx,10
   1024	0335  F7 EA			     imul    dx
   1025	0337  8A 56 FA			     mov     dl,byte ptr [bp-6]
   1026	033A  80 E2 0F			     and     dl,15
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 19
scall.ASM



   1027	033D  02 C2			     add     al,dl
   1028	033F  C4 5E FC			     les     bx,dword ptr [bp-4]
   1029	0342  26: 88 47	01		     mov     byte ptr es:[bx+1],al
   1030					;
   1031					;      tm->ti_min  = 10*((m & 0xf0)>>4)	+ (m & 0x0f);
   1032					;
   1033	0346  8B 46 F8			     mov     ax,word ptr [bp-8]
   1034	0349  25 00F0			     and     ax,240
   1035	034C  B1 04			     mov     cl,4
   1036	034E  D3 E8			     shr     ax,cl
   1037	0350  BA 000A			     mov     dx,10
   1038	0353  F7 EA			     imul    dx
   1039	0355  8A 56 F8			     mov     dl,byte ptr [bp-8]
   1040	0358  80 E2 0F			     and     dl,15
   1041	035B  02 C2			     add     al,dl
   1042	035D  C4 5E FC			     les     bx,dword ptr [bp-4]
   1043	0360  26: 88 07			     mov     byte ptr es:[bx],al
   1044					;
   1045					;      tm->ti_sec  = 10*((s & 0xf0)>>4)	+ (s & 0x0f);
   1046					;
   1047	0363  8B 46 F6			     mov     ax,word ptr [bp-10]
   1048	0366  25 00F0			     and     ax,240
   1049	0369  B1 04			     mov     cl,4
   1050	036B  D3 E8			     shr     ax,cl
   1051	036D  BA 000A			     mov     dx,10
   1052	0370  F7 EA			     imul    dx
   1053	0372  8A 56 F6			     mov     dl,byte ptr [bp-10]
   1054	0375  80 E2 0F			     and     dl,15
   1055	0378  02 C2			     add     al,dl
   1056	037A  C4 5E FC			     les     bx,dword ptr [bp-4]
   1057	037D  26: 88 47	03		     mov     byte ptr es:[bx+3],al
   1058					;
   1059					;      tm->ti_hund = 0;
   1060					;
   1061	0381  C4 5E FC			     les     bx,dword ptr [bp-4]
   1062	0384  26: C6 47	02 00		     mov     byte ptr es:[bx+2],0
   1063					;
   1064					;      return 0;
   1065					;
   1066	0389  33 C0			     xor     ax,ax
   1067	038B  EB 00			     jmp     short @14@114
   1068	038D			     @14@114:
   1069					;
   1070					;    }
   1071					;
   1072	038D  8B E5			     mov     sp,bp
   1073	038F  5D			     pop     bp
   1074	0390  C3			     ret
   1075	0391			     _sc_gettime     endp
   1076					;
   1077					;    void miniSO_contextswitch ()
   1078					;
   1079					     assume  cs:_TEXT
   1080	0391			     _miniSO_contextswitch   proc    near
   1081	0391  55			     push    bp
   1082	0392  8B EC			     mov     bp,sp
   1083					;
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 20
scall.ASM



   1084					;    {
   1085					;      if ( miniSO_nextthread == miniSO_NONE )
   1086					;
   1087	0394  83 3E 0004r FF		     cmp     word ptr DGROUP:_miniSO_nextthread,-1
   1088	0399  75 11			     jne     short @15@86
   1089					;
   1090					;	  miniSO_nextthread=miniSO_thread[miniSO_ready].next;
   1091					;
   1092	039B  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1093	039E  BA 001A			     mov     dx,26
   1094	03A1  F7 EA			     imul    dx
   1095	03A3  8B D8			     mov     bx,ax
   1096	03A5  8B 87 001Fr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+24]
   1097	03A9  A3 0004r			     mov     word ptr DGROUP:_miniSO_nextthread,ax
   1098	03AC			     @15@86:
   1099					;
   1100					;      /* Se houve alteracao de	thread corrente	... */
   1101					;      if (miniSO_nextthread!=miniSO_ready)  {
   1102					;
   1103	03AC  A1 0004r			     mov     ax,word ptr DGROUP:_miniSO_nextthread
   1104	03AF  3B 06 0007r		     cmp     ax,word ptr DGROUP:_miniSO_ready
   1105	03B3  75 03			     jne     @@1
   1106	03B5  EB 7E 90			     jmp     @15@254
   1107	03B8			     @@1:
   1108					;
   1109					;	  if (miniSO_delcurthread)	    /* Se a thread corrente foi	excluida ... */
   1110					;
   1111	03B8  80 3E 0006r 00		     cmp     byte ptr DGROUP:_miniSO_delcurthread,0
   1112	03BD  74 07			     je	     short @15@170
   1113					;
   1114					;	     miniSO_delcurthread=0;	   /* zera o flag para deletado	e nao captura SS:SP +
   1115				     */
   1116					;
   1117	03BF  C6 06 0006r 00		     mov     byte ptr DGROUP:_miniSO_delcurthread,0
   1118	03C4  EB 3D			     jmp     short @15@226
   1119	03C6			     @15@170:
   1120					;
   1121					;	  else	{
   1122					;	     /*	Salva SS:SP da thread corrente no BCP */
   1123					;	     miniSO_thread[miniSO_ready].ss=_SS;
   1124					;
   1125	03C6  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1126	03C9  BA 001A			     mov     dx,26
   1127	03CC  F7 EA			     imul    dx
   1128	03CE  8B D8			     mov     bx,ax
   1129	03D0  8C 97 000Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+6],ss
   1130					;
   1131					;	     miniSO_thread[miniSO_ready].sp=_SP;
   1132					;
   1133	03D4  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1134	03D7  BA 001A			     mov     dx,26
   1135	03DA  F7 EA			     imul    dx
   1136	03DC  8B D8			     mov     bx,ax
   1137	03DE  89 A7 000Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+8],sp
   1138					;
   1139					;	     if	(miniSO_thread[miniSO_ready].status==RUNNING)
   1140					;
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 21
scall.ASM



   1141	03E2  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1142	03E5  BA 001A			     mov     dx,26
   1143	03E8  F7 EA			     imul    dx
   1144	03EA  8B D8			     mov     bx,ax
   1145	03EC  83 BF 000Br 01		     cmp     word ptr DGROUP:_miniSO_thread[bx+4],1
   1146	03F1  75 10			     jne     short @15@226
   1147					;
   1148					;		miniSO_thread[miniSO_ready].status=READY;
   1149					;
   1150	03F3  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1151	03F6  BA 001A			     mov     dx,26
   1152	03F9  F7 EA			     imul    dx
   1153	03FB  8B D8			     mov     bx,ax
   1154	03FD  C7 87 000Br 0000		     mov     word ptr DGROUP:_miniSO_thread[bx+4],0
   1155	0403			     @15@226:
   1156					;
   1157					;	  }
   1158					;	  /* Atualiza thread corrente */
   1159					;	  miniSO_ready=miniSO_nextthread;
   1160					;
   1161	0403  A1 0004r			     mov     ax,word ptr DGROUP:_miniSO_nextthread
   1162	0406  A3 0007r			     mov     word ptr DGROUP:_miniSO_ready,ax
   1163					;
   1164					;	  miniSO_thread[miniSO_ready].status=RUNNING;
   1165					;
   1166	0409  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1167	040C  BA 001A			     mov     dx,26
   1168	040F  F7 EA			     imul    dx
   1169	0411  8B D8			     mov     bx,ax
   1170	0413  C7 87 000Br 0001		     mov     word ptr DGROUP:_miniSO_thread[bx+4],1
   1171					;
   1172					;	  /* Define SS:SP para a thread	corrente */
   1173					;	  _SS=miniSO_thread[miniSO_ready].ss;
   1174					;
   1175	0419  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1176	041C  BA 001A			     mov     dx,26
   1177	041F  F7 EA			     imul    dx
   1178	0421  8B D8			     mov     bx,ax
   1179	0423  8E 97 000Dr		     mov     ss,word ptr DGROUP:_miniSO_thread[bx+6]
   1180					;
   1181					;	  _SP=miniSO_thread[miniSO_ready].sp;
   1182					;
   1183	0427  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1184	042A  BA 001A			     mov     dx,26
   1185	042D  F7 EA			     imul    dx
   1186	042F  8B D8			     mov     bx,ax
   1187	0431  8B A7 000Fr		     mov     sp,word ptr DGROUP:_miniSO_thread[bx+8]
   1188	0435			     @15@254:
   1189					;
   1190					;
   1191					;      }
   1192					;      miniSO_nextthread = miniSO_NONE;
   1193					;
   1194	0435  C7 06 0004r FFFF		     mov     word ptr DGROUP:_miniSO_nextthread,-1
   1195					;
   1196					;    }
   1197					;
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 22
scall.ASM



   1198	043B  5D			     pop     bp
   1199	043C  C3			     ret
   1200	043D			     _miniSO_contextswitch   endp
   1201					;
   1202					;    static void end_mso(char *msg)
   1203					;
   1204					     assume  cs:_TEXT
   1205	043D			     end_mso proc    near
   1206	043D  55			     push    bp
   1207	043E  8B EC			     mov     bp,sp
   1208					;
   1209					;    {
   1210					;      /* Restaura a interrupção do relógio original */
   1211					;      setvect(miniSO_CLOCKINT,miniSO_oldisr);
   1212					;
   1213	0440  FF 36 0002r		     push    word ptr DGROUP:_miniSO_oldisr+2
   1214	0444  FF 36 0000r		     push    word ptr DGROUP:_miniSO_oldisr
   1215	0448  B8 001C			     mov     ax,28
   1216	044B  50			     push    ax
   1217	044C  E8 0000e			     call    near ptr _setvect
   1218	044F  83 C4 06			     add     sp,6
   1219					;
   1220					;      enable();
   1221					;
   1222	0452  E8 0000e			     call    near ptr _enable
   1223					;
   1224					;      putstr("\n\n");
   1225					;
   1226	0455  1E			     push    ds
   1227	0456  B8 0094r			     mov     ax,offset DGROUP:s@
   1228	0459  50			     push    ax
   1229	045A  E8 0000e			     call    near ptr _putstr
   1230	045D  59			     pop     cx
   1231	045E  59			     pop     cx
   1232					;
   1233					;      putstr(msg);
   1234					;
   1235	045F  1E			     push    ds
   1236	0460  FF 76 04			     push    word ptr [bp+4]
   1237	0463  E8 0000e			     call    near ptr _putstr
   1238	0466  59			     pop     cx
   1239	0467  59			     pop     cx
   1240					;
   1241					;      putch('\n');
   1242					;
   1243	0468  B8 000A			     mov     ax,10
   1244	046B  50			     push    ax
   1245	046C  E8 0000e			     call    near ptr _putch
   1246	046F  59			     pop     cx
   1247					;
   1248					;      putstr("Pressione uma tecla para	reiniciar...\n");
   1249					;
   1250	0470  1E			     push    ds
   1251	0471  B8 0097r			     mov     ax,offset DGROUP:s@+3
   1252	0474  50			     push    ax
   1253	0475  E8 0000e			     call    near ptr _putstr
   1254	0478  59			     pop     cx
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 23
scall.ASM



   1255	0479  59			     pop     cx
   1256					;
   1257					;      getch();
   1258					;
   1259	047A  E8 0000e			     call    near ptr _getch
   1260					;
   1261					;      /* Reinicializa a máquina */
   1262					;      sc_reboot();
   1263					;
   1264	047D  E8 0138			     call    near ptr _sc_reboot
   1265					;
   1266					;    }
   1267					;
   1268	0480  5D			     pop     bp
   1269	0481  C3			     ret
   1270	0482			     end_mso endp
   1271					;
   1272					;    static pcb_t get_pcb(pid_t	pid)
   1273					;
   1274					     assume  cs:_TEXT
   1275	0482			     get_pcb proc    near
   1276	0482  55			     push    bp
   1277	0483  8B EC			     mov     bp,sp
   1278					;
   1279					;    {
   1280					;	     pcb_t   pcb;
   1281					;
   1282					;	     for     (pcb=0;pcb<miniSO_MAXTHREADS;++pcb)  {
   1283					;
   1284	0485  33 C9			     xor     cx,cx
   1285	0487  EB 27			     jmp     short @17@198
   1286	0489			     @17@58:
   1287					;
   1288					;		     if	     ( miniSO_thread[pcb].status!=FREE && miniSO_thread		    +
   1289				     [pcb].pid==pid )
   1290					;
   1291	0489  8B C1			     mov     ax,cx
   1292	048B  BA 001A			     mov     dx,26
   1293	048E  F7 EA			     imul    dx
   1294	0490  8B D8			     mov     bx,ax
   1295	0492  83 BF 000Br FF		     cmp     word ptr DGROUP:_miniSO_thread[bx+4],-1
   1296	0497  74 16			     je	     short @17@170
   1297	0499  8B C1			     mov     ax,cx
   1298	049B  BA 001A			     mov     dx,26
   1299	049E  F7 EA			     imul    dx
   1300	04A0  8B D8			     mov     bx,ax
   1301	04A2  8B 87 0007r		     mov     ax,word ptr DGROUP:_miniSO_thread[bx]
   1302	04A6  3B 46 04			     cmp     ax,word ptr [bp+4]
   1303	04A9  75 04			     jne     short @17@170
   1304					;
   1305					;			     return pcb;
   1306					;
   1307	04AB  8B C1			     mov     ax,cx
   1308	04AD			     @17@142:
   1309	04AD  EB 0B			     jmp     short @17@254
   1310	04AF			     @17@170:
   1311	04AF  41			     inc     cx
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 24
scall.ASM



   1312	04B0			     @17@198:
   1313	04B0  83 F9 10			     cmp     cx,16
   1314	04B3  7C D4			     jl	     short @17@58
   1315					;
   1316					;	     }
   1317					;	     return -1;
   1318					;
   1319	04B5  B8 FFFF			     mov     ax,-1
   1320	04B8  EB F3			     jmp     short @17@142
   1321	04BA			     @17@254:
   1322					;
   1323					;    }
   1324					;
   1325	04BA  5D			     pop     bp
   1326	04BB  C3			     ret
   1327	04BC			     get_pcb endp
   1328					;
   1329					;    void miniSO_init_semtable()
   1330					;
   1331					     assume  cs:_TEXT
   1332	04BC			     _miniSO_init_semtable   proc    near
   1333	04BC  55			     push    bp
   1334	04BD  8B EC			     mov     bp,sp
   1335					;
   1336					;    {
   1337					;	     int i;
   1338					;
   1339					;	     for     (i=0;i<miniSO_MAXSEMAPHORES;++i)
   1340					;
   1341	04BF  33 C0			     xor     ax,ax
   1342	04C1  EB 0D			     jmp     short @18@114
   1343	04C3			     @18@58:
   1344					;
   1345					;		     miniSO_sem[i].status = FREE;
   1346					;
   1347	04C3  8B D8			     mov     bx,ax
   1348	04C5  B1 03			     mov     cl,3
   1349	04C7  D3 E3			     shl     bx,cl
   1350	04C9  C7 87 01A7r FFFF		     mov     word ptr DGROUP:_miniSO_sem[bx],-1
   1351	04CF  40			     inc     ax
   1352	04D0			     @18@114:
   1353	04D0  3D 000A			     cmp     ax,10
   1354	04D3  7C EE			     jl	     short @18@58
   1355					;
   1356					;    }
   1357					;
   1358	04D5  5D			     pop     bp
   1359	04D6  C3			     ret
   1360	04D7			     _miniSO_init_semtable   endp
   1361					;
   1362					;    void miniSO_init_proctable()
   1363					;
   1364					     assume  cs:_TEXT
   1365	04D7			     _miniSO_init_proctable  proc    near
   1366	04D7  55			     push    bp
   1367	04D8  8B EC			     mov     bp,sp
   1368	04DA  56			     push    si
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 25
scall.ASM



   1369					;
   1370					;    {
   1371					;      pcb_t i;
   1372					;
   1373					;      disable();
   1374					;
   1375	04DB  E8 0000e			     call    near ptr _disable
   1376					;
   1377					;
   1378					;      /* Inicializa a tabela de semaforos */
   1379					;      miniSO_init_semtable();
   1380					;
   1381	04DE  E8 FFDB			     call    near ptr _miniSO_init_semtable
   1382					;
   1383					;      /* Inicializa tabela de threads */
   1384					;      miniSO_ready =  0;
   1385					;
   1386	04E1  C7 06 0007r 0000		     mov     word ptr DGROUP:_miniSO_ready,0
   1387					;
   1388					;      miniSO_thread[miniSO_ready].pid	    = 0;
   1389					;
   1390	04E7  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1391	04EA  BA 001A			     mov     dx,26
   1392	04ED  F7 EA			     imul    dx
   1393	04EF  8B D8			     mov     bx,ax
   1394	04F1  C7 87 0007r 0000		     mov     word ptr DGROUP:_miniSO_thread[bx],0
   1395					;
   1396					;      miniSO_thread[miniSO_ready].ppid	    = -1;
   1397					;
   1398	04F7  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1399	04FA  BA 001A			     mov     dx,26
   1400	04FD  F7 EA			     imul    dx
   1401	04FF  8B D8			     mov     bx,ax
   1402	0501  C7 87 0009r FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+2],-1
   1403					;
   1404					;      miniSO_thread[miniSO_ready].next	    = miniSO_ready;
   1405					;
   1406	0507  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1407	050A  BA 001A			     mov     dx,26
   1408	050D  F7 EA			     imul    dx
   1409	050F  8B 16 0007r		     mov     dx,word ptr DGROUP:_miniSO_ready
   1410	0513  8B D8			     mov     bx,ax
   1411	0515  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   1412					;
   1413					;      miniSO_thread[miniSO_ready].prev	    = miniSO_ready;
   1414					;
   1415	0519  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1416	051C  BA 001A			     mov     dx,26
   1417	051F  F7 EA			     imul    dx
   1418	0521  8B 16 0007r		     mov     dx,word ptr DGROUP:_miniSO_ready
   1419	0525  8B D8			     mov     bx,ax
   1420	0527  89 97 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],dx
   1421					;
   1422					;      miniSO_thread[miniSO_ready].status   = RUNNING;
   1423					;
   1424	052B  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1425	052E  BA 001A			     mov     dx,26
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 26
scall.ASM



   1426	0531  F7 EA			     imul    dx
   1427	0533  8B D8			     mov     bx,ax
   1428	0535  C7 87 000Br 0001		     mov     word ptr DGROUP:_miniSO_thread[bx+4],1
   1429					;
   1430					;      miniSO_thread[miniSO_ready].recvsig  = 0;
   1431					;
   1432	053B  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1433	053E  BA 001A			     mov     dx,26
   1434	0541  F7 EA			     imul    dx
   1435	0543  8B D8			     mov     bx,ax
   1436	0545  C7 87 0011r 0000		     mov     word ptr DGROUP:_miniSO_thread[bx+10],0
   1437					;
   1438					;      miniSO_thread[miniSO_ready].wait	    = -1;
   1439					;
   1440	054B  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1441	054E  BA 001A			     mov     dx,26
   1442	0551  F7 EA			     imul    dx
   1443	0553  8B D8			     mov     bx,ax
   1444	0555  C7 87 0015r FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+14],-1
   1445					;
   1446					;      miniSO_thread[miniSO_ready].zombies  = -1;
   1447					;
   1448	055B  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1449	055E  BA 001A			     mov     dx,26
   1450	0561  F7 EA			     imul    dx
   1451	0563  8B D8			     mov     bx,ax
   1452	0565  C7 87 001Br FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+20],-1
   1453					;
   1454					;      /* O resto dos BCPs permanece na	lista de livres	*/
   1455					;      miniSO_free  =  1;
   1456					;
   1457	056B  C7 06 0009r 0001		     mov     word ptr DGROUP:_miniSO_free,1
   1458					;
   1459					;      for ( i=1 ; i<miniSO_MAXTHREADS-1 ; ++i)	 {
   1460					;
   1461	0571  BE 0001			     mov     si,1
   1462	0574  EB 20			     jmp     short @19@114
   1463	0576			     @19@58:
   1464					;
   1465					;	   miniSO_thread[i].next   = i+1;
   1466					;
   1467	0576  8B C6			     mov     ax,si
   1468	0578  BA 001A			     mov     dx,26
   1469	057B  F7 EA			     imul    dx
   1470	057D  8B D6			     mov     dx,si
   1471	057F  42			     inc     dx
   1472	0580  8B D8			     mov     bx,ax
   1473	0582  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   1474					;
   1475					;	   miniSO_thread[i].status = FREE;
   1476					;
   1477	0586  8B C6			     mov     ax,si
   1478	0588  BA 001A			     mov     dx,26
   1479	058B  F7 EA			     imul    dx
   1480	058D  8B D8			     mov     bx,ax
   1481	058F  C7 87 000Br FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+4],-1
   1482	0595  46			     inc     si
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 27
scall.ASM



   1483	0596			     @19@114:
   1484	0596  83 FE 0F			     cmp     si,15
   1485	0599  7C DB			     jl	     short @19@58
   1486					;
   1487					;      }
   1488					;      miniSO_thread[miniSO_MAXTHREADS-1].next	 = -1;
   1489					;
   1490	059B  C7 06 01A5r FFFF		     mov     word ptr DGROUP:_miniSO_thread+414,-1
   1491					;
   1492					;      miniSO_thread[miniSO_MAXTHREADS-1].status = FREE;
   1493					;
   1494	05A1  C7 06 0191r FFFF		     mov     word ptr DGROUP:_miniSO_thread+394,-1
   1495					;
   1496					;      /* Zera tempos do sistema */
   1497					;      miniSO_delcurthread  = 0;
   1498					;
   1499	05A7  C6 06 0006r 00		     mov     byte ptr DGROUP:_miniSO_delcurthread,0
   1500					;
   1501					;      miniSO_nextthread = miniSO_NONE;
   1502					;
   1503	05AC  C7 06 0004r FFFF		     mov     word ptr DGROUP:_miniSO_nextthread,-1
   1504					;
   1505					;      /* Habilita as interrupcoes e retorna */
   1506					;      enable();
   1507					;
   1508	05B2  E8 0000e			     call    near ptr _enable
   1509					;
   1510					;    }
   1511					;
   1512	05B5  5E			     pop     si
   1513	05B6  5D			     pop     bp
   1514	05B7  C3			     ret
   1515	05B8			     _miniSO_init_proctable  endp
   1516					;
   1517					;    int sc_reboot()
   1518					;
   1519					     assume  cs:_TEXT
   1520	05B8			     _sc_reboot	     proc    near
   1521	05B8  55			     push    bp
   1522	05B9  8B EC			     mov     bp,sp
   1523					;
   1524					;    {
   1525					;	     /*	Restaura a interrupção do relógio original */
   1526					;	     setvect(miniSO_CLOCKINT,miniSO_oldisr);
   1527					;
   1528	05BB  FF 36 0002r		     push    word ptr DGROUP:_miniSO_oldisr+2
   1529	05BF  FF 36 0000r		     push    word ptr DGROUP:_miniSO_oldisr
   1530	05C3  B8 001C			     mov     ax,28
   1531	05C6  50			     push    ax
   1532	05C7  E8 0000e			     call    near ptr _setvect
   1533	05CA  83 C4 06			     add     sp,6
   1534					;
   1535					;	     enable();
   1536					;
   1537	05CD  E8 0000e			     call    near ptr _enable
   1538					;
   1539					;	     asm     {
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 28
scall.ASM



   1540					;		     int     19h
   1541					;
   1542	05D0  CD 19			     int	     19h
   1543					;
   1544					;	     }
   1545					;	     return 0;
   1546					;
   1547	05D2  33 C0			     xor     ax,ax
   1548	05D4  EB 00			     jmp     short @20@114
   1549	05D6			     @20@114:
   1550					;
   1551					;    }
   1552					;
   1553	05D6  5D			     pop     bp
   1554	05D7  C3			     ret
   1555	05D8			     _sc_reboot	     endp
   1556	05D8			     _TEXT   ends
   1557	0092			     _DATA   segment word public 'DATA'
   1558	0092  01			     db	     1
   1559	0093  00			     db	     0
   1560	0094			     _DATA   ends
   1561	05D8			     _TEXT   segment byte public 'CODE'
   1562					;
   1563					;    int sc_fork(unsigned cs, unsigned ip)
   1564					;
   1565					     assume  cs:_TEXT
   1566	05D8			     _sc_fork	     proc    near
   1567	05D8  55			     push    bp
   1568	05D9  8B EC			     mov     bp,sp
   1569	05DB  83 EC 06			     sub     sp,6
   1570	05DE  56			     push    si
   1571	05DF  57			     push    di
   1572					;
   1573					;    {
   1574					;	     pid_t	     pid;
   1575					;	     pcb_t	     pcb,last;
   1576					;	     unsigned far *  stack;
   1577					;	     static pid_t    nextpid=1;	/* Número do próximo pid */
   1578					;	     extern void     miniSO_return_addr(void);
   1579					;
   1580					;	     /*	Se o nucleo esta' instalado e existem BCPs livres insere no fim	da lista ...+
   1581				     */
   1582					;	     if	     (miniSO_free == -1)
   1583					;
   1584	05E0  83 3E 0009r FF		     cmp     word ptr DGROUP:_miniSO_free,-1
   1585	05E5  75 06			     jne     short @21@114
   1586					;
   1587					;		     return miniSO_ERROR;
   1588					;
   1589	05E7  B8 FFFF			     mov     ax,-1
   1590	05EA			     @21@86:
   1591	05EA  E9 0232			     jmp     @21@338
   1592	05ED			     @21@114:
   1593					;
   1594					;	     disable();
   1595					;
   1596	05ED  E8 0000e			     call    near ptr _disable
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 29
scall.ASM



   1597					;
   1598					;	     /*	Gera um	pid para a thread */
   1599					;	     pcb = 0;
   1600					;
   1601	05F0  33 F6			     xor     si,si
   1602	05F2  EB 27			     jmp     short @21@282
   1603	05F4			     @21@142:
   1604					;
   1605					;	     while   (pcb!=-1)	{
   1606					;		     pcb = get_pcb (nextpid);
   1607					;
   1608	05F4  FF 36 0092r		     push    word ptr DGROUP:d@w+146
   1609	05F8  E8 FE87			     call    near ptr get_pcb
   1610	05FB  59			     pop     cx
   1611	05FC  8B F0			     mov     si,ax
   1612					;
   1613					;		     if	     (pcb==-1)
   1614					;
   1615	05FE  83 FE FF			     cmp     si,-1
   1616	0601  75 04			     jne     short @21@198
   1617					;
   1618					;			     pid = nextpid;
   1619					;
   1620	0603  8B 3E 0092r		     mov     di,word ptr DGROUP:d@w+146
   1621	0607			     @21@198:
   1622					;
   1623					;		     if	     (nextpid==32767)
   1624					;
   1625	0607  81 3E 0092r 7FFF		     cmp     word ptr DGROUP:d@w+146,32767
   1626	060D  75 08			     jne     short @21@254
   1627					;
   1628					;			     nextpid=1;
   1629					;
   1630	060F  C7 06 0092r 0001		     mov     word ptr DGROUP:d@w+146,1
   1631	0615  EB 04			     jmp     short @21@282
   1632	0617			     @21@254:
   1633					;
   1634					;		     else
   1635					;			     nextpid++;
   1636					;
   1637	0617  FF 06 0092r		     inc     word ptr DGROUP:d@w+146
   1638	061B			     @21@282:
   1639	061B  83 FE FF			     cmp     si,-1
   1640	061E  75 D4			     jne     short @21@142
   1641					;
   1642					;	     }
   1643					;	     /*	Retira um BCP da lista de BCPs livres */
   1644					;	     pcb     = miniSO_free;
   1645					;
   1646	0620  8B 36 0009r		     mov     si,word ptr DGROUP:_miniSO_free
   1647					;
   1648					;	     miniSO_free = miniSO_thread[miniSO_free].next;
   1649					;
   1650	0624  A1 0009r			     mov     ax,word ptr DGROUP:_miniSO_free
   1651	0627  BA 001A			     mov     dx,26
   1652	062A  F7 EA			     imul    dx
   1653	062C  8B D8			     mov     bx,ax
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 30
scall.ASM



   1654	062E  8B 87 001Fr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+24]
   1655	0632  A3 0009r			     mov     word ptr DGROUP:_miniSO_free,ax
   1656					;
   1657					;	     miniSO_thread[pcb].pid = pid;
   1658					;
   1659	0635  8B C6			     mov     ax,si
   1660	0637  BA 001A			     mov     dx,26
   1661	063A  F7 EA			     imul    dx
   1662	063C  8B D8			     mov     bx,ax
   1663	063E  89 BF 0007r		     mov     word ptr DGROUP:_miniSO_thread[bx],di
   1664					;
   1665					;	     miniSO_thread[pcb].ppid = miniSO_thread[miniSO_ready].pid;
   1666					;
   1667	0642  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1668	0645  BA 001A			     mov     dx,26
   1669	0648  F7 EA			     imul    dx
   1670	064A  8B D8			     mov     bx,ax
   1671	064C  8B 87 0007r		     mov     ax,word ptr DGROUP:_miniSO_thread[bx]
   1672	0650  50			     push    ax
   1673	0651  8B C6			     mov     ax,si
   1674	0653  BA 001A			     mov     dx,26
   1675	0656  F7 EA			     imul    dx
   1676	0658  8B D8			     mov     bx,ax
   1677	065A  58			     pop     ax
   1678	065B  89 87 0009r		     mov     word ptr DGROUP:_miniSO_thread[bx+2],ax
   1679					;
   1680					;	     /*	Cria pilha da thread */
   1681					;	     stack=(unsigned far *)MK_FP(miniSO_INITSTACKS+(miniSO_STACKSIZE>>4)*	    +
   1682				     (miniSO_MAXTHREADS-1-pcb),miniSO_STACKSIZE);
   1683					;
   1684	065F  B8 0600			     mov     ax,1536
   1685	0662  50			     push    ax
   1686	0663  B8 000F			     mov     ax,15
   1687	0666  2B C6			     sub     ax,si
   1688	0668  BA 0060			     mov     dx,96
   1689	066B  F7 EA			     imul    dx
   1690	066D  05 0D00			     add     ax,3328
   1691	0670  50			     push    ax
   1692	0671  E8 0000e			     call    near ptr _MK_FP
   1693	0674  59			     pop     cx
   1694	0675  59			     pop     cx
   1695	0676  89 56 FC			     mov     word ptr [bp-4],dx
   1696	0679  89 46 FA			     mov     word ptr [bp-6],ax
   1697					;
   1698					;	     /*	Empilha	o endereco da funcao sc_exit, de modo que se	*/
   1699					;	     /*	 a thread sair da funcao sem chamar sc_exit, a thread */
   1700					;	     /*	 seja automaticamente excluida */
   1701					;	     *(--stack)=0; /* Empilha código de	fim a ser enviado para sc_exit */
   1702					;
   1703	067C  83 6E FA 02		     sub     word ptr [bp-6],2
   1704	0680  C4 5E FA			     les     bx,dword ptr [bp-6]
   1705	0683  26: C7 07	0000		     mov     word ptr es:[bx],0
   1706					;
   1707					;	     *(--stack)=miniSO_CODESEGMENT;
   1708					;
   1709	0688  83 6E FA 02		     sub     word ptr [bp-6],2
   1710	068C  C4 5E FA			     les     bx,dword ptr [bp-6]
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 31
scall.ASM



   1711	068F  26: C7 07	07E0		     mov     word ptr es:[bx],2016
   1712					;
   1713					;	     *(--stack)=(unsigned)sc_exit;
   1714					;
   1715	0694  83 6E FA 02		     sub     word ptr [bp-6],2
   1716	0698  C4 5E FA			     les     bx,dword ptr [bp-6]
   1717	069B  26: C7 07	0E56r		     mov     word ptr es:[bx],offset _sc_exit
   1718					;
   1719					;	     *(--stack)=0x0200 ;       /* FLAGS	*/
   1720					;
   1721	06A0  83 6E FA 02		     sub     word ptr [bp-6],2
   1722	06A4  C4 5E FA			     les     bx,dword ptr [bp-6]
   1723	06A7  26: C7 07	0200		     mov     word ptr es:[bx],512
   1724					;
   1725					;	     *(--stack)=cs;	       /* CS */
   1726					;
   1727	06AC  83 6E FA 02		     sub     word ptr [bp-6],2
   1728	06B0  C4 5E FA			     les     bx,dword ptr [bp-6]
   1729	06B3  8B 46 04			     mov     ax,word ptr [bp+4]
   1730	06B6  26: 89 07			     mov     word ptr es:[bx],ax
   1731					;
   1732					;	     *(--stack)=ip;	       /* IP */
   1733					;
   1734	06B9  83 6E FA 02		     sub     word ptr [bp-6],2
   1735	06BD  C4 5E FA			     les     bx,dword ptr [bp-6]
   1736	06C0  8B 46 06			     mov     ax,word ptr [bp+6]
   1737	06C3  26: 89 07			     mov     word ptr es:[bx],ax
   1738					;
   1739					;	     *(--stack)=0;	       /* AX */
   1740					;
   1741	06C6  83 6E FA 02		     sub     word ptr [bp-6],2
   1742	06CA  C4 5E FA			     les     bx,dword ptr [bp-6]
   1743	06CD  26: C7 07	0000		     mov     word ptr es:[bx],0
   1744					;
   1745					;	     *(--stack)=0;	       /* BX */
   1746					;
   1747	06D2  83 6E FA 02		     sub     word ptr [bp-6],2
   1748	06D6  C4 5E FA			     les     bx,dword ptr [bp-6]
   1749	06D9  26: C7 07	0000		     mov     word ptr es:[bx],0
   1750					;
   1751					;	     *(--stack)=0;	       /* CX */
   1752					;
   1753	06DE  83 6E FA 02		     sub     word ptr [bp-6],2
   1754	06E2  C4 5E FA			     les     bx,dword ptr [bp-6]
   1755	06E5  26: C7 07	0000		     mov     word ptr es:[bx],0
   1756					;
   1757					;	     *(--stack)=0;	       /* DX */
   1758					;
   1759	06EA  83 6E FA 02		     sub     word ptr [bp-6],2
   1760	06EE  C4 5E FA			     les     bx,dword ptr [bp-6]
   1761	06F1  26: C7 07	0000		     mov     word ptr es:[bx],0
   1762					;
   1763					;	     *(--stack)=0;	       /* ES */
   1764					;
   1765	06F6  83 6E FA 02		     sub     word ptr [bp-6],2
   1766	06FA  C4 5E FA			     les     bx,dword ptr [bp-6]
   1767	06FD  26: C7 07	0000		     mov     word ptr es:[bx],0
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 32
scall.ASM



   1768					;
   1769					;	     *(--stack)=miniSO_DATASEGMENT;/* DS */
   1770					;
   1771	0702  83 6E FA 02		     sub     word ptr [bp-6],2
   1772	0706  C4 5E FA			     les     bx,dword ptr [bp-6]
   1773	0709  26: C7 07	0B64		     mov     word ptr es:[bx],2916
   1774					;
   1775					;	     *(--stack)=0;	       /* SI */
   1776					;
   1777	070E  83 6E FA 02		     sub     word ptr [bp-6],2
   1778	0712  C4 5E FA			     les     bx,dword ptr [bp-6]
   1779	0715  26: C7 07	0000		     mov     word ptr es:[bx],0
   1780					;
   1781					;	     *(--stack)=0;	       /* DI */
   1782					;
   1783	071A  83 6E FA 02		     sub     word ptr [bp-6],2
   1784	071E  C4 5E FA			     les     bx,dword ptr [bp-6]
   1785	0721  26: C7 07	0000		     mov     word ptr es:[bx],0
   1786					;
   1787					;	     *(--stack)=0;	       /* BP */
   1788					;
   1789	0726  83 6E FA 02		     sub     word ptr [bp-6],2
   1790	072A  C4 5E FA			     les     bx,dword ptr [bp-6]
   1791	072D  26: C7 07	0000		     mov     word ptr es:[bx],0
   1792					;
   1793					;	     *(--stack)=(unsigned)miniSO_return_addr;
   1794					;
   1795	0732  83 6E FA 02		     sub     word ptr [bp-6],2
   1796	0736  C4 5E FA			     les     bx,dword ptr [bp-6]
   1797	0739  26: C7 07	0000e		     mov     word ptr es:[bx],offset _miniSO_return_addr
   1798					;
   1799					;	     *(--stack)=0;	       /* BP */
   1800					;
   1801	073E  83 6E FA 02		     sub     word ptr [bp-6],2
   1802	0742  C4 5E FA			     les     bx,dword ptr [bp-6]
   1803	0745  26: C7 07	0000		     mov     word ptr es:[bx],0
   1804					;
   1805					;	     /*	Inicializa campos da nova thread */
   1806					;	     miniSO_thread[pcb].ss	 = FP_SEG(stack);
   1807					;
   1808	074A  FF 76 FC			     push    word ptr [bp-4]
   1809	074D  FF 76 FA			     push    word ptr [bp-6]
   1810	0750  E8 0000e			     call    near ptr _FP_SEG
   1811	0753  59			     pop     cx
   1812	0754  59			     pop     cx
   1813	0755  50			     push    ax
   1814	0756  8B C6			     mov     ax,si
   1815	0758  BA 001A			     mov     dx,26
   1816	075B  F7 EA			     imul    dx
   1817	075D  8B D8			     mov     bx,ax
   1818	075F  58			     pop     ax
   1819	0760  89 87 000Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+6],ax
   1820					;
   1821					;	     miniSO_thread[pcb].sp	 = FP_OFF(stack);
   1822					;
   1823	0764  FF 76 FC			     push    word ptr [bp-4]
   1824	0767  FF 76 FA			     push    word ptr [bp-6]
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 33
scall.ASM



   1825	076A  E8 0000e			     call    near ptr _FP_OFF
   1826	076D  59			     pop     cx
   1827	076E  59			     pop     cx
   1828	076F  50			     push    ax
   1829	0770  8B C6			     mov     ax,si
   1830	0772  BA 001A			     mov     dx,26
   1831	0775  F7 EA			     imul    dx
   1832	0777  8B D8			     mov     bx,ax
   1833	0779  58			     pop     ax
   1834	077A  89 87 000Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+8],ax
   1835					;
   1836					;	     miniSO_thread[pcb].status	 = READY;
   1837					;
   1838	077E  8B C6			     mov     ax,si
   1839	0780  BA 001A			     mov     dx,26
   1840	0783  F7 EA			     imul    dx
   1841	0785  8B D8			     mov     bx,ax
   1842	0787  C7 87 000Br 0000		     mov     word ptr DGROUP:_miniSO_thread[bx+4],0
   1843					;
   1844					;	     miniSO_thread[pcb].recvsig	 = 0;
   1845					;
   1846	078D  8B C6			     mov     ax,si
   1847	078F  BA 001A			     mov     dx,26
   1848	0792  F7 EA			     imul    dx
   1849	0794  8B D8			     mov     bx,ax
   1850	0796  C7 87 0011r 0000		     mov     word ptr DGROUP:_miniSO_thread[bx+10],0
   1851					;
   1852					;	     miniSO_thread[pcb].waitsig	 = 0;
   1853					;
   1854	079C  8B C6			     mov     ax,si
   1855	079E  BA 001A			     mov     dx,26
   1856	07A1  F7 EA			     imul    dx
   1857	07A3  8B D8			     mov     bx,ax
   1858	07A5  C7 87 0013r 0000		     mov     word ptr DGROUP:_miniSO_thread[bx+12],0
   1859					;
   1860					;	     miniSO_thread[pcb].wait	 = -1;
   1861					;
   1862	07AB  8B C6			     mov     ax,si
   1863	07AD  BA 001A			     mov     dx,26
   1864	07B0  F7 EA			     imul    dx
   1865	07B2  8B D8			     mov     bx,ax
   1866	07B4  C7 87 0015r FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+14],-1
   1867					;
   1868					;	     miniSO_thread[pcb].zombies	 = -1;
   1869					;
   1870	07BA  8B C6			     mov     ax,si
   1871	07BC  BA 001A			     mov     dx,26
   1872	07BF  F7 EA			     imul    dx
   1873	07C1  8B D8			     mov     bx,ax
   1874	07C3  C7 87 001Br FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+20],-1
   1875					;
   1876					;	     /*	Descobre qual a	ultima thread */
   1877					;	     last = miniSO_thread[miniSO_ready].prev;
   1878					;
   1879	07C9  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1880	07CC  BA 001A			     mov     dx,26
   1881	07CF  F7 EA			     imul    dx
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 34
scall.ASM



   1882	07D1  8B D8			     mov     bx,ax
   1883	07D3  8B 87 001Dr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+22]
   1884	07D7  89 46 FE			     mov     word ptr [bp-2],ax
   1885					;
   1886					;	     /*	Acerta links para incluir a nova thread	*/
   1887					;	     miniSO_thread[pcb].prev	  = last;
   1888					;
   1889	07DA  8B C6			     mov     ax,si
   1890	07DC  BA 001A			     mov     dx,26
   1891	07DF  F7 EA			     imul    dx
   1892	07E1  8B 56 FE			     mov     dx,word ptr [bp-2]
   1893	07E4  8B D8			     mov     bx,ax
   1894	07E6  89 97 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],dx
   1895					;
   1896					;	     miniSO_thread[pcb].next	  = miniSO_ready;
   1897					;
   1898	07EA  8B C6			     mov     ax,si
   1899	07EC  BA 001A			     mov     dx,26
   1900	07EF  F7 EA			     imul    dx
   1901	07F1  8B 16 0007r		     mov     dx,word ptr DGROUP:_miniSO_ready
   1902	07F5  8B D8			     mov     bx,ax
   1903	07F7  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   1904					;
   1905					;	     miniSO_thread[last].next	  = pcb;
   1906					;
   1907	07FB  8B 46 FE			     mov     ax,word ptr [bp-2]
   1908	07FE  BA 001A			     mov     dx,26
   1909	0801  F7 EA			     imul    dx
   1910	0803  8B D8			     mov     bx,ax
   1911	0805  89 B7 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],si
   1912					;
   1913					;	     miniSO_thread[miniSO_ready].prev =	pcb;
   1914					;
   1915	0809  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1916	080C  BA 001A			     mov     dx,26
   1917	080F  F7 EA			     imul    dx
   1918	0811  8B D8			     mov     bx,ax
   1919	0813  89 B7 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],si
   1920					;
   1921					;	     enable();
   1922					;
   1923	0817  E8 0000e			     call    near ptr _enable
   1924					;
   1925					;	     return pid;
   1926					;
   1927	081A  8B C7			     mov     ax,di
   1928	081C  E9 FDCB			     jmp     @21@86
   1929	081F			     @21@338:
   1930					;
   1931					;    }
   1932					;
   1933	081F  5F			     pop     di
   1934	0820  5E			     pop     si
   1935	0821  8B E5			     mov     sp,bp
   1936	0823  5D			     pop     bp
   1937	0824  C3			     ret
   1938	0825			     _sc_fork	     endp
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 35
scall.ASM



   1939					;
   1940					;    int sc_kill(pid_t pid)
   1941					;
   1942					     assume  cs:_TEXT
   1943	0825			     _sc_kill	     proc    near
   1944	0825  55			     push    bp
   1945	0826  8B EC			     mov     bp,sp
   1946	0828  83 EC 08			     sub     sp,8
   1947	082B  56			     push    si
   1948	082C  57			     push    di
   1949					;
   1950					;    {
   1951					;	     pcb_t pcb,pcbw,last,prevthread,nextthread,pai,i,ant;
   1952					;
   1953					;	     disable();
   1954					;
   1955	082D  E8 0000e			     call    near ptr _disable
   1956					;
   1957					;	     /*	Se remover a thread 0 ... */
   1958					;	     if	     (pid==0)
   1959					;
   1960	0830  83 7E 04 00		     cmp     word ptr [bp+4],0
   1961	0834  75 08			     jne     short @22@86
   1962					;
   1963					;		     end_mso("kill(): thread 0 excluida!");
   1964					;
   1965	0836  B8 00BEr			     mov     ax,offset DGROUP:s@+42
   1966	0839  50			     push    ax
   1967	083A  E8 FC00			     call    near ptr end_mso
   1968	083D  59			     pop     cx
   1969	083E			     @22@86:
   1970					;
   1971					;	     /*	Tem que	verificar se existe a thread */
   1972					;	     pcb = get_pcb(pid);
   1973					;
   1974	083E  FF 76 04			     push    word ptr [bp+4]
   1975	0841  E8 FC3E			     call    near ptr get_pcb
   1976	0844  59			     pop     cx
   1977	0845  8B F0			     mov     si,ax
   1978					;
   1979					;	     /*	Se nao existe uma thread com este numero, entao	retorna	*/
   1980					;	     if	     (pcb==-1)	{
   1981					;
   1982	0847  83 FE FF			     cmp     si,-1
   1983	084A  75 09			     jne     short @22@170
   1984	084C			     @22@114:
   1985					;
   1986					;		     enable();
   1987					;
   1988	084C  E8 0000e			     call    near ptr _enable
   1989					;
   1990					;		     return miniSO_ERROR;
   1991					;
   1992	084F  B8 FFFF			     mov     ax,-1
   1993	0852			     @22@142:
   1994	0852  E9 02B8			     jmp     @22@1206
   1995	0855			     @22@170:
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 36
scall.ASM



   1996	0855  EB 40			     jmp     short @22@226
   1997	0857			     @22@198:
   1998					;
   1999					;	     }
   2000					;	     /*	Trata os zumbis	do processo, colocando-os na lista de livres */
   2001					;	     i = miniSO_thread[pcb].zombies;
   2002					;	     while   (i!= -1)  {
   2003					;		     miniSO_thread[pcb].zombies	= miniSO_thread[i].next;
   2004					;
   2005	0857  8B C7			     mov     ax,di
   2006	0859  BA 001A			     mov     dx,26
   2007	085C  F7 EA			     imul    dx
   2008	085E  8B D8			     mov     bx,ax
   2009	0860  8B 87 001Fr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+24]
   2010	0864  50			     push    ax
   2011	0865  8B C6			     mov     ax,si
   2012	0867  BA 001A			     mov     dx,26
   2013	086A  F7 EA			     imul    dx
   2014	086C  8B D8			     mov     bx,ax
   2015	086E  58			     pop     ax
   2016	086F  89 87 001Br		     mov     word ptr DGROUP:_miniSO_thread[bx+20],ax
   2017					;
   2018					;		     miniSO_thread[i].next   = miniSO_free;
   2019					;
   2020	0873  8B C7			     mov     ax,di
   2021	0875  BA 001A			     mov     dx,26
   2022	0878  F7 EA			     imul    dx
   2023	087A  8B 16 0009r		     mov     dx,word ptr DGROUP:_miniSO_free
   2024	087E  8B D8			     mov     bx,ax
   2025	0880  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   2026					;
   2027					;		     miniSO_free	     = i;
   2028					;
   2029	0884  89 3E 0009r		     mov     word ptr DGROUP:_miniSO_free,di
   2030					;
   2031					;		     miniSO_thread[i].status = FREE;
   2032					;
   2033	0888  8B C7			     mov     ax,di
   2034	088A  BA 001A			     mov     dx,26
   2035	088D  F7 EA			     imul    dx
   2036	088F  8B D8			     mov     bx,ax
   2037	0891  C7 87 000Br FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+4],-1
   2038					;
   2039					;		     i = miniSO_thread[pcb].zombies;
   2040					;
   2041	0897			     @22@226:
   2042	0897  8B C6			     mov     ax,si
   2043	0899  BA 001A			     mov     dx,26
   2044	089C  F7 EA			     imul    dx
   2045	089E  8B D8			     mov     bx,ax
   2046	08A0  8B BF 001Br		     mov     di,word ptr DGROUP:_miniSO_thread[bx+20]
   2047	08A4  83 FF FF			     cmp     di,-1
   2048	08A7  75 AE			     jne     short @22@198
   2049					;
   2050					;	     }
   2051					;	     /*	Passa os filhos	do processo para o avo */
   2052					;	     for     (i=0;i<miniSO_MAXTHREADS;++i)  {
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 37
scall.ASM



   2053					;
   2054	08A9  33 FF			     xor     di,di
   2055	08AB  EB 4B			     jmp     short @22@422
   2056	08AD			     @22@310:
   2057					;
   2058					;		     if	     (miniSO_thread[i].status!=FREE && miniSO_thread[i].ppid ==	    +
   2059				     miniSO_thread[pcb].pid)
   2060					;
   2061	08AD  8B C7			     mov     ax,di
   2062	08AF  BA 001A			     mov     dx,26
   2063	08B2  F7 EA			     imul    dx
   2064	08B4  8B D8			     mov     bx,ax
   2065	08B6  83 BF 000Br FF		     cmp     word ptr DGROUP:_miniSO_thread[bx+4],-1
   2066	08BB  74 3A			     je	     short @22@394
   2067	08BD  8B C7			     mov     ax,di
   2068	08BF  BA 001A			     mov     dx,26
   2069	08C2  F7 EA			     imul    dx
   2070	08C4  8B D8			     mov     bx,ax
   2071	08C6  8B 87 0009r		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+2]
   2072	08CA  50			     push    ax
   2073	08CB  8B C6			     mov     ax,si
   2074	08CD  BA 001A			     mov     dx,26
   2075	08D0  F7 EA			     imul    dx
   2076	08D2  8B D8			     mov     bx,ax
   2077	08D4  58			     pop     ax
   2078	08D5  3B 87 0007r		     cmp     ax,word ptr DGROUP:_miniSO_thread[bx]
   2079	08D9  75 1C			     jne     short @22@394
   2080					;
   2081					;			     miniSO_thread[i].ppid = miniSO_thread[pcb].ppid;
   2082					;
   2083	08DB  8B C6			     mov     ax,si
   2084	08DD  BA 001A			     mov     dx,26
   2085	08E0  F7 EA			     imul    dx
   2086	08E2  8B D8			     mov     bx,ax
   2087	08E4  8B 87 0009r		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+2]
   2088	08E8  50			     push    ax
   2089	08E9  8B C7			     mov     ax,di
   2090	08EB  BA 001A			     mov     dx,26
   2091	08EE  F7 EA			     imul    dx
   2092	08F0  8B D8			     mov     bx,ax
   2093	08F2  58			     pop     ax
   2094	08F3  89 87 0009r		     mov     word ptr DGROUP:_miniSO_thread[bx+2],ax
   2095	08F7			     @22@394:
   2096	08F7  47			     inc     di
   2097	08F8			     @22@422:
   2098	08F8  83 FF 10			     cmp     di,16
   2099	08FB  7C B0			     jl	     short @22@310
   2100					;
   2101					;	     }
   2102					;	     /*	Salva anterior e proximo da thread que sera deletada */
   2103					;	     prevthread	= miniSO_thread[pcb].prev;
   2104					;
   2105	08FD  8B C6			     mov     ax,si
   2106	08FF  BA 001A			     mov     dx,26
   2107	0902  F7 EA			     imul    dx
   2108	0904  8B D8			     mov     bx,ax
   2109	0906  8B 87 001Dr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+22]
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 38
scall.ASM



   2110	090A  89 46 FC			     mov     word ptr [bp-4],ax
   2111					;
   2112					;	     nextthread	= miniSO_thread[pcb].next;
   2113					;
   2114	090D  8B C6			     mov     ax,si
   2115	090F  BA 001A			     mov     dx,26
   2116	0912  F7 EA			     imul    dx
   2117	0914  8B D8			     mov     bx,ax
   2118	0916  8B 87 001Fr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+24]
   2119	091A  89 46 FA			     mov     word ptr [bp-6],ax
   2120					;
   2121					;	     /*	A thread pode estar em um de varios estados... */
   2122					;	     switch  (miniSO_thread[pcb].status)  {
   2123					;
   2124	091D  8B C6			     mov     ax,si
   2125	091F  BA 001A			     mov     dx,26
   2126	0922  F7 EA			     imul    dx
   2127	0924  8B D8			     mov     bx,ax
   2128	0926  8B 9F 000Br		     mov     bx,word ptr DGROUP:_miniSO_thread[bx+4]
   2129	092A  83 FB 06			     cmp     bx,6
   2130	092D  77 53			     ja	     short @22@758
   2131	092F  D1 E3			     shl     bx,1
   2132	0931  2E: FF A7	0B13r		     jmp     word ptr cs:@22@C1266[bx]
   2133	0936			     @22@562:
   2134					;
   2135					;		     case    READY:
   2136					;		     case    RUNNING:
   2137					;			     /*	Exclui o nodo da lista de prontos */
   2138					;			     miniSO_thread[prevthread].next=nextthread;
   2139					;
   2140	0936  8B 46 FC			     mov     ax,word ptr [bp-4]
   2141	0939  BA 001A			     mov     dx,26
   2142	093C  F7 EA			     imul    dx
   2143	093E  8B 56 FA			     mov     dx,word ptr [bp-6]
   2144	0941  8B D8			     mov     bx,ax
   2145	0943  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   2146					;
   2147					;			     miniSO_thread[nextthread].prev=prevthread;
   2148					;
   2149	0947  8B 46 FA			     mov     ax,word ptr [bp-6]
   2150	094A  BA 001A			     mov     dx,26
   2151	094D  F7 EA			     imul    dx
   2152	094F  8B 56 FC			     mov     dx,word ptr [bp-4]
   2153	0952  8B D8			     mov     bx,ax
   2154	0954  89 97 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],dx
   2155					;
   2156					;			     if	     (pcb==miniSO_ready)  {
   2157					;
   2158	0958  3B 36 0007r		     cmp     si,word ptr DGROUP:_miniSO_ready
   2159	095C  75 1E			     jne     short @22@674
   2160					;
   2161					;				     if	     (nextthread==miniSO_ready)
   2162					;
   2163	095E  8B 46 FA			     mov     ax,word ptr [bp-6]
   2164	0961  3B 06 0007r		     cmp     ax,word ptr DGROUP:_miniSO_ready
   2165	0965  75 0A			     jne     short @22@646
   2166					;
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 39
scall.ASM



   2167					;					     end_mso("kill(): nao ha' mais threads	    +
   2168				     executando!");
   2169					;
   2170	0967  B8 00D9r			     mov     ax,offset DGROUP:s@+69
   2171	096A  50			     push    ax
   2172	096B  E8 FACF			     call    near ptr end_mso
   2173	096E  59			     pop     cx
   2174	096F  EB 0B			     jmp     short @22@674
   2175	0971			     @22@646:
   2176					;
   2177					;				     else  {
   2178					;					     miniSO_nextthread=nextthread;
   2179					;
   2180	0971  8B 46 FA			     mov     ax,word ptr [bp-6]
   2181	0974  A3 0004r			     mov     word ptr DGROUP:_miniSO_nextthread,ax
   2182					;
   2183					;					     miniSO_delcurthread=1;
   2184					;
   2185	0977  C6 06 0006r 01		     mov     byte ptr DGROUP:_miniSO_delcurthread,1
   2186	097C			     @22@674:
   2187					;
   2188					;				     }
   2189					;			     }
   2190					;			     break;
   2191					;
   2192	097C  EB 07			     jmp     short @22@786
   2193	097E			     @22@702:
   2194					;
   2195					;		     case    WAITSEM:
   2196					;			     /*	Exclui o nodo da lista do semaforo */
   2197					;			     break;
   2198					;
   2199	097E  EB 05			     jmp     short @22@786
   2200	0980			     @22@730:
   2201					;
   2202					;		     case    WAIT:
   2203					;		     case    WAITSIG:
   2204					;		     case    STOPPED:
   2205					;			     break;
   2206					;
   2207	0980  EB 03			     jmp     short @22@786
   2208	0982			     @22@758:
   2209	0982  E9 FEC7			     jmp     @22@114
   2210	0985			     @22@786:
   2211					;
   2212					;		     case    ZOMBIE:
   2213					;		     default:
   2214					;			     enable();
   2215					;			     return miniSO_ERROR;
   2216					;	     }
   2217					;	     /*	Coloca o BCP da	thread na lista	de filhos zumbis do pai	*/
   2218					;	     pai = get_pcb(miniSO_thread[pcb].ppid);
   2219					;
   2220	0985  8B C6			     mov     ax,si
   2221	0987  BA 001A			     mov     dx,26
   2222	098A  F7 EA			     imul    dx
   2223	098C  8B D8			     mov     bx,ax
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 40
scall.ASM



   2224	098E  FF B7 0009r		     push    word ptr DGROUP:_miniSO_thread[bx+2]
   2225	0992  E8 FAED			     call    near ptr get_pcb
   2226	0995  59			     pop     cx
   2227	0996  89 46 F8			     mov     word ptr [bp-8],ax
   2228					;
   2229					;	     if	     (pai==-1) { /* Se nao encontrou o pai, */
   2230					;
   2231	0999  83 7E F8 FF		     cmp     word ptr [bp-8],-1
   2232	099D  75 27			     jne     short @22@842
   2233					;
   2234					;		     /*	coloca o processo na lista de livres */
   2235					;		     miniSO_thread[pcb].status = FREE;
   2236					;
   2237	099F  8B C6			     mov     ax,si
   2238	09A1  BA 001A			     mov     dx,26
   2239	09A4  F7 EA			     imul    dx
   2240	09A6  8B D8			     mov     bx,ax
   2241	09A8  C7 87 000Br FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+4],-1
   2242					;
   2243					;		     miniSO_thread[pcb].next = miniSO_free;
   2244					;
   2245	09AE  8B C6			     mov     ax,si
   2246	09B0  BA 001A			     mov     dx,26
   2247	09B3  F7 EA			     imul    dx
   2248	09B5  8B 16 0009r		     mov     dx,word ptr DGROUP:_miniSO_free
   2249	09B9  8B D8			     mov     bx,ax
   2250	09BB  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   2251					;
   2252					;		     miniSO_free=pcb;
   2253					;
   2254	09BF  89 36 0009r		     mov     word ptr DGROUP:_miniSO_free,si
   2255					;
   2256					;	     }
   2257					;
   2258	09C3  E9 0095			     jmp     @22@1038
   2259	09C6			     @22@842:
   2260					;
   2261					;	     else  {
   2262					;		     /*	senao, coloca o	processo na lista de zumbis do pai */
   2263					;		     miniSO_thread[pcb].status = ZOMBIE;
   2264					;
   2265	09C6  8B C6			     mov     ax,si
   2266	09C8  BA 001A			     mov     dx,26
   2267	09CB  F7 EA			     imul    dx
   2268	09CD  8B D8			     mov     bx,ax
   2269	09CF  C7 87 000Br 0002		     mov     word ptr DGROUP:_miniSO_thread[bx+4],2
   2270					;
   2271					;		     if	     (miniSO_thread[pai].zombies==-1) {	/* Se a	lista esta vazia */
   2272					;
   2273	09D5  8B 46 F8			     mov     ax,word ptr [bp-8]
   2274	09D8  BA 001A			     mov     dx,26
   2275	09DB  F7 EA			     imul    dx
   2276	09DD  8B D8			     mov     bx,ax
   2277	09DF  83 BF 001Br FF		     cmp     word ptr DGROUP:_miniSO_thread[bx+20],-1
   2278	09E4  75 1F			     jne     short @22@898
   2279					;
   2280					;			     /*	Insere no inicio */
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 41
scall.ASM



   2281					;			     miniSO_thread[pai].zombies	= pcb;
   2282					;
   2283	09E6  8B 46 F8			     mov     ax,word ptr [bp-8]
   2284	09E9  BA 001A			     mov     dx,26
   2285	09EC  F7 EA			     imul    dx
   2286	09EE  8B D8			     mov     bx,ax
   2287	09F0  89 B7 001Br		     mov     word ptr DGROUP:_miniSO_thread[bx+20],si
   2288					;
   2289					;			     miniSO_thread[pcb].prev = -1;
   2290					;
   2291	09F4  8B C6			     mov     ax,si
   2292	09F6  BA 001A			     mov     dx,26
   2293	09F9  F7 EA			     imul    dx
   2294	09FB  8B D8			     mov     bx,ax
   2295	09FD  C7 87 001Dr FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+22],-1
   2296					;
   2297					;		     }
   2298					;
   2299	0A03  EB 47			     jmp     short @22@1010
   2300	0A05			     @22@898:
   2301					;
   2302					;		     else {
   2303					;			     /*	Senao insere no	final */
   2304					;			     i = miniSO_thread[pai].zombies;
   2305					;
   2306	0A05  8B 46 F8			     mov     ax,word ptr [bp-8]
   2307	0A08  BA 001A			     mov     dx,26
   2308	0A0B  F7 EA			     imul    dx
   2309	0A0D  8B D8			     mov     bx,ax
   2310	0A0F  8B BF 001Br		     mov     di,word ptr DGROUP:_miniSO_thread[bx+20]
   2311	0A13  EB 0D			     jmp     short @22@954
   2312	0A15			     @22@926:
   2313					;
   2314					;			     while   (miniSO_thread[i].next!=-1)
   2315					;				     i = miniSO_thread[i].next;
   2316					;
   2317	0A15  8B C7			     mov     ax,di
   2318	0A17  BA 001A			     mov     dx,26
   2319	0A1A  F7 EA			     imul    dx
   2320	0A1C  8B D8			     mov     bx,ax
   2321	0A1E  8B BF 001Fr		     mov     di,word ptr DGROUP:_miniSO_thread[bx+24]
   2322	0A22			     @22@954:
   2323	0A22  8B C7			     mov     ax,di
   2324	0A24  BA 001A			     mov     dx,26
   2325	0A27  F7 EA			     imul    dx
   2326	0A29  8B D8			     mov     bx,ax
   2327	0A2B  83 BF 001Fr FF		     cmp     word ptr DGROUP:_miniSO_thread[bx+24],-1
   2328	0A30  75 E3			     jne     short @22@926
   2329					;
   2330					;			     miniSO_thread[i].next = pcb;
   2331					;
   2332	0A32  8B C7			     mov     ax,di
   2333	0A34  BA 001A			     mov     dx,26
   2334	0A37  F7 EA			     imul    dx
   2335	0A39  8B D8			     mov     bx,ax
   2336	0A3B  89 B7 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],si
   2337					;
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 42
scall.ASM



   2338					;			     miniSO_thread[pcb].prev = i;
   2339					;
   2340	0A3F  8B C6			     mov     ax,si
   2341	0A41  BA 001A			     mov     dx,26
   2342	0A44  F7 EA			     imul    dx
   2343	0A46  8B D8			     mov     bx,ax
   2344	0A48  89 BF 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],di
   2345	0A4C			     @22@1010:
   2346					;
   2347					;		     }
   2348					;		     miniSO_thread[pcb].next = -1;
   2349					;
   2350	0A4C  8B C6			     mov     ax,si
   2351	0A4E  BA 001A			     mov     dx,26
   2352	0A51  F7 EA			     imul    dx
   2353	0A53  8B D8			     mov     bx,ax
   2354	0A55  C7 87 001Fr FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+24],-1
   2355	0A5B			     @22@1038:
   2356					;
   2357					;	     }
   2358					;	     if	     (miniSO_thread[pai].status==WAIT) {
   2359					;
   2360	0A5B  8B 46 F8			     mov     ax,word ptr [bp-8]
   2361	0A5E  BA 001A			     mov     dx,26
   2362	0A61  F7 EA			     imul    dx
   2363	0A63  8B D8			     mov     bx,ax
   2364	0A65  83 BF 000Br 03		     cmp     word ptr DGROUP:_miniSO_thread[bx+4],3
   2365	0A6A  75 00			     jne     short @22@1066
   2366	0A6C			     @22@1066:
   2367					;
   2368					;	     }
   2369					;	     /*	REVISAR	*/
   2370					;      /* Se o processo-pai esta' esperando em wait, coloca ele	na lista de prontos */
   2371					;      nextthread = miniSO_thread[pcb].wait;
   2372					;
   2373	0A6C  8B C6			     mov     ax,si
   2374	0A6E  BA 001A			     mov     dx,26
   2375	0A71  F7 EA			     imul    dx
   2376	0A73  8B D8			     mov     bx,ax
   2377	0A75  8B 87 0015r		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+14]
   2378	0A79  89 46 FA			     mov     word ptr [bp-6],ax
   2379					;
   2380					;      if (nextthread != -1)  {
   2381					;
   2382	0A7C  83 7E FA FF		     cmp     word ptr [bp-6],-1
   2383	0A80  75 03			     jne     @@2
   2384	0A82  EB 77 90			     jmp     @22@1122
   2385	0A85			     @@2:
   2386					;
   2387					;	  /* Descobre qual a ultima thread */
   2388					;	  last = miniSO_thread[miniSO_ready].prev;
   2389					;
   2390	0A85  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   2391	0A88  BA 001A			     mov     dx,26
   2392	0A8B  F7 EA			     imul    dx
   2393	0A8D  8B D8			     mov     bx,ax
   2394	0A8F  8B 87 001Dr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+22]
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 43
scall.ASM



   2395	0A93  89 46 FE			     mov     word ptr [bp-2],ax
   2396					;
   2397					;	  /* Acerta links para incluir a thread	no final da lista de prontos*/
   2398					;	  miniSO_thread[nextthread].prev    = last;
   2399					;
   2400	0A96  8B 46 FA			     mov     ax,word ptr [bp-6]
   2401	0A99  BA 001A			     mov     dx,26
   2402	0A9C  F7 EA			     imul    dx
   2403	0A9E  8B 56 FE			     mov     dx,word ptr [bp-2]
   2404	0AA1  8B D8			     mov     bx,ax
   2405	0AA3  89 97 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],dx
   2406					;
   2407					;	  miniSO_thread[nextthread].next    = miniSO_ready;
   2408					;
   2409	0AA7  8B 46 FA			     mov     ax,word ptr [bp-6]
   2410	0AAA  BA 001A			     mov     dx,26
   2411	0AAD  F7 EA			     imul    dx
   2412	0AAF  8B 16 0007r		     mov     dx,word ptr DGROUP:_miniSO_ready
   2413	0AB3  8B D8			     mov     bx,ax
   2414	0AB5  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   2415					;
   2416					;	  miniSO_thread[last].next	    = nextthread;
   2417					;
   2418	0AB9  8B 46 FE			     mov     ax,word ptr [bp-2]
   2419	0ABC  BA 001A			     mov     dx,26
   2420	0ABF  F7 EA			     imul    dx
   2421	0AC1  8B 56 FA			     mov     dx,word ptr [bp-6]
   2422	0AC4  8B D8			     mov     bx,ax
   2423	0AC6  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   2424					;
   2425					;	  miniSO_thread[miniSO_ready].prev  = nextthread;
   2426					;
   2427	0ACA  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   2428	0ACD  BA 001A			     mov     dx,26
   2429	0AD0  F7 EA			     imul    dx
   2430	0AD2  8B 56 FA			     mov     dx,word ptr [bp-6]
   2431	0AD5  8B D8			     mov     bx,ax
   2432	0AD7  89 97 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],dx
   2433					;
   2434					;	  miniSO_thread[nextthread].exitcode = miniSO_ERROR;
   2435					;
   2436	0ADB  8B 46 FA			     mov     ax,word ptr [bp-6]
   2437	0ADE  BA 001A			     mov     dx,26
   2438	0AE1  F7 EA			     imul    dx
   2439	0AE3  8B D8			     mov     bx,ax
   2440	0AE5  C7 87 0019r FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+18],-1
   2441					;
   2442					;	  miniSO_thread[nextthread].status  = READY;
   2443					;
   2444	0AEB  8B 46 FA			     mov     ax,word ptr [bp-6]
   2445	0AEE  BA 001A			     mov     dx,26
   2446	0AF1  F7 EA			     imul    dx
   2447	0AF3  8B D8			     mov     bx,ax
   2448	0AF5  C7 87 000Br 0000		     mov     word ptr DGROUP:_miniSO_thread[bx+4],0
   2449	0AFB			     @22@1122:
   2450					;
   2451					;      }
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 44
scall.ASM



   2452					;
   2453					;	     enable();
   2454					;
   2455	0AFB  E8 0000e			     call    near ptr _enable
   2456					;
   2457					;	     if	     (miniSO_delcurthread)
   2458					;
   2459	0AFE  80 3E 0006r 00		     cmp     byte ptr DGROUP:_miniSO_delcurthread,0
   2460	0B03  74 02			     je	     short @22@1178
   2461	0B05			     @22@1150:
   2462	0B05  EB FE			     jmp     short @22@1150
   2463	0B07			     @22@1178:
   2464					;
   2465					;		     while   (1)
   2466					;			     ;
   2467					;	     return miniSO_OK;
   2468					;
   2469	0B07  B8 0001			     mov     ax,1
   2470	0B0A  E9 FD45			     jmp     @22@142
   2471	0B0D			     @22@1206:
   2472					;
   2473					;    }
   2474					;
   2475	0B0D  5F			     pop     di
   2476	0B0E  5E			     pop     si
   2477	0B0F  8B E5			     mov     sp,bp
   2478	0B11  5D			     pop     bp
   2479	0B12  C3			     ret
   2480	0B13			     _sc_kill	     endp
   2481	0B13			     @22@C1266	     label   word
   2482	0B13  0936r			     dw	     @22@562
   2483	0B15  0936r			     dw	     @22@562
   2484	0B17  0982r			     dw	     @22@758
   2485	0B19  0980r			     dw	     @22@730
   2486	0B1B  0980r			     dw	     @22@730
   2487	0B1D  097Er			     dw	     @22@702
   2488	0B1F  0980r			     dw	     @22@730
   2489					;
   2490					;    int sc_waitpid(pid_t pid,unsigned seg,unsigned off)
   2491					;
   2492					     assume  cs:_TEXT
   2493	0B21			     _sc_waitpid     proc    near
   2494	0B21  55			     push    bp
   2495	0B22  8B EC			     mov     bp,sp
   2496	0B24  83 EC 04			     sub     sp,4
   2497	0B27  56			     push    si
   2498	0B28  57			     push    di
   2499					;
   2500					;    {
   2501					;	     pcb_t pcb,pcbw,prevthread,nextthread,atual;
   2502					;
   2503					;	     disable();
   2504					;
   2505	0B29  E8 0000e			     call    near ptr _disable
   2506					;
   2507					;	     /*	Tem que	verificar se existe a thread */
   2508					;	     pcb = get_pcb(pid);
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 45
scall.ASM



   2509					;
   2510	0B2C  FF 76 04			     push    word ptr [bp+4]
   2511	0B2F  E8 F950			     call    near ptr get_pcb
   2512	0B32  59			     pop     cx
   2513	0B33  89 46 FE			     mov     word ptr [bp-2],ax
   2514					;
   2515					;	     /*	Se nao existe uma thread com este numero ou se não é pai da thread, entao   +
   2516				     retorna */
   2517					;	     if	     (pcb==-1 || miniSO_thread[pcb].ppid != miniSO_thread[miniSO_ready].pid)+
   2518				     {
   2519					;
   2520	0B36  83 7E FE FF		     cmp     word ptr [bp-2],-1
   2521	0B3A  74 20			     je	     short @23@86
   2522	0B3C  8B 46 FE			     mov     ax,word ptr [bp-2]
   2523	0B3F  BA 001A			     mov     dx,26
   2524	0B42  F7 EA			     imul    dx
   2525	0B44  8B D8			     mov     bx,ax
   2526	0B46  8B 87 0009r		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+2]
   2527	0B4A  50			     push    ax
   2528	0B4B  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   2529	0B4E  BA 001A			     mov     dx,26
   2530	0B51  F7 EA			     imul    dx
   2531	0B53  8B D8			     mov     bx,ax
   2532	0B55  58			     pop     ax
   2533	0B56  3B 87 0007r		     cmp     ax,word ptr DGROUP:_miniSO_thread[bx]
   2534	0B5A  74 09			     je	     short @23@142
   2535	0B5C			     @23@86:
   2536					;
   2537					;		     enable();
   2538					;
   2539	0B5C  E8 0000e			     call    near ptr _enable
   2540					;
   2541					;		     return miniSO_ERROR;
   2542					;
   2543	0B5F  B8 FFFF			     mov     ax,-1
   2544	0B62			     @23@114:
   2545	0B62  E9 0171			     jmp     @23@590
   2546	0B65			     @23@142:
   2547					;
   2548					;	     }
   2549					;	     if	     (miniSO_thread[pcb].status==ZOMBIE)  {
   2550					;
   2551	0B65  8B 46 FE			     mov     ax,word ptr [bp-2]
   2552	0B68  BA 001A			     mov     dx,26
   2553	0B6B  F7 EA			     imul    dx
   2554	0B6D  8B D8			     mov     bx,ax
   2555	0B6F  83 BF 000Br 02		     cmp     word ptr DGROUP:_miniSO_thread[bx+4],2
   2556	0B74  74 03			     je	     @@3
   2557	0B76  E9 009E			     jmp     @23@422
   2558	0B79			     @@3:
   2559					;
   2560					;		     /*	O processo filho ja terminou...	*/
   2561					;		     /*	Retira o processo filho	da lista de zumbis do pai */
   2562					;		     atual = pcb;
   2563					;
   2564	0B79  8B 76 FE			     mov     si,word ptr [bp-2]
   2565					;
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 46
scall.ASM



   2566					;		     prevthread	= miniSO_thread[atual].prev;
   2567					;
   2568	0B7C  8B C6			     mov     ax,si
   2569	0B7E  BA 001A			     mov     dx,26
   2570	0B81  F7 EA			     imul    dx
   2571	0B83  8B D8			     mov     bx,ax
   2572	0B85  8B 87 001Dr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+22]
   2573	0B89  89 46 FC			     mov     word ptr [bp-4],ax
   2574					;
   2575					;		     nextthread	= miniSO_thread[atual].next;
   2576					;
   2577	0B8C  8B C6			     mov     ax,si
   2578	0B8E  BA 001A			     mov     dx,26
   2579	0B91  F7 EA			     imul    dx
   2580	0B93  8B D8			     mov     bx,ax
   2581	0B95  8B BF 001Fr		     mov     di,word ptr DGROUP:_miniSO_thread[bx+24]
   2582					;
   2583					;		     if	     (prevthread == -1)	 { /* E	o primeiro da lista */
   2584					;
   2585	0B99  83 7E FC FF		     cmp     word ptr [bp-4],-1
   2586	0B9D  75 24			     jne     short @23@282
   2587					;
   2588					;			     miniSO_thread[miniSO_ready].zombies = nextthread;
   2589					;
   2590	0B9F  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   2591	0BA2  BA 001A			     mov     dx,26
   2592	0BA5  F7 EA			     imul    dx
   2593	0BA7  8B D8			     mov     bx,ax
   2594	0BA9  89 BF 001Br		     mov     word ptr DGROUP:_miniSO_thread[bx+20],di
   2595					;
   2596					;			     if	     (nextthread != -1)
   2597					;
   2598	0BAD  83 FF FF			     cmp     di,-1
   2599	0BB0  74 0F			     je	     short @23@254
   2600					;
   2601					;				     miniSO_thread[nextthread].prev = -1;
   2602					;
   2603	0BB2  8B C7			     mov     ax,di
   2604	0BB4  BA 001A			     mov     dx,26
   2605	0BB7  F7 EA			     imul    dx
   2606	0BB9  8B D8			     mov     bx,ax
   2607	0BBB  C7 87 001Dr FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+22],-1
   2608	0BC1			     @23@254:
   2609					;
   2610					;		     }
   2611					;
   2612	0BC1  EB 0E			     jmp     short @23@310
   2613	0BC3			     @23@282:
   2614					;
   2615					;		     else
   2616					;			     miniSO_thread[prevthread].next = nextthread;
   2617					;
   2618	0BC3  8B 46 FC			     mov     ax,word ptr [bp-4]
   2619	0BC6  BA 001A			     mov     dx,26
   2620	0BC9  F7 EA			     imul    dx
   2621	0BCB  8B D8			     mov     bx,ax
   2622	0BCD  89 BF 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],di
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 47
scall.ASM



   2623	0BD1			     @23@310:
   2624					;
   2625					;			     if	     (nextthread != -1)
   2626					;
   2627	0BD1  83 FF FF			     cmp     di,-1
   2628	0BD4  74 10			     je	     short @23@366
   2629					;
   2630					;				     miniSO_thread[nextthread].prev = prevthread;
   2631					;
   2632	0BD6  8B C7			     mov     ax,di
   2633	0BD8  BA 001A			     mov     dx,26
   2634	0BDB  F7 EA			     imul    dx
   2635	0BDD  8B 56 FC			     mov     dx,word ptr [bp-4]
   2636	0BE0  8B D8			     mov     bx,ax
   2637	0BE2  89 97 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],dx
   2638	0BE6			     @23@366:
   2639					;
   2640					;		     /*	Insere o processo na lista de BCPs livres */
   2641					;		     miniSO_thread[pcb].next = miniSO_free;
   2642					;
   2643	0BE6  8B 46 FE			     mov     ax,word ptr [bp-2]
   2644	0BE9  BA 001A			     mov     dx,26
   2645	0BEC  F7 EA			     imul    dx
   2646	0BEE  8B 16 0009r		     mov     dx,word ptr DGROUP:_miniSO_free
   2647	0BF2  8B D8			     mov     bx,ax
   2648	0BF4  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   2649					;
   2650					;		     miniSO_free = pcb;
   2651					;
   2652	0BF8  8B 46 FE			     mov     ax,word ptr [bp-2]
   2653	0BFB  A3 0009r			     mov     word ptr DGROUP:_miniSO_free,ax
   2654					;
   2655					;		     miniSO_thread[pcb].status = FREE;
   2656					;
   2657	0BFE  8B 46 FE			     mov     ax,word ptr [bp-2]
   2658	0C01  BA 001A			     mov     dx,26
   2659	0C04  F7 EA			     imul    dx
   2660	0C06  8B D8			     mov     bx,ax
   2661	0C08  C7 87 000Br FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+4],-1
   2662					;
   2663					;		     return miniSO_thread[pcb].exitcode;
   2664					;
   2665	0C0E  8B 46 FE			     mov     ax,word ptr [bp-2]
   2666	0C11  E9 00B4			     jmp     @23@562
   2667					;
   2668					;	     }
   2669					;
   2670	0C14  E9 00BF			     jmp     @23@590
   2671	0C17			     @23@422:
   2672					;
   2673					;	     else  {
   2674					;		     /*	O processo-filho ainda esta em execucao... */
   2675					;		     atual = miniSO_ready;
   2676					;
   2677	0C17  8B 36 0007r		     mov     si,word ptr DGROUP:_miniSO_ready
   2678					;
   2679					;		     prevthread	= miniSO_thread[atual].prev;
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 48
scall.ASM



   2680					;
   2681	0C1B  8B C6			     mov     ax,si
   2682	0C1D  BA 001A			     mov     dx,26
   2683	0C20  F7 EA			     imul    dx
   2684	0C22  8B D8			     mov     bx,ax
   2685	0C24  8B 87 001Dr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+22]
   2686	0C28  89 46 FC			     mov     word ptr [bp-4],ax
   2687					;
   2688					;		     nextthread	= miniSO_thread[atual].next;
   2689					;
   2690	0C2B  8B C6			     mov     ax,si
   2691	0C2D  BA 001A			     mov     dx,26
   2692	0C30  F7 EA			     imul    dx
   2693	0C32  8B D8			     mov     bx,ax
   2694	0C34  8B BF 001Fr		     mov     di,word ptr DGROUP:_miniSO_thread[bx+24]
   2695					;
   2696					;		     /*	Se eh a	ultima thread ... */
   2697					;		     if	     (atual == nextthread)
   2698					;
   2699	0C38  3B F7			     cmp     si,di
   2700	0C3A  75 08			     jne     short @23@478
   2701					;
   2702					;			     end_mso("waitpid(): nao ha' mais threads executando!");
   2703					;
   2704	0C3C  B8 0102r			     mov     ax,offset DGROUP:s@+110
   2705	0C3F  50			     push    ax
   2706	0C40  E8 F7FA			     call    near ptr end_mso
   2707	0C43  59			     pop     cx
   2708	0C44			     @23@478:
   2709					;
   2710					;		     /*	Vincula	o BCP da thread	atual ao BCP da	thread "destino" */
   2711					;		     miniSO_thread[pcb].wait = atual;
   2712					;
   2713	0C44  8B 46 FE			     mov     ax,word ptr [bp-2]
   2714	0C47  BA 001A			     mov     dx,26
   2715	0C4A  F7 EA			     imul    dx
   2716	0C4C  8B D8			     mov     bx,ax
   2717	0C4E  89 B7 0015r		     mov     word ptr DGROUP:_miniSO_thread[bx+14],si
   2718					;
   2719					;		     miniSO_thread[atual].prev = -1;
   2720					;
   2721	0C52  8B C6			     mov     ax,si
   2722	0C54  BA 001A			     mov     dx,26
   2723	0C57  F7 EA			     imul    dx
   2724	0C59  8B D8			     mov     bx,ax
   2725	0C5B  C7 87 001Dr FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+22],-1
   2726					;
   2727					;		     miniSO_thread[atual].next = -1;
   2728					;
   2729	0C61  8B C6			     mov     ax,si
   2730	0C63  BA 001A			     mov     dx,26
   2731	0C66  F7 EA			     imul    dx
   2732	0C68  8B D8			     mov     bx,ax
   2733	0C6A  C7 87 001Fr FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+24],-1
   2734					;
   2735					;		     miniSO_thread[atual].waitfor = pcb;
   2736					;
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 49
scall.ASM



   2737	0C70  8B C6			     mov     ax,si
   2738	0C72  BA 001A			     mov     dx,26
   2739	0C75  F7 EA			     imul    dx
   2740	0C77  8B 56 FE			     mov     dx,word ptr [bp-2]
   2741	0C7A  8B D8			     mov     bx,ax
   2742	0C7C  89 97 0017r		     mov     word ptr DGROUP:_miniSO_thread[bx+16],dx
   2743					;
   2744					;		     miniSO_thread[atual].status = WAIT;
   2745					;
   2746	0C80  8B C6			     mov     ax,si
   2747	0C82  BA 001A			     mov     dx,26
   2748	0C85  F7 EA			     imul    dx
   2749	0C87  8B D8			     mov     bx,ax
   2750	0C89  C7 87 000Br 0003		     mov     word ptr DGROUP:_miniSO_thread[bx+4],3
   2751					;
   2752					;		     /*	Exclui o nodo da lista de prontos */
   2753					;		     miniSO_thread[prevthread].next=nextthread;
   2754					;
   2755	0C8F  8B 46 FC			     mov     ax,word ptr [bp-4]
   2756	0C92  BA 001A			     mov     dx,26
   2757	0C95  F7 EA			     imul    dx
   2758	0C97  8B D8			     mov     bx,ax
   2759	0C99  89 BF 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],di
   2760					;
   2761					;		     miniSO_thread[nextthread].prev=prevthread;
   2762					;
   2763	0C9D  8B C7			     mov     ax,di
   2764	0C9F  BA 001A			     mov     dx,26
   2765	0CA2  F7 EA			     imul    dx
   2766	0CA4  8B 56 FC			     mov     dx,word ptr [bp-4]
   2767	0CA7  8B D8			     mov     bx,ax
   2768	0CA9  89 97 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],dx
   2769					;
   2770					;		     miniSO_nextthread=nextthread;
   2771					;
   2772	0CAD  89 3E 0004r		     mov     word ptr DGROUP:_miniSO_nextthread,di
   2773					;
   2774					;		     enable();
   2775					;
   2776	0CB1  E8 0000e			     call    near ptr _enable
   2777	0CB4  EB 00			     jmp     short @23@506
   2778	0CB6			     @23@506:
   2779					;
   2780					;		     while   (miniSO_thread[atual].status == WAIT)
   2781					;
   2782	0CB6  8B C6			     mov     ax,si
   2783	0CB8  BA 001A			     mov     dx,26
   2784	0CBB  F7 EA			     imul    dx
   2785	0CBD  8B D8			     mov     bx,ax
   2786	0CBF  83 BF 000Br 03		     cmp     word ptr DGROUP:_miniSO_thread[bx+4],3
   2787	0CC4  74 F0			     je	     short @23@506
   2788					;
   2789					;			     ;
   2790					;		     return miniSO_thread[atual].exitcode;
   2791					;
   2792	0CC6  8B C6			     mov     ax,si
   2793	0CC8			     @23@562:
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 50
scall.ASM



   2794	0CC8  BA 001A			     mov     dx,26
   2795	0CCB  F7 EA			     imul    dx
   2796	0CCD  8B D8			     mov     bx,ax
   2797	0CCF  8B 87 0019r		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+18]
   2798	0CD3  E9 FE8C			     jmp     @23@114
   2799	0CD6			     @23@590:
   2800					;
   2801					;	     }
   2802					;    }
   2803					;
   2804	0CD6  5F			     pop     di
   2805	0CD7  5E			     pop     si
   2806	0CD8  8B E5			     mov     sp,bp
   2807	0CDA  5D			     pop     bp
   2808	0CDB  C3			     ret
   2809	0CDC			     _sc_waitpid     endp
   2810					;
   2811					;    int sc_wait(unsigned seg,unsigned off)
   2812					;
   2813					     assume  cs:_TEXT
   2814	0CDC			     _sc_wait	     proc    near
   2815	0CDC  55			     push    bp
   2816	0CDD  8B EC			     mov     bp,sp
   2817	0CDF  83 EC 08			     sub     sp,8
   2818	0CE2  56			     push    si
   2819	0CE3  57			     push    di
   2820					;
   2821					;    {
   2822					;	     pcb_t   zombie,next,atual,prevthread,nextthread;
   2823					;	     int far *p_ref;
   2824					;
   2825					;	     disable();
   2826					;
   2827	0CE4  E8 0000e			     call    near ptr _disable
   2828					;
   2829					;	     atual =miniSO_ready;
   2830					;
   2831	0CE7  8B 36 0007r		     mov     si,word ptr DGROUP:_miniSO_ready
   2832					;
   2833					;	     if	     (miniSO_thread[miniSO_ready].zombies==-1) {
   2834					;
   2835	0CEB  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   2836	0CEE  BA 001A			     mov     dx,26
   2837	0CF1  F7 EA			     imul    dx
   2838	0CF3  8B D8			     mov     bx,ax
   2839	0CF5  83 BF 001Br FF		     cmp     word ptr DGROUP:_miniSO_thread[bx+20],-1
   2840	0CFA  74 03			     je	     @@4
   2841	0CFC  E9 00A7			     jmp     @24@170
   2842	0CFF			     @@4:
   2843					;
   2844					;		     /*	O pai nao tem filhos-zumbi e vai bloquear */
   2845					;		     prevthread	= miniSO_thread[atual].prev;
   2846					;
   2847	0CFF  8B C6			     mov     ax,si
   2848	0D01  BA 001A			     mov     dx,26
   2849	0D04  F7 EA			     imul    dx
   2850	0D06  8B D8			     mov     bx,ax
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 51
scall.ASM



   2851	0D08  8B 87 001Dr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+22]
   2852	0D0C  89 46 FE			     mov     word ptr [bp-2],ax
   2853					;
   2854					;		     nextthread	= miniSO_thread[atual].next;
   2855					;
   2856	0D0F  8B C6			     mov     ax,si
   2857	0D11  BA 001A			     mov     dx,26
   2858	0D14  F7 EA			     imul    dx
   2859	0D16  8B D8			     mov     bx,ax
   2860	0D18  8B 87 001Fr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+24]
   2861	0D1C  89 46 FC			     mov     word ptr [bp-4],ax
   2862					;
   2863					;		     /*	Se eh a	ultima thread ... */
   2864					;		     if	     (miniSO_ready == nextthread)
   2865					;
   2866	0D1F  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   2867	0D22  3B 46 FC			     cmp     ax,word ptr [bp-4]
   2868	0D25  75 08			     jne     short @24@114
   2869					;
   2870					;			     end_mso("wait(): nao ha' mais threads executando!");
   2871					;
   2872	0D27  B8 012Er			     mov     ax,offset DGROUP:s@+154
   2873	0D2A  50			     push    ax
   2874	0D2B  E8 F70F			     call    near ptr end_mso
   2875	0D2E  59			     pop     cx
   2876	0D2F			     @24@114:
   2877					;
   2878					;		     /*	Vincula	o BCP da thread	atual ao BCP da	thread "destino" */
   2879					;		     miniSO_thread[atual].prev = -1;
   2880					;
   2881	0D2F  8B C6			     mov     ax,si
   2882	0D31  BA 001A			     mov     dx,26
   2883	0D34  F7 EA			     imul    dx
   2884	0D36  8B D8			     mov     bx,ax
   2885	0D38  C7 87 001Dr FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+22],-1
   2886					;
   2887					;		     miniSO_thread[atual].next = -1;
   2888					;
   2889	0D3E  8B C6			     mov     ax,si
   2890	0D40  BA 001A			     mov     dx,26
   2891	0D43  F7 EA			     imul    dx
   2892	0D45  8B D8			     mov     bx,ax
   2893	0D47  C7 87 001Fr FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+24],-1
   2894					;
   2895					;		     miniSO_thread[atual].waitfor = -1;
   2896					;
   2897	0D4D  8B C6			     mov     ax,si
   2898	0D4F  BA 001A			     mov     dx,26
   2899	0D52  F7 EA			     imul    dx
   2900	0D54  8B D8			     mov     bx,ax
   2901	0D56  C7 87 0017r FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+16],-1
   2902					;
   2903					;		     miniSO_thread[atual].status = WAIT;
   2904					;
   2905	0D5C  8B C6			     mov     ax,si
   2906	0D5E  BA 001A			     mov     dx,26
   2907	0D61  F7 EA			     imul    dx
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 52
scall.ASM



   2908	0D63  8B D8			     mov     bx,ax
   2909	0D65  C7 87 000Br 0003		     mov     word ptr DGROUP:_miniSO_thread[bx+4],3
   2910					;
   2911					;		     /*	Exclui o nodo da lista de prontos */
   2912					;		     miniSO_thread[atual].next=nextthread;
   2913					;
   2914	0D6B  8B C6			     mov     ax,si
   2915	0D6D  BA 001A			     mov     dx,26
   2916	0D70  F7 EA			     imul    dx
   2917	0D72  8B 56 FC			     mov     dx,word ptr [bp-4]
   2918	0D75  8B D8			     mov     bx,ax
   2919	0D77  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   2920					;
   2921					;		     miniSO_thread[atual].prev=prevthread;
   2922					;
   2923	0D7B  8B C6			     mov     ax,si
   2924	0D7D  BA 001A			     mov     dx,26
   2925	0D80  F7 EA			     imul    dx
   2926	0D82  8B 56 FE			     mov     dx,word ptr [bp-2]
   2927	0D85  8B D8			     mov     bx,ax
   2928	0D87  89 97 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],dx
   2929					;
   2930					;		     miniSO_nextthread=nextthread;
   2931					;
   2932	0D8B  8B 46 FC			     mov     ax,word ptr [bp-4]
   2933	0D8E  A3 0004r			     mov     word ptr DGROUP:_miniSO_nextthread,ax
   2934					;
   2935					;		     enable();
   2936					;
   2937	0D91  E8 0000e			     call    near ptr _enable
   2938	0D94  EB 00			     jmp     short @24@142
   2939	0D96			     @24@142:
   2940					;
   2941					;		     while   (miniSO_thread[atual].status == WAIT)
   2942					;
   2943	0D96  8B C6			     mov     ax,si
   2944	0D98  BA 001A			     mov     dx,26
   2945	0D9B  F7 EA			     imul    dx
   2946	0D9D  8B D8			     mov     bx,ax
   2947	0D9F  83 BF 000Br 03		     cmp     word ptr DGROUP:_miniSO_thread[bx+4],3
   2948	0DA4  74 F0			     je	     short @24@142
   2949	0DA6			     @24@170:
   2950					;
   2951					;			     ;
   2952					;	     }
   2953					;	     /*	O pai tem pelo menos um	filho zumbi... */
   2954					;	     zombie = miniSO_thread[atual].zombies;
   2955					;
   2956	0DA6  8B C6			     mov     ax,si
   2957	0DA8  BA 001A			     mov     dx,26
   2958	0DAB  F7 EA			     imul    dx
   2959	0DAD  8B D8			     mov     bx,ax
   2960	0DAF  8B BF 001Br		     mov     di,word ptr DGROUP:_miniSO_thread[bx+20]
   2961					;
   2962					;	     miniSO_thread[atual].zombies = miniSO_thread[zombie].next;
   2963					;
   2964	0DB3  8B C7			     mov     ax,di
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 53
scall.ASM



   2965	0DB5  BA 001A			     mov     dx,26
   2966	0DB8  F7 EA			     imul    dx
   2967	0DBA  8B D8			     mov     bx,ax
   2968	0DBC  8B 87 001Fr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+24]
   2969	0DC0  50			     push    ax
   2970	0DC1  8B C6			     mov     ax,si
   2971	0DC3  BA 001A			     mov     dx,26
   2972	0DC6  F7 EA			     imul    dx
   2973	0DC8  8B D8			     mov     bx,ax
   2974	0DCA  58			     pop     ax
   2975	0DCB  89 87 001Br		     mov     word ptr DGROUP:_miniSO_thread[bx+20],ax
   2976					;
   2977					;	     if	     (miniSO_thread[atual].zombies!=-1)
   2978					;
   2979	0DCF  8B C6			     mov     ax,si
   2980	0DD1  BA 001A			     mov     dx,26
   2981	0DD4  F7 EA			     imul    dx
   2982	0DD6  8B D8			     mov     bx,ax
   2983	0DD8  83 BF 001Br FF		     cmp     word ptr DGROUP:_miniSO_thread[bx+20],-1
   2984	0DDD  74 1A			     je	     short @24@226
   2985					;
   2986					;		     miniSO_thread[miniSO_thread[atual].zombies].prev =	-1;
   2987					;
   2988	0DDF  8B C6			     mov     ax,si
   2989	0DE1  BA 001A			     mov     dx,26
   2990	0DE4  F7 EA			     imul    dx
   2991	0DE6  8B D8			     mov     bx,ax
   2992	0DE8  8B 87 001Br		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+20]
   2993	0DEC  BA 001A			     mov     dx,26
   2994	0DEF  F7 EA			     imul    dx
   2995	0DF1  8B D8			     mov     bx,ax
   2996	0DF3  C7 87 001Dr FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+22],-1
   2997	0DF9			     @24@226:
   2998					;
   2999					;	     miniSO_thread[zombie].next	= miniSO_free;
   3000					;
   3001	0DF9  8B C7			     mov     ax,di
   3002	0DFB  BA 001A			     mov     dx,26
   3003	0DFE  F7 EA			     imul    dx
   3004	0E00  8B 16 0009r		     mov     dx,word ptr DGROUP:_miniSO_free
   3005	0E04  8B D8			     mov     bx,ax
   3006	0E06  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   3007					;
   3008					;	     miniSO_thread[zombie].status = FREE;
   3009					;
   3010	0E0A  8B C7			     mov     ax,di
   3011	0E0C  BA 001A			     mov     dx,26
   3012	0E0F  F7 EA			     imul    dx
   3013	0E11  8B D8			     mov     bx,ax
   3014	0E13  C7 87 000Br FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+4],-1
   3015					;
   3016					;	     miniSO_free = zombie;
   3017					;
   3018	0E19  89 3E 0009r		     mov     word ptr DGROUP:_miniSO_free,di
   3019					;
   3020					;	     p_ref = MK_FP(seg,off);
   3021					;
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 54
scall.ASM



   3022	0E1D  FF 76 06			     push    word ptr [bp+6]
   3023	0E20  FF 76 04			     push    word ptr [bp+4]
   3024	0E23  E8 0000e			     call    near ptr _MK_FP
   3025	0E26  59			     pop     cx
   3026	0E27  59			     pop     cx
   3027	0E28  89 56 FA			     mov     word ptr [bp-6],dx
   3028	0E2B  89 46 F8			     mov     word ptr [bp-8],ax
   3029					;
   3030					;	     *p_ref = miniSO_thread[zombie].exitcode;
   3031					;
   3032	0E2E  8B C7			     mov     ax,di
   3033	0E30  BA 001A			     mov     dx,26
   3034	0E33  F7 EA			     imul    dx
   3035	0E35  8B D8			     mov     bx,ax
   3036	0E37  8B 87 0019r		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+18]
   3037	0E3B  C4 5E F8			     les     bx,dword ptr [bp-8]
   3038	0E3E  26: 89 07			     mov     word ptr es:[bx],ax
   3039					;
   3040					;	     return miniSO_thread[zombie].pid;
   3041					;
   3042	0E41  8B C7			     mov     ax,di
   3043	0E43  BA 001A			     mov     dx,26
   3044	0E46  F7 EA			     imul    dx
   3045	0E48  8B D8			     mov     bx,ax
   3046	0E4A  8B 87 0007r		     mov     ax,word ptr DGROUP:_miniSO_thread[bx]
   3047	0E4E  EB 00			     jmp     short @24@254
   3048	0E50			     @24@254:
   3049					;
   3050					;    }
   3051					;
   3052	0E50  5F			     pop     di
   3053	0E51  5E			     pop     si
   3054	0E52  8B E5			     mov     sp,bp
   3055	0E54  5D			     pop     bp
   3056	0E55  C3			     ret
   3057	0E56			     _sc_wait	     endp
   3058					;
   3059					;    void sc_exit(int codfim)
   3060					;
   3061					     assume  cs:_TEXT
   3062	0E56			     _sc_exit	     proc    near
   3063	0E56  55			     push    bp
   3064	0E57  8B EC			     mov     bp,sp
   3065	0E59  83 EC 06			     sub     sp,6
   3066	0E5C  56			     push    si
   3067	0E5D  57			     push    di
   3068					;
   3069					;    {
   3070					;	     pcb_t pai,i,last,prevthread,nextthread;
   3071					;
   3072					;	     disable();
   3073					;
   3074	0E5E  E8 0000e			     call    near ptr _disable
   3075					;
   3076					;	     /*	Verifica se não	esta' encerrando a thread 0 */
   3077					;	     if	     (miniSO_ready == 0)
   3078					;
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 55
scall.ASM



   3079	0E61  83 3E 0007r 00		     cmp     word ptr DGROUP:_miniSO_ready,0
   3080	0E66  75 08			     jne     short @25@86
   3081					;
   3082					;		     end_mso("exit(): thread 0 removida!");
   3083					;
   3084	0E68  B8 0157r			     mov     ax,offset DGROUP:s@+195
   3085	0E6B  50			     push    ax
   3086	0E6C  E8 F5CE			     call    near ptr end_mso
   3087	0E6F  59			     pop     cx
   3088	0E70			     @25@86:
   3089	0E70  EB 41			     jmp     short @25@142
   3090	0E72			     @25@114:
   3091					;
   3092					;	     /*	Trata os zumbis	do processo atual, colocando-os	na lista de livres */
   3093					;	     i = miniSO_thread[miniSO_ready].zombies;
   3094					;	     while   (i!= -1)  {
   3095					;		     miniSO_thread[miniSO_ready].zombies = miniSO_thread[i].next;
   3096					;
   3097	0E72  8B C6			     mov     ax,si
   3098	0E74  BA 001A			     mov     dx,26
   3099	0E77  F7 EA			     imul    dx
   3100	0E79  8B D8			     mov     bx,ax
   3101	0E7B  8B 87 001Fr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+24]
   3102	0E7F  50			     push    ax
   3103	0E80  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3104	0E83  BA 001A			     mov     dx,26
   3105	0E86  F7 EA			     imul    dx
   3106	0E88  8B D8			     mov     bx,ax
   3107	0E8A  58			     pop     ax
   3108	0E8B  89 87 001Br		     mov     word ptr DGROUP:_miniSO_thread[bx+20],ax
   3109					;
   3110					;		     miniSO_thread[i].next   = miniSO_free;
   3111					;
   3112	0E8F  8B C6			     mov     ax,si
   3113	0E91  BA 001A			     mov     dx,26
   3114	0E94  F7 EA			     imul    dx
   3115	0E96  8B 16 0009r		     mov     dx,word ptr DGROUP:_miniSO_free
   3116	0E9A  8B D8			     mov     bx,ax
   3117	0E9C  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   3118					;
   3119					;		     miniSO_thread[i].status = FREE;
   3120					;
   3121	0EA0  8B C6			     mov     ax,si
   3122	0EA2  BA 001A			     mov     dx,26
   3123	0EA5  F7 EA			     imul    dx
   3124	0EA7  8B D8			     mov     bx,ax
   3125	0EA9  C7 87 000Br FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+4],-1
   3126					;
   3127					;		     miniSO_free	     = i;
   3128					;
   3129	0EAF  89 36 0009r		     mov     word ptr DGROUP:_miniSO_free,si
   3130					;
   3131					;		     i = miniSO_thread[miniSO_ready].zombies;
   3132					;
   3133	0EB3			     @25@142:
   3134	0EB3  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3135	0EB6  BA 001A			     mov     dx,26
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 56
scall.ASM



   3136	0EB9  F7 EA			     imul    dx
   3137	0EBB  8B D8			     mov     bx,ax
   3138	0EBD  8B B7 001Br		     mov     si,word ptr DGROUP:_miniSO_thread[bx+20]
   3139	0EC1  83 FE FF			     cmp     si,-1
   3140	0EC4  75 AC			     jne     short @25@114
   3141					;
   3142					;	     }
   3143					;	     /*	Passa os filhos	do atual para o	avo */
   3144					;	     for     (i=0;i<miniSO_MAXTHREADS;++i)  {
   3145					;
   3146	0EC6  33 F6			     xor     si,si
   3147	0EC8  EB 4D			     jmp     short @25@338
   3148	0ECA			     @25@226:
   3149					;
   3150					;		     if	     (miniSO_thread[i].status!=FREE && miniSO_thread[i].ppid ==	    +
   3151				     miniSO_thread[miniSO_ready].pid)
   3152					;
   3153	0ECA  8B C6			     mov     ax,si
   3154	0ECC  BA 001A			     mov     dx,26
   3155	0ECF  F7 EA			     imul    dx
   3156	0ED1  8B D8			     mov     bx,ax
   3157	0ED3  83 BF 000Br FF		     cmp     word ptr DGROUP:_miniSO_thread[bx+4],-1
   3158	0ED8  74 3C			     je	     short @25@310
   3159	0EDA  8B C6			     mov     ax,si
   3160	0EDC  BA 001A			     mov     dx,26
   3161	0EDF  F7 EA			     imul    dx
   3162	0EE1  8B D8			     mov     bx,ax
   3163	0EE3  8B 87 0009r		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+2]
   3164	0EE7  50			     push    ax
   3165	0EE8  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3166	0EEB  BA 001A			     mov     dx,26
   3167	0EEE  F7 EA			     imul    dx
   3168	0EF0  8B D8			     mov     bx,ax
   3169	0EF2  58			     pop     ax
   3170	0EF3  3B 87 0007r		     cmp     ax,word ptr DGROUP:_miniSO_thread[bx]
   3171	0EF7  75 1D			     jne     short @25@310
   3172					;
   3173					;			     miniSO_thread[i].ppid = miniSO_thread[miniSO_ready].ppid;
   3174					;
   3175	0EF9  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3176	0EFC  BA 001A			     mov     dx,26
   3177	0EFF  F7 EA			     imul    dx
   3178	0F01  8B D8			     mov     bx,ax
   3179	0F03  8B 87 0009r		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+2]
   3180	0F07  50			     push    ax
   3181	0F08  8B C6			     mov     ax,si
   3182	0F0A  BA 001A			     mov     dx,26
   3183	0F0D  F7 EA			     imul    dx
   3184	0F0F  8B D8			     mov     bx,ax
   3185	0F11  58			     pop     ax
   3186	0F12  89 87 0009r		     mov     word ptr DGROUP:_miniSO_thread[bx+2],ax
   3187	0F16			     @25@310:
   3188	0F16  46			     inc     si
   3189	0F17			     @25@338:
   3190	0F17  83 FE 10			     cmp     si,16
   3191	0F1A  7C AE			     jl	     short @25@226
   3192					;
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 57
scall.ASM



   3193					;	     }
   3194					;	     pai = get_pcb(miniSO_thread[miniSO_ready].ppid);
   3195					;
   3196	0F1C  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3197	0F1F  BA 001A			     mov     dx,26
   3198	0F22  F7 EA			     imul    dx
   3199	0F24  8B D8			     mov     bx,ax
   3200	0F26  FF B7 0009r		     push    word ptr DGROUP:_miniSO_thread[bx+2]
   3201	0F2A  E8 F555			     call    near ptr get_pcb
   3202	0F2D  59			     pop     cx
   3203	0F2E  8B F8			     mov     di,ax
   3204					;
   3205					;	     if	     (pai==-1)
   3206					;
   3207	0F30  83 FF FF			     cmp     di,-1
   3208	0F33  75 08			     jne     short @25@422
   3209					;
   3210					;		     end_mso("exit(): pai nao encontrado!");
   3211					;
   3212	0F35  B8 0172r			     mov     ax,offset DGROUP:s@+222
   3213	0F38  50			     push    ax
   3214	0F39  E8 F501			     call    near ptr end_mso
   3215	0F3C  59			     pop     cx
   3216	0F3D			     @25@422:
   3217					;
   3218					;	     /*	Se o processo-pai esta'	esperando em wait/waitpid, coloca ele na lista de   +
   3219				     prontos */
   3220					;	     if	     ( miniSO_thread[pai].status==WAIT &&
   3221					;
   3222					;
   3223					;		       (miniSO_thread[pai].waitfor==-1 || miniSO_thread			    +
   3224				     [pai].waitfor==miniSO_thread[miniSO_ready].pid) ) {
   3225					;
   3226	0F3D  8B C7			     mov     ax,di
   3227	0F3F  BA 001A			     mov     dx,26
   3228	0F42  F7 EA			     imul    dx
   3229	0F44  8B D8			     mov     bx,ax
   3230	0F46  83 BF 000Br 03		     cmp     word ptr DGROUP:_miniSO_thread[bx+4],3
   3231	0F4B  74 03			     je	     @@5
   3232	0F4D  E9 008C			     jmp     @25@534
   3233	0F50			     @@5:
   3234	0F50  8B C7			     mov     ax,di
   3235	0F52  BA 001A			     mov     dx,26
   3236	0F55  F7 EA			     imul    dx
   3237	0F57  8B D8			     mov     bx,ax
   3238	0F59  83 BF 0017r FF		     cmp     word ptr DGROUP:_miniSO_thread[bx+16],-1
   3239	0F5E  74 1F			     je	     short @25@506
   3240	0F60  8B C7			     mov     ax,di
   3241	0F62  BA 001A			     mov     dx,26
   3242	0F65  F7 EA			     imul    dx
   3243	0F67  8B D8			     mov     bx,ax
   3244	0F69  8B 87 0017r		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+16]
   3245	0F6D  50			     push    ax
   3246	0F6E  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3247	0F71  BA 001A			     mov     dx,26
   3248	0F74  F7 EA			     imul    dx
   3249	0F76  8B D8			     mov     bx,ax
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 58
scall.ASM



   3250	0F78  58			     pop     ax
   3251	0F79  3B 87 0007r		     cmp     ax,word ptr DGROUP:_miniSO_thread[bx]
   3252	0F7D  75 5D			     jne     short @25@534
   3253	0F7F			     @25@506:
   3254					;
   3255					;		     /*	Descobre qual a	ultima thread */
   3256					;		     last = miniSO_thread[miniSO_ready].prev;
   3257					;
   3258	0F7F  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3259	0F82  BA 001A			     mov     dx,26
   3260	0F85  F7 EA			     imul    dx
   3261	0F87  8B D8			     mov     bx,ax
   3262	0F89  8B 87 001Dr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+22]
   3263	0F8D  89 46 FE			     mov     word ptr [bp-2],ax
   3264					;
   3265					;		     /*	Acerta links para incluir a thread no final da lista de	prontos*/
   3266					;		     miniSO_thread[pai].prev	       = last;
   3267					;
   3268	0F90  8B C7			     mov     ax,di
   3269	0F92  BA 001A			     mov     dx,26
   3270	0F95  F7 EA			     imul    dx
   3271	0F97  8B 56 FE			     mov     dx,word ptr [bp-2]
   3272	0F9A  8B D8			     mov     bx,ax
   3273	0F9C  89 97 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],dx
   3274					;
   3275					;		     miniSO_thread[pai].next	       = miniSO_ready;
   3276					;
   3277	0FA0  8B C7			     mov     ax,di
   3278	0FA2  BA 001A			     mov     dx,26
   3279	0FA5  F7 EA			     imul    dx
   3280	0FA7  8B 16 0007r		     mov     dx,word ptr DGROUP:_miniSO_ready
   3281	0FAB  8B D8			     mov     bx,ax
   3282	0FAD  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   3283					;
   3284					;		     miniSO_thread[last].next	       = pai;
   3285					;
   3286	0FB1  8B 46 FE			     mov     ax,word ptr [bp-2]
   3287	0FB4  BA 001A			     mov     dx,26
   3288	0FB7  F7 EA			     imul    dx
   3289	0FB9  8B D8			     mov     bx,ax
   3290	0FBB  89 BF 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],di
   3291					;
   3292					;		     miniSO_thread[miniSO_ready].prev  = pai;
   3293					;
   3294	0FBF  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3295	0FC2  BA 001A			     mov     dx,26
   3296	0FC5  F7 EA			     imul    dx
   3297	0FC7  8B D8			     mov     bx,ax
   3298	0FC9  89 BF 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],di
   3299					;
   3300					;		     miniSO_thread[pai].status	       = READY;
   3301					;
   3302	0FCD  8B C7			     mov     ax,di
   3303	0FCF  BA 001A			     mov     dx,26
   3304	0FD2  F7 EA			     imul    dx
   3305	0FD4  8B D8			     mov     bx,ax
   3306	0FD6  C7 87 000Br 0000		     mov     word ptr DGROUP:_miniSO_thread[bx+4],0
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 59
scall.ASM



   3307	0FDC			     @25@534:
   3308					;
   3309					;	     }
   3310					;	     /*	Salva anterior e proximo da thread que sera deletada */
   3311					;	     prevthread	= miniSO_thread[miniSO_ready].prev;
   3312					;
   3313	0FDC  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3314	0FDF  BA 001A			     mov     dx,26
   3315	0FE2  F7 EA			     imul    dx
   3316	0FE4  8B D8			     mov     bx,ax
   3317	0FE6  8B 87 001Dr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+22]
   3318	0FEA  89 46 FC			     mov     word ptr [bp-4],ax
   3319					;
   3320					;	     nextthread	= miniSO_thread[miniSO_ready].next;
   3321					;
   3322	0FED  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3323	0FF0  BA 001A			     mov     dx,26
   3324	0FF3  F7 EA			     imul    dx
   3325	0FF5  8B D8			     mov     bx,ax
   3326	0FF7  8B 87 001Fr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+24]
   3327	0FFB  89 46 FA			     mov     word ptr [bp-6],ax
   3328					;
   3329					;	     if	     (miniSO_ready == nextthread)
   3330					;
   3331	0FFE  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3332	1001  3B 46 FA			     cmp     ax,word ptr [bp-6]
   3333	1004  75 08			     jne     short @25@590
   3334					;
   3335					;		     end_mso("exit(): nao ha' mais threads executando!");
   3336					;
   3337	1006  B8 018Er			     mov     ax,offset DGROUP:s@+250
   3338	1009  50			     push    ax
   3339	100A  E8 F430			     call    near ptr end_mso
   3340	100D  59			     pop     cx
   3341	100E			     @25@590:
   3342					;
   3343					;	     /*	Exclui o nodo da lista de prontos */
   3344					;	     miniSO_thread[prevthread].next=nextthread;
   3345					;
   3346	100E  8B 46 FC			     mov     ax,word ptr [bp-4]
   3347	1011  BA 001A			     mov     dx,26
   3348	1014  F7 EA			     imul    dx
   3349	1016  8B 56 FA			     mov     dx,word ptr [bp-6]
   3350	1019  8B D8			     mov     bx,ax
   3351	101B  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   3352					;
   3353					;	     miniSO_thread[nextthread].prev=prevthread;
   3354					;
   3355	101F  8B 46 FA			     mov     ax,word ptr [bp-6]
   3356	1022  BA 001A			     mov     dx,26
   3357	1025  F7 EA			     imul    dx
   3358	1027  8B 56 FC			     mov     dx,word ptr [bp-4]
   3359	102A  8B D8			     mov     bx,ax
   3360	102C  89 97 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],dx
   3361					;
   3362					;	     if	     (miniSO_thread[pai].zombies==-1) {
   3363					;
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 60
scall.ASM



   3364	1030  8B C7			     mov     ax,di
   3365	1032  BA 001A			     mov     dx,26
   3366	1035  F7 EA			     imul    dx
   3367	1037  8B D8			     mov     bx,ax
   3368	1039  83 BF 001Br FF		     cmp     word ptr DGROUP:_miniSO_thread[bx+20],-1
   3369	103E  75 23			     jne     short @25@646
   3370					;
   3371					;		     miniSO_thread[pai].zombies	= miniSO_ready;
   3372					;
   3373	1040  8B C7			     mov     ax,di
   3374	1042  BA 001A			     mov     dx,26
   3375	1045  F7 EA			     imul    dx
   3376	1047  8B 16 0007r		     mov     dx,word ptr DGROUP:_miniSO_ready
   3377	104B  8B D8			     mov     bx,ax
   3378	104D  89 97 001Br		     mov     word ptr DGROUP:_miniSO_thread[bx+20],dx
   3379					;
   3380					;		     miniSO_thread[miniSO_ready].prev =	-1;
   3381					;
   3382	1051  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3383	1054  BA 001A			     mov     dx,26
   3384	1057  F7 EA			     imul    dx
   3385	1059  8B D8			     mov     bx,ax
   3386	105B  C7 87 001Dr FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+22],-1
   3387					;
   3388					;	     }
   3389					;
   3390	1061  EB 4B			     jmp     short @25@758
   3391	1063			     @25@646:
   3392					;
   3393					;	     else    {
   3394					;		     i = miniSO_thread[pai].zombies;
   3395					;
   3396	1063  8B C7			     mov     ax,di
   3397	1065  BA 001A			     mov     dx,26
   3398	1068  F7 EA			     imul    dx
   3399	106A  8B D8			     mov     bx,ax
   3400	106C  8B B7 001Br		     mov     si,word ptr DGROUP:_miniSO_thread[bx+20]
   3401	1070  EB 0D			     jmp     short @25@702
   3402	1072			     @25@674:
   3403					;
   3404					;		     while   (miniSO_thread[i].next!=-1)
   3405					;			     i = miniSO_thread[i].next;
   3406					;
   3407	1072  8B C6			     mov     ax,si
   3408	1074  BA 001A			     mov     dx,26
   3409	1077  F7 EA			     imul    dx
   3410	1079  8B D8			     mov     bx,ax
   3411	107B  8B B7 001Fr		     mov     si,word ptr DGROUP:_miniSO_thread[bx+24]
   3412	107F			     @25@702:
   3413	107F  8B C6			     mov     ax,si
   3414	1081  BA 001A			     mov     dx,26
   3415	1084  F7 EA			     imul    dx
   3416	1086  8B D8			     mov     bx,ax
   3417	1088  83 BF 001Fr FF		     cmp     word ptr DGROUP:_miniSO_thread[bx+24],-1
   3418	108D  75 E3			     jne     short @25@674
   3419					;
   3420					;		     miniSO_thread[i].next = miniSO_ready;
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 61
scall.ASM



   3421					;
   3422	108F  8B C6			     mov     ax,si
   3423	1091  BA 001A			     mov     dx,26
   3424	1094  F7 EA			     imul    dx
   3425	1096  8B 16 0007r		     mov     dx,word ptr DGROUP:_miniSO_ready
   3426	109A  8B D8			     mov     bx,ax
   3427	109C  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   3428					;
   3429					;		     miniSO_thread[miniSO_ready].prev =	i;
   3430					;
   3431	10A0  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3432	10A3  BA 001A			     mov     dx,26
   3433	10A6  F7 EA			     imul    dx
   3434	10A8  8B D8			     mov     bx,ax
   3435	10AA  89 B7 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],si
   3436	10AE			     @25@758:
   3437					;
   3438					;	     }
   3439					;	     miniSO_thread[miniSO_ready].next =	-1;
   3440					;
   3441	10AE  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3442	10B1  BA 001A			     mov     dx,26
   3443	10B4  F7 EA			     imul    dx
   3444	10B6  8B D8			     mov     bx,ax
   3445	10B8  C7 87 001Fr FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+24],-1
   3446					;
   3447					;	     miniSO_thread[miniSO_ready].status	= ZOMBIE;
   3448					;
   3449	10BE  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3450	10C1  BA 001A			     mov     dx,26
   3451	10C4  F7 EA			     imul    dx
   3452	10C6  8B D8			     mov     bx,ax
   3453	10C8  C7 87 000Br 0002		     mov     word ptr DGROUP:_miniSO_thread[bx+4],2
   3454					;
   3455					;	     miniSO_thread[miniSO_ready].exitcode = codfim;
   3456					;
   3457	10CE  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3458	10D1  BA 001A			     mov     dx,26
   3459	10D4  F7 EA			     imul    dx
   3460	10D6  8B 56 04			     mov     dx,word ptr [bp+4]
   3461	10D9  8B D8			     mov     bx,ax
   3462	10DB  89 97 0019r		     mov     word ptr DGROUP:_miniSO_thread[bx+18],dx
   3463					;
   3464					;	     miniSO_nextthread=nextthread;
   3465					;
   3466	10DF  8B 46 FA			     mov     ax,word ptr [bp-6]
   3467	10E2  A3 0004r			     mov     word ptr DGROUP:_miniSO_nextthread,ax
   3468					;
   3469					;	     miniSO_delcurthread=1;
   3470					;
   3471	10E5  C6 06 0006r 01		     mov     byte ptr DGROUP:_miniSO_delcurthread,1
   3472					;
   3473					;	     enable();
   3474					;
   3475	10EA  E8 0000e			     call    near ptr _enable
   3476	10ED			     @25@786:
   3477	10ED  EB FE			     jmp     short @25@786
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 62
scall.ASM



   3478					;
   3479					;	     while   (1)
   3480					;		     ;
   3481					;    }
   3482					;
   3483	10EF  5F			     pop     di
   3484	10F0  5E			     pop     si
   3485	10F1  8B E5			     mov     sp,bp
   3486	10F3  5D			     pop     bp
   3487	10F4  C3			     ret
   3488	10F5			     _sc_exit	     endp
   3489					;
   3490					;    pid_t sc_getpid()
   3491					;
   3492					     assume  cs:_TEXT
   3493	10F5			     _sc_getpid	     proc    near
   3494	10F5  55			     push    bp
   3495	10F6  8B EC			     mov     bp,sp
   3496					;
   3497					;    {
   3498					;	     return miniSO_thread[miniSO_ready].pid;
   3499					;
   3500	10F8  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3501	10FB  BA 001A			     mov     dx,26
   3502	10FE  F7 EA			     imul    dx
   3503	1100  8B D8			     mov     bx,ax
   3504	1102  8B 87 0007r		     mov     ax,word ptr DGROUP:_miniSO_thread[bx]
   3505	1106  EB 00			     jmp     short @26@58
   3506	1108			     @26@58:
   3507					;
   3508					;    }
   3509					;
   3510	1108  5D			     pop     bp
   3511	1109  C3			     ret
   3512	110A			     _sc_getpid	     endp
   3513					;
   3514					;    pid_t sc_getppid()
   3515					;
   3516					     assume  cs:_TEXT
   3517	110A			     _sc_getppid     proc    near
   3518	110A  55			     push    bp
   3519	110B  8B EC			     mov     bp,sp
   3520					;
   3521					;    {
   3522					;	     return miniSO_thread[miniSO_ready].ppid;
   3523					;
   3524	110D  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3525	1110  BA 001A			     mov     dx,26
   3526	1113  F7 EA			     imul    dx
   3527	1115  8B D8			     mov     bx,ax
   3528	1117  8B 87 0009r		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+2]
   3529	111B  EB 00			     jmp     short @27@58
   3530	111D			     @27@58:
   3531					;
   3532					;    }
   3533					;
   3534	111D  5D			     pop     bp
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 63
scall.ASM



   3535	111E  C3			     ret
   3536	111F			     _sc_getppid     endp
   3537					;
   3538					;    int sc_sendsignal(pid_t pid, signal_t signal)
   3539					;
   3540					     assume  cs:_TEXT
   3541	111F			     _sc_sendsignal  proc    near
   3542	111F  55			     push    bp
   3543	1120  8B EC			     mov     bp,sp
   3544	1122  56			     push    si
   3545	1123  57			     push    di
   3546					;
   3547					;    {
   3548					;	     pcb_t   pcb,last;
   3549					;
   3550					;	     disable();
   3551					;
   3552	1124  E8 0000e			     call    near ptr _disable
   3553					;
   3554					;	     /*	Tem que	verificar se existe a thread */
   3555					;	     pcb = get_pcb(pid);
   3556					;
   3557	1127  FF 76 04			     push    word ptr [bp+4]
   3558	112A  E8 F355			     call    near ptr get_pcb
   3559	112D  59			     pop     cx
   3560	112E  8B F0			     mov     si,ax
   3561					;
   3562					;	     /*	Se nao existe uma thread com este numero, entao	retorna	*/
   3563					;	     if	     (pcb==-1)	{
   3564					;
   3565	1130  83 FE FF			     cmp     si,-1
   3566	1133  75 09			     jne     short @28@114
   3567					;
   3568					;		     enable();
   3569					;
   3570	1135  E8 0000e			     call    near ptr _enable
   3571					;
   3572					;		     return miniSO_ERROR;
   3573					;
   3574	1138  B8 FFFF			     mov     ax,-1
   3575	113B			     @28@86:
   3576	113B  E9 00DD			     jmp     @28@226
   3577	113E			     @28@114:
   3578					;
   3579					;	     }
   3580					;	     /*	Seta os	sinais recebidos */
   3581					;	     miniSO_thread[pcb].recvsig	|= signal;
   3582					;
   3583	113E  8B C6			     mov     ax,si
   3584	1140  BA 001A			     mov     dx,26
   3585	1143  F7 EA			     imul    dx
   3586	1145  8B 56 06			     mov     dx,word ptr [bp+6]
   3587	1148  8B D8			     mov     bx,ax
   3588	114A  09 97 0011r		     or	     word ptr DGROUP:_miniSO_thread[bx+10],dx
   3589					;
   3590					;	     /*	A thread pode estar esperando pelos sinais ou nao */
   3591					;	     if	     (miniSO_thread[pcb].status	== WAITSIG)  {
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 64
scall.ASM



   3592					;
   3593	114E  8B C6			     mov     ax,si
   3594	1150  BA 001A			     mov     dx,26
   3595	1153  F7 EA			     imul    dx
   3596	1155  8B D8			     mov     bx,ax
   3597	1157  83 BF 000Br 04		     cmp     word ptr DGROUP:_miniSO_thread[bx+4],4
   3598	115C  74 03			     je	     @@6
   3599	115E  E9 00B1			     jmp     @28@198
   3600	1161			     @@6:
   3601					;
   3602					;		     /*	Verifica se a thread estava esperando pelo sinal */
   3603					;		     if	     ( (miniSO_thread[pcb].recvsig & miniSO_thread[pcb].waitsig) == +
   3604				     miniSO_thread[pcb].waitsig	)  {
   3605					;
   3606	1161  8B C6			     mov     ax,si
   3607	1163  BA 001A			     mov     dx,26
   3608	1166  F7 EA			     imul    dx
   3609	1168  8B D8			     mov     bx,ax
   3610	116A  8B 87 0011r		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+10]
   3611	116E  50			     push    ax
   3612	116F  8B C6			     mov     ax,si
   3613	1171  BA 001A			     mov     dx,26
   3614	1174  F7 EA			     imul    dx
   3615	1176  8B D8			     mov     bx,ax
   3616	1178  58			     pop     ax
   3617	1179  23 87 0013r		     and     ax,word ptr DGROUP:_miniSO_thread[bx+12]
   3618	117D  50			     push    ax
   3619	117E  8B C6			     mov     ax,si
   3620	1180  BA 001A			     mov     dx,26
   3621	1183  F7 EA			     imul    dx
   3622	1185  8B D8			     mov     bx,ax
   3623	1187  58			     pop     ax
   3624	1188  3B 87 0013r		     cmp     ax,word ptr DGROUP:_miniSO_thread[bx+12]
   3625	118C  74 03			     je	     @@7
   3626	118E  E9 0081			     jmp     @28@198
   3627	1191			     @@7:
   3628					;
   3629					;			     /*	O sinal	recebido e' suficiente para tirar a thread da espera+
   3630				     */
   3631					;			     last = miniSO_thread[miniSO_ready].prev;
   3632					;
   3633	1191  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3634	1194  BA 001A			     mov     dx,26
   3635	1197  F7 EA			     imul    dx
   3636	1199  8B D8			     mov     bx,ax
   3637	119B  8B BF 001Dr		     mov     di,word ptr DGROUP:_miniSO_thread[bx+22]
   3638					;
   3639					;			     miniSO_thread[pcb].prev = last;
   3640					;
   3641	119F  8B C6			     mov     ax,si
   3642	11A1  BA 001A			     mov     dx,26
   3643	11A4  F7 EA			     imul    dx
   3644	11A6  8B D8			     mov     bx,ax
   3645	11A8  89 BF 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],di
   3646					;
   3647					;			     miniSO_thread[last].next=pcb;
   3648					;
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 65
scall.ASM



   3649	11AC  8B C7			     mov     ax,di
   3650	11AE  BA 001A			     mov     dx,26
   3651	11B1  F7 EA			     imul    dx
   3652	11B3  8B D8			     mov     bx,ax
   3653	11B5  89 B7 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],si
   3654					;
   3655					;			     miniSO_thread[miniSO_ready].prev=pcb;
   3656					;
   3657	11B9  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3658	11BC  BA 001A			     mov     dx,26
   3659	11BF  F7 EA			     imul    dx
   3660	11C1  8B D8			     mov     bx,ax
   3661	11C3  89 B7 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],si
   3662					;
   3663					;			     miniSO_thread[pcb].next=miniSO_ready;
   3664					;
   3665	11C7  8B C6			     mov     ax,si
   3666	11C9  BA 001A			     mov     dx,26
   3667	11CC  F7 EA			     imul    dx
   3668	11CE  8B 16 0007r		     mov     dx,word ptr DGROUP:_miniSO_ready
   3669	11D2  8B D8			     mov     bx,ax
   3670	11D4  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   3671					;
   3672					;			     miniSO_thread[pcb].status = READY;
   3673					;
   3674	11D8  8B C6			     mov     ax,si
   3675	11DA  BA 001A			     mov     dx,26
   3676	11DD  F7 EA			     imul    dx
   3677	11DF  8B D8			     mov     bx,ax
   3678	11E1  C7 87 000Br 0000		     mov     word ptr DGROUP:_miniSO_thread[bx+4],0
   3679					;
   3680					;			     /*	Seta sinais recebidos e	sinais esperados */
   3681					;			     miniSO_thread[pcb].recvsig	^= miniSO_thread[pcb].waitsig;
   3682					;
   3683	11E7  8B C6			     mov     ax,si
   3684	11E9  BA 001A			     mov     dx,26
   3685	11EC  F7 EA			     imul    dx
   3686	11EE  8B D8			     mov     bx,ax
   3687	11F0  8B 87 0013r		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+12]
   3688	11F4  50			     push    ax
   3689	11F5  8B C6			     mov     ax,si
   3690	11F7  BA 001A			     mov     dx,26
   3691	11FA  F7 EA			     imul    dx
   3692	11FC  8B D8			     mov     bx,ax
   3693	11FE  58			     pop     ax
   3694	11FF  31 87 0011r		     xor     word ptr DGROUP:_miniSO_thread[bx+10],ax
   3695					;
   3696					;			     miniSO_thread[pcb].waitsig	= 0;
   3697					;
   3698	1203  8B C6			     mov     ax,si
   3699	1205  BA 001A			     mov     dx,26
   3700	1208  F7 EA			     imul    dx
   3701	120A  8B D8			     mov     bx,ax
   3702	120C  C7 87 0013r 0000		     mov     word ptr DGROUP:_miniSO_thread[bx+12],0
   3703	1212			     @28@198:
   3704					;
   3705					;		     }
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 66
scall.ASM



   3706					;	     }
   3707					;	     enable();
   3708					;
   3709	1212  E8 0000e			     call    near ptr _enable
   3710					;
   3711					;	     return miniSO_OK;
   3712					;
   3713	1215  B8 0001			     mov     ax,1
   3714	1218  E9 FF20			     jmp     @28@86
   3715	121B			     @28@226:
   3716					;
   3717					;    }
   3718					;
   3719	121B  5F			     pop     di
   3720	121C  5E			     pop     si
   3721	121D  5D			     pop     bp
   3722	121E  C3			     ret
   3723	121F			     _sc_sendsignal  endp
   3724					;
   3725					;    int sc_waitsignal(signal_t	signal)
   3726					;
   3727					     assume  cs:_TEXT
   3728	121F			     _sc_waitsignal  proc    near
   3729	121F  55			     push    bp
   3730	1220  8B EC			     mov     bp,sp
   3731	1222  83 EC 06			     sub     sp,6
   3732	1225  56			     push    si
   3733	1226  57			     push    di
   3734	1227  8B 7E 04			     mov     di,word ptr [bp+4]
   3735					;
   3736					;    {
   3737					;	     pcb_t   pcb,prevthread,nextthread;
   3738					;	     int     waitint=0;
   3739					;
   3740	122A  C7 46 FA 0000		     mov     word ptr [bp-6],0
   3741					;
   3742					;
   3743					;	     disable();
   3744					;
   3745	122F  E8 0000e			     call    near ptr _disable
   3746					;
   3747					;	     pcb = miniSO_ready;
   3748					;
   3749	1232  8B 36 0007r		     mov     si,word ptr DGROUP:_miniSO_ready
   3750					;
   3751					;	     /*	Verifica se ja'	nao recebeu os sinais */
   3752					;	     if	     ( (miniSO_thread[pcb].recvsig & signal) ==	signal )  {
   3753					;
   3754	1236  8B C6			     mov     ax,si
   3755	1238  BA 001A			     mov     dx,26
   3756	123B  F7 EA			     imul    dx
   3757	123D  8B D8			     mov     bx,ax
   3758	123F  8B 87 0011r		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+10]
   3759	1243  23 C7			     and     ax,di
   3760	1245  3B C7			     cmp     ax,di
   3761	1247  75 1F			     jne     short @29@86
   3762					;
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 67
scall.ASM



   3763					;		     /*	Ele ja'	recebeu	os sinais */
   3764					;		     miniSO_thread[pcb].recvsig	^= signal;
   3765					;
   3766	1249  8B C6			     mov     ax,si
   3767	124B  BA 001A			     mov     dx,26
   3768	124E  F7 EA			     imul    dx
   3769	1250  8B D8			     mov     bx,ax
   3770	1252  31 BF 0011r		     xor     word ptr DGROUP:_miniSO_thread[bx+10],di
   3771					;
   3772					;		     miniSO_thread[pcb].waitsig	= 0;
   3773					;
   3774	1256  8B C6			     mov     ax,si
   3775	1258  BA 001A			     mov     dx,26
   3776	125B  F7 EA			     imul    dx
   3777	125D  8B D8			     mov     bx,ax
   3778	125F  C7 87 0013r 0000		     mov     word ptr DGROUP:_miniSO_thread[bx+12],0
   3779					;
   3780					;	     }
   3781					;
   3782	1265  E9 0094			     jmp     @29@170
   3783	1268			     @29@86:
   3784					;
   3785					;	     else    {
   3786					;		     /*	Ele ainda nao recebeu os sinais	e vai para a lista de espera */
   3787					;		     miniSO_thread[pcb].waitsig	= signal;
   3788					;
   3789	1268  8B C6			     mov     ax,si
   3790	126A  BA 001A			     mov     dx,26
   3791	126D  F7 EA			     imul    dx
   3792	126F  8B D8			     mov     bx,ax
   3793	1271  89 BF 0013r		     mov     word ptr DGROUP:_miniSO_thread[bx+12],di
   3794					;
   3795					;		     /*	Se eh a	ultima thread ... */
   3796					;		     prevthread	= miniSO_thread[pcb].prev;
   3797					;
   3798	1275  8B C6			     mov     ax,si
   3799	1277  BA 001A			     mov     dx,26
   3800	127A  F7 EA			     imul    dx
   3801	127C  8B D8			     mov     bx,ax
   3802	127E  8B 87 001Dr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+22]
   3803	1282  89 46 FE			     mov     word ptr [bp-2],ax
   3804					;
   3805					;		     nextthread	= miniSO_thread[pcb].next;
   3806					;
   3807	1285  8B C6			     mov     ax,si
   3808	1287  BA 001A			     mov     dx,26
   3809	128A  F7 EA			     imul    dx
   3810	128C  8B D8			     mov     bx,ax
   3811	128E  8B 87 001Fr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+24]
   3812	1292  89 46 FC			     mov     word ptr [bp-4],ax
   3813					;
   3814					;		     if	     (pcb == nextthread)
   3815					;
   3816	1295  3B 76 FC			     cmp     si,word ptr [bp-4]
   3817	1298  75 08			     jne     short @29@142
   3818					;
   3819					;			     end_mso("waitsignal(): nao	ha' mais threads executando!");
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 68
scall.ASM



   3820					;
   3821	129A  B8 01B7r			     mov     ax,offset DGROUP:s@+291
   3822	129D  50			     push    ax
   3823	129E  E8 F19C			     call    near ptr end_mso
   3824	12A1  59			     pop     cx
   3825	12A2			     @29@142:
   3826					;
   3827					;		     /*	Retira o BCP da	thread corrente	da lista de prontos */
   3828					;		     miniSO_thread[pcb].next = -1;
   3829					;
   3830	12A2  8B C6			     mov     ax,si
   3831	12A4  BA 001A			     mov     dx,26
   3832	12A7  F7 EA			     imul    dx
   3833	12A9  8B D8			     mov     bx,ax
   3834	12AB  C7 87 001Fr FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+24],-1
   3835					;
   3836					;		     miniSO_thread[pcb].prev  =	-1;
   3837					;
   3838	12B1  8B C6			     mov     ax,si
   3839	12B3  BA 001A			     mov     dx,26
   3840	12B6  F7 EA			     imul    dx
   3841	12B8  8B D8			     mov     bx,ax
   3842	12BA  C7 87 001Dr FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+22],-1
   3843					;
   3844					;		     /*	Exclui o nodo da lista de prontos */
   3845					;		     miniSO_thread[prevthread].next=nextthread;
   3846					;
   3847	12C0  8B 46 FE			     mov     ax,word ptr [bp-2]
   3848	12C3  BA 001A			     mov     dx,26
   3849	12C6  F7 EA			     imul    dx
   3850	12C8  8B 56 FC			     mov     dx,word ptr [bp-4]
   3851	12CB  8B D8			     mov     bx,ax
   3852	12CD  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   3853					;
   3854					;		     miniSO_thread[nextthread].prev=prevthread;
   3855					;
   3856	12D1  8B 46 FC			     mov     ax,word ptr [bp-4]
   3857	12D4  BA 001A			     mov     dx,26
   3858	12D7  F7 EA			     imul    dx
   3859	12D9  8B 56 FE			     mov     dx,word ptr [bp-2]
   3860	12DC  8B D8			     mov     bx,ax
   3861	12DE  89 97 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],dx
   3862					;
   3863					;		     miniSO_thread[pcb].status = WAITSIG;
   3864					;
   3865	12E2  8B C6			     mov     ax,si
   3866	12E4  BA 001A			     mov     dx,26
   3867	12E7  F7 EA			     imul    dx
   3868	12E9  8B D8			     mov     bx,ax
   3869	12EB  C7 87 000Br 0004		     mov     word ptr DGROUP:_miniSO_thread[bx+4],4
   3870					;
   3871					;		     miniSO_nextthread=nextthread;
   3872					;
   3873	12F1  8B 46 FC			     mov     ax,word ptr [bp-4]
   3874	12F4  A3 0004r			     mov     word ptr DGROUP:_miniSO_nextthread,ax
   3875					;
   3876					;		     waitint=1;
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 69
scall.ASM



   3877					;
   3878	12F7  C7 46 FA 0001		     mov     word ptr [bp-6],1
   3879	12FC			     @29@170:
   3880					;
   3881					;	     }
   3882					;	     enable();
   3883					;
   3884	12FC  E8 0000e			     call    near ptr _enable
   3885					;
   3886					;	     if	     (waitint)
   3887					;
   3888	12FF  83 7E FA 00		     cmp     word ptr [bp-6],0
   3889	1303  74 12			     je	     short @29@254
   3890	1305  EB 00			     jmp     short @29@226
   3891	1307			     @29@226:
   3892					;
   3893					;		     while   (miniSO_thread[pcb].status	== WAITSIG)
   3894					;
   3895	1307  8B C6			     mov     ax,si
   3896	1309  BA 001A			     mov     dx,26
   3897	130C  F7 EA			     imul    dx
   3898	130E  8B D8			     mov     bx,ax
   3899	1310  83 BF 000Br 04		     cmp     word ptr DGROUP:_miniSO_thread[bx+4],4
   3900	1315  74 F0			     je	     short @29@226
   3901	1317			     @29@254:
   3902					;
   3903					;			     ;
   3904					;	     return 0;
   3905					;
   3906	1317  33 C0			     xor     ax,ax
   3907	1319  EB 00			     jmp     short @29@282
   3908	131B			     @29@282:
   3909					;
   3910					;    }
   3911					;
   3912	131B  5F			     pop     di
   3913	131C  5E			     pop     si
   3914	131D  8B E5			     mov     sp,bp
   3915	131F  5D			     pop     bp
   3916	1320  C3			     ret
   3917	1321			     _sc_waitsignal  endp
   3918					;
   3919					;    static int	get_sem_pos(semid_t s)
   3920					;
   3921					     assume  cs:_TEXT
   3922	1321			     get_sem_pos     proc    near
   3923	1321  55			     push    bp
   3924	1322  8B EC			     mov     bp,sp
   3925					;
   3926					;    {
   3927					;	     int i;
   3928					;
   3929					;	     for     (i=0;i<miniSO_MAXSEMAPHORES;++i)
   3930					;
   3931	1324  33 D2			     xor     dx,dx
   3932	1326  EB 21			     jmp     short @30@198
   3933	1328			     @30@58:
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 70
scall.ASM



   3934					;
   3935					;		     if	     (miniSO_sem[i].status!=FREE && miniSO_sem[i].semid==s)
   3936					;
   3937	1328  8B DA			     mov     bx,dx
   3938	132A  B1 03			     mov     cl,3
   3939	132C  D3 E3			     shl     bx,cl
   3940	132E  83 BF 01A7r FF		     cmp     word ptr DGROUP:_miniSO_sem[bx],-1
   3941	1333  74 13			     je	     short @30@170
   3942	1335  8B DA			     mov     bx,dx
   3943	1337  B1 03			     mov     cl,3
   3944	1339  D3 E3			     shl     bx,cl
   3945	133B  8B 87 01A9r		     mov     ax,word ptr DGROUP:_miniSO_sem[bx+2]
   3946	133F  3B 46 04			     cmp     ax,word ptr [bp+4]
   3947	1342  75 04			     jne     short @30@170
   3948					;
   3949					;			     return i;
   3950					;
   3951	1344  8B C2			     mov     ax,dx
   3952	1346			     @30@142:
   3953	1346  EB 0B			     jmp     short @30@254
   3954	1348			     @30@170:
   3955	1348  42			     inc     dx
   3956	1349			     @30@198:
   3957	1349  83 FA 0A			     cmp     dx,10
   3958	134C  7C DA			     jl	     short @30@58
   3959					;
   3960					;	     return miniSO_ERROR;
   3961					;
   3962	134E  B8 FFFF			     mov     ax,-1
   3963	1351  EB F3			     jmp     short @30@142
   3964	1353			     @30@254:
   3965					;
   3966					;    }
   3967					;
   3968	1353  5D			     pop     bp
   3969	1354  C3			     ret
   3970	1355			     get_sem_pos     endp
   3971					;
   3972					;    semid_t sc_semcreate (int value)
   3973					;
   3974					     assume  cs:_TEXT
   3975	1355			     _sc_semcreate   proc    near
   3976	1355  55			     push    bp
   3977	1356  8B EC			     mov     bp,sp
   3978	1358  56			     push    si
   3979					;
   3980					;    {
   3981					;	     int i;
   3982					;	     semid_t s;
   3983					;
   3984					;	     for     (i=0;i<miniSO_MAXSEMAPHORES;++i)
   3985					;
   3986	1359  33 F6			     xor     si,si
   3987	135B  EB 74 90			     jmp     @31@310
   3988	135E			     @31@58:
   3989					;
   3990					;		     if	     (miniSO_sem[i].status==FREE) {
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 71
scall.ASM



   3991					;
   3992	135E  8B DE			     mov     bx,si
   3993	1360  B1 03			     mov     cl,3
   3994	1362  D3 E3			     shl     bx,cl
   3995	1364  83 BF 01A7r FF		     cmp     word ptr DGROUP:_miniSO_sem[bx],-1
   3996	1369  75 65			     jne     short @31@282
   3997	136B  EB 14			     jmp     short @31@198
   3998	136D			     @31@114:
   3999					;
   4000					;			     /*	Gera um	semid */
   4001					;			     while   (get_sem_pos(nextsemid)!=miniSO_ERROR) {
   4002					;				     if	     (nextsemid==32767)
   4003					;
   4004	136D  81 3E 0005r 7FFF		     cmp     word ptr DGROUP:nextsemid,32767
   4005	1373  75 08			     jne     short @31@170
   4006					;
   4007					;					     nextsemid = 0;
   4008					;
   4009	1375  C7 06 0005r 0000		     mov     word ptr DGROUP:nextsemid,0
   4010	137B  EB 04			     jmp     short @31@198
   4011	137D			     @31@170:
   4012					;
   4013					;				     else
   4014					;					     nextsemid++;
   4015					;
   4016	137D  FF 06 0005r		     inc     word ptr DGROUP:nextsemid
   4017	1381			     @31@198:
   4018	1381  FF 36 0005r		     push    word ptr DGROUP:nextsemid
   4019	1385  E8 FF99			     call    near ptr get_sem_pos
   4020	1388  59			     pop     cx
   4021	1389  3D FFFF			     cmp     ax,-1
   4022	138C  75 DF			     jne     short @31@114
   4023					;
   4024					;			     }
   4025					;			     miniSO_sem[i].status=READY;
   4026					;
   4027	138E  8B DE			     mov     bx,si
   4028	1390  B1 03			     mov     cl,3
   4029	1392  D3 E3			     shl     bx,cl
   4030	1394  C7 87 01A7r 0000		     mov     word ptr DGROUP:_miniSO_sem[bx],0
   4031					;
   4032					;			     miniSO_sem[i].semid=nextsemid++;
   4033					;
   4034	139A  8B DE			     mov     bx,si
   4035	139C  B1 03			     mov     cl,3
   4036	139E  D3 E3			     shl     bx,cl
   4037	13A0  A1 0005r			     mov     ax,word ptr DGROUP:nextsemid
   4038	13A3  89 87 01A9r		     mov     word ptr DGROUP:_miniSO_sem[bx+2],ax
   4039	13A7  FF 06 0005r		     inc     word ptr DGROUP:nextsemid
   4040					;
   4041					;			     miniSO_sem[i].value=value;
   4042					;
   4043	13AB  8B DE			     mov     bx,si
   4044	13AD  B1 03			     mov     cl,3
   4045	13AF  D3 E3			     shl     bx,cl
   4046	13B1  8B 46 04			     mov     ax,word ptr [bp+4]
   4047	13B4  89 87 01ABr		     mov     word ptr DGROUP:_miniSO_sem[bx+4],ax
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 72
scall.ASM



   4048					;
   4049					;			     miniSO_sem[i].queue=-1;
   4050					;
   4051	13B8  8B DE			     mov     bx,si
   4052	13BA  B1 03			     mov     cl,3
   4053	13BC  D3 E3			     shl     bx,cl
   4054	13BE  C7 87 01ADr FFFF		     mov     word ptr DGROUP:_miniSO_sem[bx+6],-1
   4055					;
   4056					;			     return miniSO_sem[i].semid;
   4057					;
   4058	13C4  8B DE			     mov     bx,si
   4059	13C6  B1 03			     mov     cl,3
   4060	13C8  D3 E3			     shl     bx,cl
   4061	13CA  8B 87 01A9r		     mov     ax,word ptr DGROUP:_miniSO_sem[bx+2]
   4062	13CE			     @31@254:
   4063	13CE  EB 0D			     jmp     short @31@366
   4064	13D0			     @31@282:
   4065	13D0  46			     inc     si
   4066	13D1			     @31@310:
   4067	13D1  83 FE 0A			     cmp     si,10
   4068	13D4  7D 02			     jge     @@8
   4069	13D6  EB 86			     jmp     @31@58
   4070	13D8			     @@8:
   4071					;
   4072					;		     }
   4073					;	     return miniSO_ERROR;
   4074					;
   4075	13D8  B8 FFFF			     mov     ax,-1
   4076	13DB  EB F1			     jmp     short @31@254
   4077	13DD			     @31@366:
   4078					;
   4079					;    }
   4080					;
   4081	13DD  5E			     pop     si
   4082	13DE  5D			     pop     bp
   4083	13DF  C3			     ret
   4084	13E0			     _sc_semcreate   endp
   4085					;
   4086					;    int sc_semset (semid_t s,int value)
   4087					;
   4088					     assume  cs:_TEXT
   4089	13E0			     _sc_semset	     proc    near
   4090	13E0  55			     push    bp
   4091	13E1  8B EC			     mov     bp,sp
   4092	13E3  56			     push    si
   4093					;
   4094					;    {
   4095					;	     int sem;
   4096					;
   4097					;	     sem = get_sem_pos(s);
   4098					;
   4099	13E4  FF 76 04			     push    word ptr [bp+4]
   4100	13E7  E8 FF37			     call    near ptr get_sem_pos
   4101	13EA  59			     pop     cx
   4102	13EB  8B F0			     mov     si,ax
   4103					;
   4104					;	     if	     (sem==miniSO_ERROR	|| miniSO_sem[sem].queue!=-1)
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 73
scall.ASM



   4105					;
   4106	13ED  83 FE FF			     cmp     si,-1
   4107	13F0  74 0D			     je	     short @32@86
   4108	13F2  8B DE			     mov     bx,si
   4109	13F4  B1 03			     mov     cl,3
   4110	13F6  D3 E3			     shl     bx,cl
   4111	13F8  83 BF 01ADr FF		     cmp     word ptr DGROUP:_miniSO_sem[bx+6],-1
   4112	13FD  74 05			     je	     short @32@142
   4113	13FF			     @32@86:
   4114					;
   4115					;		     return miniSO_ERROR;
   4116					;
   4117	13FF  B8 FFFF			     mov     ax,-1
   4118	1402			     @32@114:
   4119	1402  EB 12			     jmp     short @32@170
   4120	1404			     @32@142:
   4121					;
   4122					;	     miniSO_sem[sem].value = value;
   4123					;
   4124	1404  8B DE			     mov     bx,si
   4125	1406  B1 03			     mov     cl,3
   4126	1408  D3 E3			     shl     bx,cl
   4127	140A  8B 46 06			     mov     ax,word ptr [bp+6]
   4128	140D  89 87 01ABr		     mov     word ptr DGROUP:_miniSO_sem[bx+4],ax
   4129					;
   4130					;	     return miniSO_OK;
   4131					;
   4132	1411  B8 0001			     mov     ax,1
   4133	1414  EB EC			     jmp     short @32@114
   4134	1416			     @32@170:
   4135					;
   4136					;    }
   4137					;
   4138	1416  5E			     pop     si
   4139	1417  5D			     pop     bp
   4140	1418  C3			     ret
   4141	1419			     _sc_semset	     endp
   4142					;
   4143					;    int sc_semup (semid_t s)
   4144					;
   4145					     assume  cs:_TEXT
   4146	1419			     _sc_semup	     proc    near
   4147	1419  55			     push    bp
   4148	141A  8B EC			     mov     bp,sp
   4149	141C  83 EC 02			     sub     sp,2
   4150	141F  56			     push    si
   4151	1420  57			     push    di
   4152					;
   4153					;    {
   4154					;	     int sem;
   4155					;	     pcb_t pcb,last,prevthread,nextthread;
   4156					;
   4157					;	     disable();
   4158					;
   4159	1421  E8 0000e			     call    near ptr _disable
   4160					;
   4161					;	     sem = get_sem_pos(s);
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 74
scall.ASM



   4162					;
   4163	1424  FF 76 04			     push    word ptr [bp+4]
   4164	1427  E8 FEF7			     call    near ptr get_sem_pos
   4165	142A  59			     pop     cx
   4166	142B  8B F0			     mov     si,ax
   4167					;
   4168					;	     if	     (sem==miniSO_ERROR) {
   4169					;
   4170	142D  83 FE FF			     cmp     si,-1
   4171	1430  75 09			     jne     short @33@114
   4172					;
   4173					;		     enable();
   4174					;
   4175	1432  E8 0000e			     call    near ptr _enable
   4176					;
   4177					;		     return miniSO_ERROR;
   4178					;
   4179	1435  B8 FFFF			     mov     ax,-1
   4180	1438			     @33@86:
   4181	1438  E9 00C5			     jmp     @33@254
   4182	143B			     @33@114:
   4183					;
   4184					;	     }
   4185					;	     miniSO_sem[sem].value++;
   4186					;
   4187	143B  8B DE			     mov     bx,si
   4188	143D  B1 03			     mov     cl,3
   4189	143F  D3 E3			     shl     bx,cl
   4190	1441  FF 87 01ABr		     inc     word ptr DGROUP:_miniSO_sem[bx+4]
   4191					;
   4192					;	     if	     (miniSO_sem[sem].queue!=-1) {
   4193					;
   4194	1445  8B DE			     mov     bx,si
   4195	1447  B1 03			     mov     cl,3
   4196	1449  D3 E3			     shl     bx,cl
   4197	144B  83 BF 01ADr FF		     cmp     word ptr DGROUP:_miniSO_sem[bx+6],-1
   4198	1450  75 03			     jne     @@9
   4199	1452  E9 00A2			     jmp     @33@226
   4200	1455			     @@9:
   4201					;
   4202					;		     pcb = miniSO_sem[sem].queue;
   4203					;
   4204	1455  8B DE			     mov     bx,si
   4205	1457  B1 03			     mov     cl,3
   4206	1459  D3 E3			     shl     bx,cl
   4207	145B  8B BF 01ADr		     mov     di,word ptr DGROUP:_miniSO_sem[bx+6]
   4208					;
   4209					;		     miniSO_sem[sem].queue = miniSO_thread[pcb].next;
   4210					;
   4211	145F  8B C7			     mov     ax,di
   4212	1461  BA 001A			     mov     dx,26
   4213	1464  F7 EA			     imul    dx
   4214	1466  8B D8			     mov     bx,ax
   4215	1468  8B 87 001Fr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+24]
   4216	146C  8B DE			     mov     bx,si
   4217	146E  B1 03			     mov     cl,3
   4218	1470  D3 E3			     shl     bx,cl
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 75
scall.ASM



   4219	1472  89 87 01ADr		     mov     word ptr DGROUP:_miniSO_sem[bx+6],ax
   4220					;
   4221					;		     if	     (miniSO_sem[sem].queue!=-1)
   4222					;
   4223	1476  8B DE			     mov     bx,si
   4224	1478  B1 03			     mov     cl,3
   4225	147A  D3 E3			     shl     bx,cl
   4226	147C  83 BF 01ADr FF		     cmp     word ptr DGROUP:_miniSO_sem[bx+6],-1
   4227	1481  74 17			     je	     short @33@198
   4228					;
   4229					;			     miniSO_thread[miniSO_sem[sem].queue].prev = -1;
   4230					;
   4231	1483  8B DE			     mov     bx,si
   4232	1485  B1 03			     mov     cl,3
   4233	1487  D3 E3			     shl     bx,cl
   4234	1489  8B 87 01ADr		     mov     ax,word ptr DGROUP:_miniSO_sem[bx+6]
   4235	148D  BA 001A			     mov     dx,26
   4236	1490  F7 EA			     imul    dx
   4237	1492  8B D8			     mov     bx,ax
   4238	1494  C7 87 001Dr FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+22],-1
   4239	149A			     @33@198:
   4240					;
   4241					;		     last = miniSO_thread[miniSO_ready].prev;
   4242					;
   4243	149A  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   4244	149D  BA 001A			     mov     dx,26
   4245	14A0  F7 EA			     imul    dx
   4246	14A2  8B D8			     mov     bx,ax
   4247	14A4  8B 87 001Dr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+22]
   4248	14A8  89 46 FE			     mov     word ptr [bp-2],ax
   4249					;
   4250					;		     miniSO_thread[pcb].prev = last;
   4251					;
   4252	14AB  8B C7			     mov     ax,di
   4253	14AD  BA 001A			     mov     dx,26
   4254	14B0  F7 EA			     imul    dx
   4255	14B2  8B 56 FE			     mov     dx,word ptr [bp-2]
   4256	14B5  8B D8			     mov     bx,ax
   4257	14B7  89 97 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],dx
   4258					;
   4259					;		     miniSO_thread[last].next=pcb;
   4260					;
   4261	14BB  8B 46 FE			     mov     ax,word ptr [bp-2]
   4262	14BE  BA 001A			     mov     dx,26
   4263	14C1  F7 EA			     imul    dx
   4264	14C3  8B D8			     mov     bx,ax
   4265	14C5  89 BF 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],di
   4266					;
   4267					;		     miniSO_thread[miniSO_ready].prev=pcb;
   4268					;
   4269	14C9  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   4270	14CC  BA 001A			     mov     dx,26
   4271	14CF  F7 EA			     imul    dx
   4272	14D1  8B D8			     mov     bx,ax
   4273	14D3  89 BF 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],di
   4274					;
   4275					;		     miniSO_thread[pcb].next=miniSO_ready;
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 76
scall.ASM



   4276					;
   4277	14D7  8B C7			     mov     ax,di
   4278	14D9  BA 001A			     mov     dx,26
   4279	14DC  F7 EA			     imul    dx
   4280	14DE  8B 16 0007r		     mov     dx,word ptr DGROUP:_miniSO_ready
   4281	14E2  8B D8			     mov     bx,ax
   4282	14E4  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   4283					;
   4284					;		     miniSO_thread[pcb].status = READY;
   4285					;
   4286	14E8  8B C7			     mov     ax,di
   4287	14EA  BA 001A			     mov     dx,26
   4288	14ED  F7 EA			     imul    dx
   4289	14EF  8B D8			     mov     bx,ax
   4290	14F1  C7 87 000Br 0000		     mov     word ptr DGROUP:_miniSO_thread[bx+4],0
   4291	14F7			     @33@226:
   4292					;
   4293					;	     }
   4294					;	     enable();
   4295					;
   4296	14F7  E8 0000e			     call    near ptr _enable
   4297					;
   4298					;	     return miniSO_OK;
   4299					;
   4300	14FA  B8 0001			     mov     ax,1
   4301	14FD  E9 FF38			     jmp     @33@86
   4302	1500			     @33@254:
   4303					;
   4304					;    }
   4305					;
   4306	1500  5F			     pop     di
   4307	1501  5E			     pop     si
   4308	1502  8B E5			     mov     sp,bp
   4309	1504  5D			     pop     bp
   4310	1505  C3			     ret
   4311	1506			     _sc_semup	     endp
   4312					;
   4313					;    int sc_semdown (semid_t s)
   4314					;
   4315					     assume  cs:_TEXT
   4316	1506			     _sc_semdown     proc    near
   4317	1506  55			     push    bp
   4318	1507  8B EC			     mov     bp,sp
   4319	1509  83 EC 08			     sub     sp,8
   4320	150C  56			     push    si
   4321	150D  57			     push    di
   4322					;
   4323					;    {
   4324					;	     int sem;
   4325					;	     pcb_t pcb,ant,i,prevthread,nextthread;
   4326					;
   4327					;	     disable();
   4328					;
   4329	150E  E8 0000e			     call    near ptr _disable
   4330					;
   4331					;	     sem = get_sem_pos(s);
   4332					;
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 77
scall.ASM



   4333	1511  FF 76 04			     push    word ptr [bp+4]
   4334	1514  E8 FE0A			     call    near ptr get_sem_pos
   4335	1517  59			     pop     cx
   4336	1518  8B F8			     mov     di,ax
   4337					;
   4338					;	     if	     (sem==miniSO_ERROR) {
   4339					;
   4340	151A  83 FF FF			     cmp     di,-1
   4341	151D  75 09			     jne     short @34@114
   4342					;
   4343					;		     enable();
   4344					;
   4345	151F  E8 0000e			     call    near ptr _enable
   4346					;
   4347					;		     return miniSO_ERROR;
   4348					;
   4349	1522  B8 FFFF			     mov     ax,-1
   4350	1525			     @34@86:
   4351	1525  E9 011E			     jmp     @34@534
   4352	1528			     @34@114:
   4353					;
   4354					;	     }
   4355					;	     miniSO_sem[sem].value--;
   4356					;
   4357	1528  8B DF			     mov     bx,di
   4358	152A  B1 03			     mov     cl,3
   4359	152C  D3 E3			     shl     bx,cl
   4360	152E  FF 8F 01ABr		     dec     word ptr DGROUP:_miniSO_sem[bx+4]
   4361					;
   4362					;	     if	     (miniSO_sem[sem].value<0) {
   4363					;
   4364	1532  8B DF			     mov     bx,di
   4365	1534  B1 03			     mov     cl,3
   4366	1536  D3 E3			     shl     bx,cl
   4367	1538  83 BF 01ABr 00		     cmp     word ptr DGROUP:_miniSO_sem[bx+4],0
   4368	153D  7C 03			     jl	     @@10
   4369	153F  E9 00FB			     jmp     @34@478
   4370	1542			     @@10:
   4371					;
   4372					;		     pcb = miniSO_ready;
   4373					;
   4374	1542  8B 36 0007r		     mov     si,word ptr DGROUP:_miniSO_ready
   4375					;
   4376					;		     prevthread	= miniSO_thread[pcb].prev;
   4377					;
   4378	1546  8B C6			     mov     ax,si
   4379	1548  BA 001A			     mov     dx,26
   4380	154B  F7 EA			     imul    dx
   4381	154D  8B D8			     mov     bx,ax
   4382	154F  8B 87 001Dr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+22]
   4383	1553  89 46 FA			     mov     word ptr [bp-6],ax
   4384					;
   4385					;		     nextthread	= miniSO_thread[pcb].next;
   4386					;
   4387	1556  8B C6			     mov     ax,si
   4388	1558  BA 001A			     mov     dx,26
   4389	155B  F7 EA			     imul    dx
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 78
scall.ASM



   4390	155D  8B D8			     mov     bx,ax
   4391	155F  8B 87 001Fr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+24]
   4392	1563  89 46 F8			     mov     word ptr [bp-8],ax
   4393					;
   4394					;		     /*	Se eh a	ultima thread ... */
   4395					;		     if	     (pcb == nextthread)
   4396					;
   4397	1566  3B 76 F8			     cmp     si,word ptr [bp-8]
   4398	1569  75 08			     jne     short @34@198
   4399					;
   4400					;			     end_mso("semdown(): nao ha' mais threads executando!");
   4401					;
   4402	156B  B8 01E6r			     mov     ax,offset DGROUP:s@+338
   4403	156E  50			     push    ax
   4404	156F  E8 EECB			     call    near ptr end_mso
   4405	1572  59			     pop     cx
   4406	1573			     @34@198:
   4407					;
   4408					;		     /*	Coloca o BCP da	thread no final	da lista de espera do semaforo */
   4409					;		     ant = -1;
   4410					;
   4411	1573  C7 46 FE FFFF		     mov     word ptr [bp-2],-1
   4412					;
   4413					;		     i = miniSO_sem[sem].queue;
   4414					;
   4415	1578  8B DF			     mov     bx,di
   4416	157A  B1 03			     mov     cl,3
   4417	157C  D3 E3			     shl     bx,cl
   4418	157E  8B 87 01ADr		     mov     ax,word ptr DGROUP:_miniSO_sem[bx+6]
   4419	1582  EB 14			     jmp     short @34@254
   4420	1584			     @34@226:
   4421					;
   4422					;		     while   (i!=-1) {
   4423					;			     ant = i;
   4424					;
   4425	1584  8B 46 FC			     mov     ax,word ptr [bp-4]
   4426	1587  89 46 FE			     mov     word ptr [bp-2],ax
   4427					;
   4428					;			     i = miniSO_thread[i].next;
   4429					;
   4430	158A  8B 46 FC			     mov     ax,word ptr [bp-4]
   4431	158D  BA 001A			     mov     dx,26
   4432	1590  F7 EA			     imul    dx
   4433	1592  8B D8			     mov     bx,ax
   4434	1594  8B 87 001Fr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+24]
   4435	1598			     @34@254:
   4436	1598  89 46 FC			     mov     word ptr [bp-4],ax
   4437	159B  83 7E FC FF		     cmp     word ptr [bp-4],-1
   4438	159F  75 E3			     jne     short @34@226
   4439					;
   4440					;		     }
   4441					;		     if	     (ant==-1) {
   4442					;
   4443	15A1  83 7E FE FF		     cmp     word ptr [bp-2],-1
   4444	15A5  75 1B			     jne     short @34@366
   4445					;
   4446					;			     miniSO_sem[sem].queue = pcb;
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 79
scall.ASM



   4447					;
   4448	15A7  8B DF			     mov     bx,di
   4449	15A9  B1 03			     mov     cl,3
   4450	15AB  D3 E3			     shl     bx,cl
   4451	15AD  89 B7 01ADr		     mov     word ptr DGROUP:_miniSO_sem[bx+6],si
   4452					;
   4453					;			     miniSO_thread[pcb].prev = -1;
   4454					;
   4455	15B1  8B C6			     mov     ax,si
   4456	15B3  BA 001A			     mov     dx,26
   4457	15B6  F7 EA			     imul    dx
   4458	15B8  8B D8			     mov     bx,ax
   4459	15BA  C7 87 001Dr FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+22],-1
   4460					;
   4461					;		     }
   4462					;
   4463	15C0  EB 1E			     jmp     short @34@394
   4464	15C2			     @34@366:
   4465					;
   4466					;		     else {
   4467					;			     miniSO_thread[ant].next = pcb;
   4468					;
   4469	15C2  8B 46 FE			     mov     ax,word ptr [bp-2]
   4470	15C5  BA 001A			     mov     dx,26
   4471	15C8  F7 EA			     imul    dx
   4472	15CA  8B D8			     mov     bx,ax
   4473	15CC  89 B7 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],si
   4474					;
   4475					;			     miniSO_thread[pcb].prev = ant;
   4476					;
   4477	15D0  8B C6			     mov     ax,si
   4478	15D2  BA 001A			     mov     dx,26
   4479	15D5  F7 EA			     imul    dx
   4480	15D7  8B 56 FE			     mov     dx,word ptr [bp-2]
   4481	15DA  8B D8			     mov     bx,ax
   4482	15DC  89 97 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],dx
   4483	15E0			     @34@394:
   4484					;
   4485					;		     }
   4486					;		     miniSO_thread[pcb].next = -1;
   4487					;
   4488	15E0  8B C6			     mov     ax,si
   4489	15E2  BA 001A			     mov     dx,26
   4490	15E5  F7 EA			     imul    dx
   4491	15E7  8B D8			     mov     bx,ax
   4492	15E9  C7 87 001Fr FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+24],-1
   4493					;
   4494					;		     /*	Exclui o nodo da lista de prontos */
   4495					;		     miniSO_thread[prevthread].next=nextthread;
   4496					;
   4497	15EF  8B 46 FA			     mov     ax,word ptr [bp-6]
   4498	15F2  BA 001A			     mov     dx,26
   4499	15F5  F7 EA			     imul    dx
   4500	15F7  8B 56 F8			     mov     dx,word ptr [bp-8]
   4501	15FA  8B D8			     mov     bx,ax
   4502	15FC  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   4503					;
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 80
scall.ASM



   4504					;		     miniSO_thread[nextthread].prev=prevthread;
   4505					;
   4506	1600  8B 46 F8			     mov     ax,word ptr [bp-8]
   4507	1603  BA 001A			     mov     dx,26
   4508	1606  F7 EA			     imul    dx
   4509	1608  8B 56 FA			     mov     dx,word ptr [bp-6]
   4510	160B  8B D8			     mov     bx,ax
   4511	160D  89 97 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],dx
   4512					;
   4513					;		     miniSO_thread[pcb].status = WAITSEM;
   4514					;
   4515	1611  8B C6			     mov     ax,si
   4516	1613  BA 001A			     mov     dx,26
   4517	1616  F7 EA			     imul    dx
   4518	1618  8B D8			     mov     bx,ax
   4519	161A  C7 87 000Br 0005		     mov     word ptr DGROUP:_miniSO_thread[bx+4],5
   4520					;
   4521					;		     miniSO_nextthread=nextthread;
   4522					;
   4523	1620  8B 46 F8			     mov     ax,word ptr [bp-8]
   4524	1623  A3 0004r			     mov     word ptr DGROUP:_miniSO_nextthread,ax
   4525					;
   4526					;		     enable();
   4527					;
   4528	1626  E8 0000e			     call    near ptr _enable
   4529	1629  EB 00			     jmp     short @34@422
   4530	162B			     @34@422:
   4531					;
   4532					;		     while   (miniSO_thread[pcb].status	== WAITSEM)
   4533					;
   4534	162B  8B C6			     mov     ax,si
   4535	162D  BA 001A			     mov     dx,26
   4536	1630  F7 EA			     imul    dx
   4537	1632  8B D8			     mov     bx,ax
   4538	1634  83 BF 000Br 05		     cmp     word ptr DGROUP:_miniSO_thread[bx+4],5
   4539	1639  74 F0			     je	     short @34@422
   4540					;
   4541					;			     ;
   4542					;	     }
   4543					;
   4544	163B  EB 03			     jmp     short @34@506
   4545	163D			     @34@478:
   4546					;
   4547					;	     else
   4548					;		     enable();
   4549					;
   4550	163D  E8 0000e			     call    near ptr _enable
   4551	1640			     @34@506:
   4552					;
   4553					;	     return miniSO_OK;
   4554					;
   4555	1640  B8 0001			     mov     ax,1
   4556	1643  E9 FEDF			     jmp     @34@86
   4557	1646			     @34@534:
   4558					;
   4559					;    }
   4560					;
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 81
scall.ASM



   4561	1646  5F			     pop     di
   4562	1647  5E			     pop     si
   4563	1648  8B E5			     mov     sp,bp
   4564	164A  5D			     pop     bp
   4565	164B  C3			     ret
   4566	164C			     _sc_semdown     endp
   4567					;
   4568					;    int sc_semdestroy (semid_t	s)
   4569					;
   4570					     assume  cs:_TEXT
   4571	164C			     _sc_semdestroy  proc    near
   4572	164C  55			     push    bp
   4573	164D  8B EC			     mov     bp,sp
   4574	164F  56			     push    si
   4575					;
   4576					;    {
   4577					;	     int sem;
   4578					;
   4579					;	     sem = get_sem_pos(s);
   4580					;
   4581	1650  FF 76 04			     push    word ptr [bp+4]
   4582	1653  E8 FCCB			     call    near ptr get_sem_pos
   4583	1656  59			     pop     cx
   4584	1657  8B F0			     mov     si,ax
   4585					;
   4586					;	     if	     (sem==miniSO_ERROR	|| miniSO_sem[sem].queue!=-1)
   4587					;
   4588	1659  83 FE FF			     cmp     si,-1
   4589	165C  74 0D			     je	     short @35@86
   4590	165E  8B DE			     mov     bx,si
   4591	1660  B1 03			     mov     cl,3
   4592	1662  D3 E3			     shl     bx,cl
   4593	1664  83 BF 01ADr FF		     cmp     word ptr DGROUP:_miniSO_sem[bx+6],-1
   4594	1669  74 05			     je	     short @35@142
   4595	166B			     @35@86:
   4596					;
   4597					;		     return miniSO_ERROR;
   4598					;
   4599	166B  B8 FFFF			     mov     ax,-1
   4600	166E			     @35@114:
   4601	166E  EB 11			     jmp     short @35@170
   4602	1670			     @35@142:
   4603					;
   4604					;	     miniSO_sem[sem].status = FREE;
   4605					;
   4606	1670  8B DE			     mov     bx,si
   4607	1672  B1 03			     mov     cl,3
   4608	1674  D3 E3			     shl     bx,cl
   4609	1676  C7 87 01A7r FFFF		     mov     word ptr DGROUP:_miniSO_sem[bx],-1
   4610					;
   4611					;	     return miniSO_OK;
   4612					;
   4613	167C  B8 0001			     mov     ax,1
   4614	167F  EB ED			     jmp     short @35@114
   4615	1681			     @35@170:
   4616					;
   4617					;    }
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 82
scall.ASM



   4618					;
   4619	1681  5E			     pop     si
   4620	1682  5D			     pop     bp
   4621	1683  C3			     ret
   4622	1684			     _sc_semdestroy  endp
   4623					;
   4624					;    int sc_stop(pid_t pid) {
   4625					;
   4626					     assume  cs:_TEXT
   4627	1684			     _sc_stop	     proc    near
   4628	1684  55			     push    bp
   4629	1685  8B EC			     mov     bp,sp
   4630	1687  83 EC 02			     sub     sp,2
   4631	168A  56			     push    si
   4632	168B  57			     push    di
   4633					;
   4634					;
   4635					;	     pcb_t pcb,	prevthread, nextthread;
   4636					;
   4637					;	     disable();
   4638					;
   4639	168C  E8 0000e			     call    near ptr _disable
   4640					;
   4641					;	     /*	Tem que	verificar se existe a thread */
   4642					;	     pcb = get_pcb(pid);
   4643					;
   4644	168F  FF 76 04			     push    word ptr [bp+4]
   4645	1692  E8 EDED			     call    near ptr get_pcb
   4646	1695  59			     pop     cx
   4647	1696  8B F0			     mov     si,ax
   4648					;
   4649					;	     /*	Se nao existe uma thread com este numero ou se o estado	dela não é READY,   +
   4650				     entao retorna */
   4651					;	     if	(pcb ==	-1 || miniSO_thread[pcb].status	!= READY){
   4652					;
   4653	1698  83 FE FF			     cmp     si,-1
   4654	169B  74 10			     je	     short @36@86
   4655	169D  8B C6			     mov     ax,si
   4656	169F  BA 001A			     mov     dx,26
   4657	16A2  F7 EA			     imul    dx
   4658	16A4  8B D8			     mov     bx,ax
   4659	16A6  83 BF 000Br 00		     cmp     word ptr DGROUP:_miniSO_thread[bx+4],0
   4660	16AB  74 08			     je	     short @36@142
   4661	16AD			     @36@86:
   4662					;
   4663					;		     enable();
   4664					;
   4665	16AD  E8 0000e			     call    near ptr _enable
   4666					;
   4667					;		     return miniSO_ERROR;
   4668					;
   4669	16B0  B8 FFFF			     mov     ax,-1
   4670	16B3			     @36@114:
   4671	16B3  EB 70			     jmp     short @36@170
   4672	16B5			     @36@142:
   4673					;
   4674					;	     }
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 83
scall.ASM



   4675					;
   4676					;	     prevthread	= miniSO_thread[pcb].prev;
   4677					;
   4678	16B5  8B C6			     mov     ax,si
   4679	16B7  BA 001A			     mov     dx,26
   4680	16BA  F7 EA			     imul    dx
   4681	16BC  8B D8			     mov     bx,ax
   4682	16BE  8B BF 001Dr		     mov     di,word ptr DGROUP:_miniSO_thread[bx+22]
   4683					;
   4684					;	     nextthread	= miniSO_thread[pcb].next;
   4685					;
   4686	16C2  8B C6			     mov     ax,si
   4687	16C4  BA 001A			     mov     dx,26
   4688	16C7  F7 EA			     imul    dx
   4689	16C9  8B D8			     mov     bx,ax
   4690	16CB  8B 87 001Fr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+24]
   4691	16CF  89 46 FE			     mov     word ptr [bp-2],ax
   4692					;
   4693					;	     miniSO_thread[pcb].next = -1;
   4694					;
   4695	16D2  8B C6			     mov     ax,si
   4696	16D4  BA 001A			     mov     dx,26
   4697	16D7  F7 EA			     imul    dx
   4698	16D9  8B D8			     mov     bx,ax
   4699	16DB  C7 87 001Fr FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+24],-1
   4700					;
   4701					;	     miniSO_thread[pcb].prev = -1;
   4702					;
   4703	16E1  8B C6			     mov     ax,si
   4704	16E3  BA 001A			     mov     dx,26
   4705	16E6  F7 EA			     imul    dx
   4706	16E8  8B D8			     mov     bx,ax
   4707	16EA  C7 87 001Dr FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+22],-1
   4708					;
   4709					;
   4710					;	     /*	Exclui o nodo da lista de prontos */
   4711					;	     miniSO_thread[prevthread].next=nextthread;
   4712					;
   4713	16F0  8B C7			     mov     ax,di
   4714	16F2  BA 001A			     mov     dx,26
   4715	16F5  F7 EA			     imul    dx
   4716	16F7  8B 56 FE			     mov     dx,word ptr [bp-2]
   4717	16FA  8B D8			     mov     bx,ax
   4718	16FC  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   4719					;
   4720					;	     miniSO_thread[nextthread].prev=prevthread;
   4721					;
   4722	1700  8B 46 FE			     mov     ax,word ptr [bp-2]
   4723	1703  BA 001A			     mov     dx,26
   4724	1706  F7 EA			     imul    dx
   4725	1708  8B D8			     mov     bx,ax
   4726	170A  89 BF 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],di
   4727					;
   4728					;	     miniSO_thread[pcb].status = STOPPED;
   4729					;
   4730	170E  8B C6			     mov     ax,si
   4731	1710  BA 001A			     mov     dx,26
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 84
scall.ASM



   4732	1713  F7 EA			     imul    dx
   4733	1715  8B D8			     mov     bx,ax
   4734	1717  C7 87 000Br 0006		     mov     word ptr DGROUP:_miniSO_thread[bx+4],6
   4735					;
   4736					;	     enable();
   4737					;
   4738	171D  E8 0000e			     call    near ptr _enable
   4739					;
   4740					;	     return miniSO_OK;
   4741					;
   4742	1720  B8 0001			     mov     ax,1
   4743	1723  EB 8E			     jmp     short @36@114
   4744	1725			     @36@170:
   4745					;
   4746					;    }
   4747					;
   4748	1725  5F			     pop     di
   4749	1726  5E			     pop     si
   4750	1727  8B E5			     mov     sp,bp
   4751	1729  5D			     pop     bp
   4752	172A  C3			     ret
   4753	172B			     _sc_stop	     endp
   4754					;
   4755					;    int sc_resume(pid_t pid) {
   4756					;
   4757					     assume  cs:_TEXT
   4758	172B			     _sc_resume	     proc    near
   4759	172B  55			     push    bp
   4760	172C  8B EC			     mov     bp,sp
   4761	172E  56			     push    si
   4762	172F  57			     push    di
   4763					;
   4764					;	     pcb_t pcb,prevthread,nextthread,last;
   4765					;
   4766					;	     disable();
   4767					;
   4768	1730  E8 0000e			     call    near ptr _disable
   4769					;
   4770					;	     /*	Tem que	verificar se existe a thread */
   4771					;	     pcb = get_pcb(pid);
   4772					;
   4773	1733  FF 76 04			     push    word ptr [bp+4]
   4774	1736  E8 ED49			     call    near ptr get_pcb
   4775	1739  59			     pop     cx
   4776	173A  8B F0			     mov     si,ax
   4777					;
   4778					;	     /*	Se nao existe uma thread com este numero ou se o estado	dela não é STOPPED */
   4779					;	     if	(pcb ==	-1 || miniSO_thread[pcb].status	!= STOPPED) {
   4780					;
   4781	173C  83 FE FF			     cmp     si,-1
   4782	173F  74 10			     je	     short @37@86
   4783	1741  8B C6			     mov     ax,si
   4784	1743  BA 001A			     mov     dx,26
   4785	1746  F7 EA			     imul    dx
   4786	1748  8B D8			     mov     bx,ax
   4787	174A  83 BF 000Br 06		     cmp     word ptr DGROUP:_miniSO_thread[bx+4],6
   4788	174F  74 08			     je	     short @37@142
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 85
scall.ASM



   4789	1751			     @37@86:
   4790					;
   4791					;		     enable();
   4792					;
   4793	1751  E8 0000e			     call    near ptr _enable
   4794					;
   4795					;		     return miniSO_ERROR;
   4796					;
   4797	1754  B8 FFFF			     mov     ax,-1
   4798	1757			     @37@114:
   4799	1757  EB 5E			     jmp     short @37@170
   4800	1759			     @37@142:
   4801					;
   4802					;	     }
   4803					;
   4804					;	     last = miniSO_thread[miniSO_ready].prev;
   4805					;
   4806	1759  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   4807	175C  BA 001A			     mov     dx,26
   4808	175F  F7 EA			     imul    dx
   4809	1761  8B D8			     mov     bx,ax
   4810	1763  8B BF 001Dr		     mov     di,word ptr DGROUP:_miniSO_thread[bx+22]
   4811					;
   4812					;	     miniSO_thread[pcb].prev = last;
   4813					;
   4814	1767  8B C6			     mov     ax,si
   4815	1769  BA 001A			     mov     dx,26
   4816	176C  F7 EA			     imul    dx
   4817	176E  8B D8			     mov     bx,ax
   4818	1770  89 BF 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],di
   4819					;
   4820					;	     miniSO_thread[last].next=pcb;
   4821					;
   4822	1774  8B C7			     mov     ax,di
   4823	1776  BA 001A			     mov     dx,26
   4824	1779  F7 EA			     imul    dx
   4825	177B  8B D8			     mov     bx,ax
   4826	177D  89 B7 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],si
   4827					;
   4828					;	     miniSO_thread[miniSO_ready].prev=pcb;
   4829					;
   4830	1781  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   4831	1784  BA 001A			     mov     dx,26
   4832	1787  F7 EA			     imul    dx
   4833	1789  8B D8			     mov     bx,ax
   4834	178B  89 B7 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],si
   4835					;
   4836					;	     miniSO_thread[pcb].next=miniSO_ready;
   4837					;
   4838	178F  8B C6			     mov     ax,si
   4839	1791  BA 001A			     mov     dx,26
   4840	1794  F7 EA			     imul    dx
   4841	1796  8B 16 0007r		     mov     dx,word ptr DGROUP:_miniSO_ready
   4842	179A  8B D8			     mov     bx,ax
   4843	179C  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   4844					;
   4845					;	     miniSO_thread[pcb].status = READY;
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 86
scall.ASM



   4846					;
   4847	17A0  8B C6			     mov     ax,si
   4848	17A2  BA 001A			     mov     dx,26
   4849	17A5  F7 EA			     imul    dx
   4850	17A7  8B D8			     mov     bx,ax
   4851	17A9  C7 87 000Br 0000		     mov     word ptr DGROUP:_miniSO_thread[bx+4],0
   4852					;
   4853					;	     enable();
   4854					;
   4855	17AF  E8 0000e			     call    near ptr _enable
   4856					;
   4857					;	     return miniSO_OK;
   4858					;
   4859	17B2  B8 0001			     mov     ax,1
   4860	17B5  EB A0			     jmp     short @37@114
   4861	17B7			     @37@170:
   4862					;
   4863					;    }
   4864					;
   4865	17B7  5F			     pop     di
   4866	17B8  5E			     pop     si
   4867	17B9  5D			     pop     bp
   4868	17BA  C3			     ret
   4869	17BB			     _sc_resume	     endp
   4870	17BB			     _TEXT   ends
   4871	0000			     _BSS    segment word public 'BSS'
   4872	0000			     _miniSO_oldisr  label   dword
   4873	0000  04*(??)			     db	     4 dup (?)
   4874	0004			     _miniSO_nextthread	     label   word
   4875	0004  02*(??)			     db	     2 dup (?)
   4876	0006			     _miniSO_delcurthread    label   byte
   4877	0006  01*(??)			     db	     1 dup (?)
   4878	0007			     _miniSO_thread  label   word
   4879	0007  01A0*(??)			     db	     416 dup (?)
   4880	01A7			     _miniSO_sem     label   word
   4881	01A7  50*(??)			     db	     80	dup (?)
   4882					     ?debug  C E9
   4883					     ?debug  C FA00000000
   4884	01F7			     _BSS    ends
   4885	0094			     _DATA   segment word public 'DATA'
   4886	0094			     s@	     label   byte
   4887	0094  0A			     db	     10
   4888	0095  0A			     db	     10
   4889	0096  00			     db	     0
   4890	0097  50 72 65 73 73 69	6F+	     db	     'Pressione	uma tecla para reiniciar...'
   4891	      6E 65 20 75 6D 61	20+
   4892	      74 65 63 6C 61 20	70+
   4893	      61 72 61 20 72 65	69+
   4894	      6E 69 63 69 61 72	2E+
   4895	      2E 2E
   4896	00BC  0A			     db	     10
   4897	00BD  00			     db	     0
   4898	00BE  6B 69 6C 6C 28 29	3A+	     db	     'kill(): thread 0 excluida!'
   4899	      20 74 68 72 65 61	64+
   4900	      20 30 20 65 78 63	6C+
   4901	      75 69 64 61 21
   4902	00D8  00			     db	     0
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 87
scall.ASM



   4903	00D9  6B 69 6C 6C 28 29	3A+	     db	     'kill(): nao ha'
   4904	      20 6E 61 6F 20 68	61
   4905	00E7  27			     db	     39
   4906	00E8  20 6D 61 69 73 20	74+	     db	     ' mais threads executando!'
   4907	      68 72 65 61 64 73	20+
   4908	      65 78 65 63 75 74	61+
   4909	      6E 64 6F 21
   4910	0101  00			     db	     0
   4911	0102  77 61 69 74 70 69	64+	     db	     'waitpid(): nao ha'
   4912	      28 29 3A 20 6E 61	6F+
   4913	      20 68 61
   4914	0113  27			     db	     39
   4915	0114  20 6D 61 69 73 20	74+	     db	     ' mais threads executando!'
   4916	      68 72 65 61 64 73	20+
   4917	      65 78 65 63 75 74	61+
   4918	      6E 64 6F 21
   4919	012D  00			     db	     0
   4920	012E  77 61 69 74 28 29	3A+	     db	     'wait(): nao ha'
   4921	      20 6E 61 6F 20 68	61
   4922	013C  27			     db	     39
   4923	013D  20 6D 61 69 73 20	74+	     db	     ' mais threads executando!'
   4924	      68 72 65 61 64 73	20+
   4925	      65 78 65 63 75 74	61+
   4926	      6E 64 6F 21
   4927	0156  00			     db	     0
   4928	0157  65 78 69 74 28 29	3A+	     db	     'exit(): thread 0 removida!'
   4929	      20 74 68 72 65 61	64+
   4930	      20 30 20 72 65 6D	6F+
   4931	      76 69 64 61 21
   4932	0171  00			     db	     0
   4933	0172  65 78 69 74 28 29	3A+	     db	     'exit(): pai nao encontrado!'
   4934	      20 70 61 69 20 6E	61+
   4935	      6F 20 65 6E 63 6F	6E+
   4936	      74 72 61 64 6F 21
   4937	018D  00			     db	     0
   4938	018E  65 78 69 74 28 29	3A+	     db	     'exit(): nao ha'
   4939	      20 6E 61 6F 20 68	61
   4940	019C  27			     db	     39
   4941	019D  20 6D 61 69 73 20	74+	     db	     ' mais threads executando!'
   4942	      68 72 65 61 64 73	20+
   4943	      65 78 65 63 75 74	61+
   4944	      6E 64 6F 21
   4945	01B6  00			     db	     0
   4946	01B7  77 61 69 74 73 69	67+	     db	     'waitsignal(): nao	ha'
   4947	      6E 61 6C 28 29 3A	20+
   4948	      6E 61 6F 20 68 61
   4949	01CB  27			     db	     39
   4950	01CC  20 6D 61 69 73 20	74+	     db	     ' mais threads executando!'
   4951	      68 72 65 61 64 73	20+
   4952	      65 78 65 63 75 74	61+
   4953	      6E 64 6F 21
   4954	01E5  00			     db	     0
   4955	01E6  73 65 6D 64 6F 77	6E+	     db	     'semdown(): nao ha'
   4956	      28 29 3A 20 6E 61	6F+
   4957	      20 68 61
   4958	01F7  27			     db	     39
   4959	01F8  20 6D 61 69 73 20	74+	     db	     ' mais threads executando!'
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 88
scall.ASM



   4960	      68 72 65 61 64 73	20+
   4961	      65 78 65 63 75 74	61+
   4962	      6E 64 6F 21
   4963	0211  00			     db	     0
   4964	0212			     _DATA   ends
   4965	17BB			     _TEXT   segment byte public 'CODE'
   4966	17BB			     _TEXT   ends
   4967				     _get_sem_pos    equ     get_sem_pos
   4968					     extrn   _miniSO_return_addr:near
   4969					     public  _miniSO_contextswitch
   4970					     public  _scall
   4971				     _get_pcb	     equ     get_pcb
   4972				     _end_mso	     equ     end_mso
   4973				     _scroll equ     scroll
   4974				     _getCursorPosition	     equ     getCursorPosition
   4975				     _setCursorPosition	     equ     setCursorPosition
   4976					     public  _miniSO_scall_table
   4977					     public  _miniSO_oldisr
   4978					     public  _miniSO_nextthread
   4979					     public  _miniSO_delcurthread
   4980					     public  _miniSO_free
   4981					     public  _miniSO_ready
   4982					     public  _miniSO_thread
   4983				     _nextsemid	     equ     nextsemid
   4984					     public  _miniSO_sem
   4985				     _miniSO_key     equ     miniSO_key
   4986				     _miniSO_iskey   equ     miniSO_iskey
   4987				     _miniSO_pag     equ     miniSO_pag
   4988				     _miniSO_cor     equ     miniSO_cor
   4989				     _miniSO_col     equ     miniSO_col
   4990					     extrn   _putstr:near
   4991					     extrn   _getch:near
   4992					     extrn   _putch:near
   4993					     public  _sc_resume
   4994					     public  _sc_stop
   4995					     public  _sc_semdestroy
   4996					     public  _sc_semdown
   4997					     public  _sc_semup
   4998					     public  _sc_semset
   4999					     public  _sc_semcreate
   5000					     public  _sc_waitsignal
   5001					     public  _sc_sendsignal
   5002					     public  _sc_getppid
   5003					     public  _sc_getpid
   5004					     public  _sc_exit
   5005					     public  _sc_waitpid
   5006					     public  _sc_wait
   5007					     public  _sc_kill
   5008					     public  _sc_fork
   5009					     public  _sc_reboot
   5010					     public  _sc_gettime
   5011					     public  _sc_getdate
   5012					     public  _sc_gotoxy
   5013					     public  _sc_wherey
   5014					     public  _sc_wherex
   5015					     public  _sc_setcolor
   5016					     public  _sc_getcolor
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 89
scall.ASM



   5017					     public  _sc_clrscr
   5018					     public  _sc_getch
   5019					     public  _sc_putch
   5020					     public  _miniSO_init_semtable
   5021					     public  _miniSO_init_proctable
   5022					     extrn   _FP_OFF:near
   5023					     extrn   _FP_SEG:near
   5024					     extrn   _MK_FP:near
   5025					     extrn   _disable:near
   5026					     extrn   _enable:near
   5027					     extrn   _setvect:near
   5028				     _s@     equ     s@
   5029					     end
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 90
Symbol Table




Symbol Name		Type   Value			   Cref	(defined at #)

??DATE			Text   "12/05/15"
??FILENAME		Text   "scall	"
??TIME			Text   "11:08:16"
??VERSION		Number 030A
@10@58			Near   _TEXT:0207		   767	#768
@11@58			Near   _TEXT:0218		   790	#791
@12@58			Near   _TEXT:0244		   836	#837
@13@114			Near   _TEXT:02F3		   958	#959
@14@114			Near   _TEXT:038D		   1067	 #1068
@15@170			Near   _TEXT:03C6		   1112	 #1119
@15@226			Near   _TEXT:0403		   1118	 1146  #1155
@15@254			Near   _TEXT:0435		   1106	 #1188
@15@86			Near   _TEXT:03AC		   1088	 #1098
@17@142			Near   _TEXT:04AD		   #1308  1320
@17@170			Near   _TEXT:04AF		   1296	 1303  #1310
@17@198			Near   _TEXT:04B0		   1285	 #1312
@17@254			Near   _TEXT:04BA		   1309	 #1321
@17@58			Near   _TEXT:0489		   #1286  1314
@18@114			Near   _TEXT:04D0		   1342	 #1352
@18@58			Near   _TEXT:04C3		   #1343  1354
@19@114			Near   _TEXT:0596		   1462	 #1483
@19@58			Near   _TEXT:0576		   #1463  1485
@1@170			Near   _TEXT:0039		   #195	 276
@1@198			Near   _TEXT:0046		   #205	 219  234  250	265
@1@226			Near   _TEXT:0048		   #207	 277
@1@254			Near   _TEXT:0059		   #220	 278
@1@282			Near   _TEXT:006E		   #235	 279
@1@310			Near   _TEXT:0087		   182	192  #251
@1@338			Near   _TEXT:0088		   170	#253
@1@394			Near   _TEXT:0094		   206	#266
@1@58			Near   _TEXT:000D		   #171	 256
@1@C434			Word   _TEXT:0098		   194	#275
@20@114			Near   _TEXT:05D6		   1548	 #1549
@21@114			Near   _TEXT:05ED		   1585	 #1592
@21@142			Near   _TEXT:05F4		   #1603  1640
@21@198			Near   _TEXT:0607		   1616	 #1621
@21@254			Near   _TEXT:0617		   1626	 #1632
@21@282			Near   _TEXT:061B		   1602	 1631  #1638
@21@338			Near   _TEXT:081F		   1591	 #1929
@21@86			Near   _TEXT:05EA		   #1590  1928
@22@1010		Near   _TEXT:0A4C		   2299	 #2345
@22@1038		Near   _TEXT:0A5B		   2258	 #2355
@22@1066		Near   _TEXT:0A6C		   2365	 #2366
@22@1122		Near   _TEXT:0AFB		   2384	 #2449
@22@114			Near   _TEXT:084C		   #1984  2209
@22@1150		Near   _TEXT:0B05		   #2461  2462
@22@1178		Near   _TEXT:0B07		   2460	 #2463
@22@1206		Near   _TEXT:0B0D		   1994	 #2471
@22@142			Near   _TEXT:0852		   #1993  2470
@22@170			Near   _TEXT:0855		   1983	 #1995
@22@198			Near   _TEXT:0857		   #1997  2048
@22@226			Near   _TEXT:0897		   1996	 #2041
@22@310			Near   _TEXT:08AD		   #2056  2099
@22@394			Near   _TEXT:08F7		   2066	 2079  #2095
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 91
Symbol Table



@22@422			Near   _TEXT:08F8		   2055	 #2097
@22@562			Near   _TEXT:0936		   #2133  2482	2483
@22@646			Near   _TEXT:0971		   2165	 #2175
@22@674			Near   _TEXT:097C		   2159	 2174  #2186
@22@702			Near   _TEXT:097E		   #2193  2487
@22@730			Near   _TEXT:0980		   #2200  2485	2486  2488
@22@758			Near   _TEXT:0982		   2130	 #2208	2484
@22@786			Near   _TEXT:0985		   2192	 2199  2207  #2210
@22@842			Near   _TEXT:09C6		   2232	 #2259
@22@86			Near   _TEXT:083E		   1961	 #1969
@22@898			Near   _TEXT:0A05		   2278	 #2300
@22@926			Near   _TEXT:0A15		   #2312  2328
@22@954			Near   _TEXT:0A22		   2311	 #2322
@22@C1266		Word   _TEXT:0B13		   2132	 #2481
@23@114			Near   _TEXT:0B62		   #2544  2798
@23@142			Near   _TEXT:0B65		   2534	 #2546
@23@254			Near   _TEXT:0BC1		   2599	 #2608
@23@282			Near   _TEXT:0BC3		   2586	 #2613
@23@310			Near   _TEXT:0BD1		   2612	 #2623
@23@366			Near   _TEXT:0BE6		   2628	 #2638
@23@422			Near   _TEXT:0C17		   2557	 #2671
@23@478			Near   _TEXT:0C44		   2700	 #2708
@23@506			Near   _TEXT:0CB6		   2777	 #2778	2787
@23@562			Near   _TEXT:0CC8		   2666	 #2793
@23@590			Near   _TEXT:0CD6		   2545	 2670  #2799
@23@86			Near   _TEXT:0B5C		   2521	 #2535
@24@114			Near   _TEXT:0D2F		   2868	 #2876
@24@142			Near   _TEXT:0D96		   2938	 #2939	2948
@24@170			Near   _TEXT:0DA6		   2841	 #2949
@24@226			Near   _TEXT:0DF9		   2984	 #2997
@24@254			Near   _TEXT:0E50		   3047	 #3048
@25@114			Near   _TEXT:0E72		   #3090  3140
@25@142			Near   _TEXT:0EB3		   3089	 #3133
@25@226			Near   _TEXT:0ECA		   #3148  3191
@25@310			Near   _TEXT:0F16		   3158	 3171  #3187
@25@338			Near   _TEXT:0F17		   3147	 #3189
@25@422			Near   _TEXT:0F3D		   3208	 #3216
@25@506			Near   _TEXT:0F7F		   3239	 #3253
@25@534			Near   _TEXT:0FDC		   3232	 3252  #3307
@25@590			Near   _TEXT:100E		   3333	 #3341
@25@646			Near   _TEXT:1063		   3369	 #3391
@25@674			Near   _TEXT:1072		   #3402  3418
@25@702			Near   _TEXT:107F		   3401	 #3412
@25@758			Near   _TEXT:10AE		   3390	 #3436
@25@786			Near   _TEXT:10ED		   #3476  3477
@25@86			Near   _TEXT:0E70		   3080	 #3088
@26@58			Near   _TEXT:1108		   3505	 #3506
@27@58			Near   _TEXT:111D		   3529	 #3530
@28@114			Near   _TEXT:113E		   3566	 #3577
@28@198			Near   _TEXT:1212		   3599	 3626  #3703
@28@226			Near   _TEXT:121B		   3576	 #3715
@28@86			Near   _TEXT:113B		   #3575  3714
@29@142			Near   _TEXT:12A2		   3817	 #3825
@29@170			Near   _TEXT:12FC		   3782	 #3879
@29@226			Near   _TEXT:1307		   3890	 #3891	3900
@29@254			Near   _TEXT:1317		   3889	 #3901
@29@282			Near   _TEXT:131B		   3907	 #3908
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 92
Symbol Table



@29@86			Near   _TEXT:1268		   3761	 #3783
@30@142			Near   _TEXT:1346		   #3952  3963
@30@170			Near   _TEXT:1348		   3941	 3947  #3954
@30@198			Near   _TEXT:1349		   3932	 #3956
@30@254			Near   _TEXT:1353		   3953	 #3964
@30@58			Near   _TEXT:1328		   #3933  3958
@31@114			Near   _TEXT:136D		   #3998  4022
@31@170			Near   _TEXT:137D		   4005	 #4011
@31@198			Near   _TEXT:1381		   3997	 4010  #4017
@31@254			Near   _TEXT:13CE		   #4062  4076
@31@282			Near   _TEXT:13D0		   3996	 #4064
@31@310			Near   _TEXT:13D1		   3987	 #4066
@31@366			Near   _TEXT:13DD		   4063	 #4077
@31@58			Near   _TEXT:135E		   #3988  4069
@32@114			Near   _TEXT:1402		   #4118  4133
@32@142			Near   _TEXT:1404		   4112	 #4120
@32@170			Near   _TEXT:1416		   4119	 #4134
@32@86			Near   _TEXT:13FF		   4107	 #4113
@33@114			Near   _TEXT:143B		   4171	 #4182
@33@198			Near   _TEXT:149A		   4227	 #4239
@33@226			Near   _TEXT:14F7		   4199	 #4291
@33@254			Near   _TEXT:1500		   4181	 #4302
@33@86			Near   _TEXT:1438		   #4180  4301
@34@114			Near   _TEXT:1528		   4341	 #4352
@34@198			Near   _TEXT:1573		   4398	 #4406
@34@226			Near   _TEXT:1584		   #4420  4438
@34@254			Near   _TEXT:1598		   4419	 #4435
@34@366			Near   _TEXT:15C2		   4444	 #4464
@34@394			Near   _TEXT:15E0		   4463	 #4483
@34@422			Near   _TEXT:162B		   4529	 #4530	4539
@34@478			Near   _TEXT:163D		   4369	 #4545
@34@506			Near   _TEXT:1640		   4544	 #4551
@34@534			Near   _TEXT:1646		   4351	 #4557
@34@86			Near   _TEXT:1525		   #4350  4556
@35@114			Near   _TEXT:166E		   #4600  4614
@35@142			Near   _TEXT:1670		   4594	 #4602
@35@170			Near   _TEXT:1681		   4601	 #4615
@35@86			Near   _TEXT:166B		   4589	 #4595
@36@114			Near   _TEXT:16B3		   #4670  4743
@36@142			Near   _TEXT:16B5		   4660	 #4672
@36@170			Near   _TEXT:1725		   4671	 #4744
@36@86			Near   _TEXT:16AD		   4654	 #4661
@37@114			Near   _TEXT:1757		   #4798  4860
@37@142			Near   _TEXT:1759		   4788	 #4800
@37@170			Near   _TEXT:17B7		   4799	 #4861
@37@86			Near   _TEXT:1751		   4782	 #4789
@3@114			Near   _TEXT:00BF		   334	#335
@5@114			Near   _TEXT:010E		   433	#439
@5@142			Near   _TEXT:0111		   438	#445
@5@170			Near   _TEXT:0113		   411	#450
@5@310			Near   _TEXT:0153		   511	#517
@5@338			Near   _TEXT:0156		   449	502  516  #523
@5@366			Near   _TEXT:016A		   544	#545
@6@114			Near   _TEXT:0188		   570	#582
@6@226			Near   _TEXT:01AB		   617	#620
@6@254			Near   _TEXT:01B8		   619	#634
@6@282			Near   _TEXT:01BC		   581	#641
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 93
Symbol Table



@6@86			Near   _TEXT:0186		   #580	 640
@7@170			Near   _TEXT:01E0		   700	#701
@8@58			Near   _TEXT:01EB		   721	#722
@9@58			Near   _TEXT:01FA		   746	#747
@@0			Near   _TEXT:0090		   255	#257
@@1			Near   _TEXT:03B8		   1105	 #1107
@@10			Near   _TEXT:1542		   4368	 #4370
@@2			Near   _TEXT:0A85		   2383	 #2385
@@3			Near   _TEXT:0B79		   2556	 #2558
@@4			Near   _TEXT:0CFF		   2840	 #2842
@@5			Near   _TEXT:0F50		   3231	 #3233
@@6			Near   _TEXT:1161		   3598	 #3600
@@7			Near   _TEXT:1191		   3625	 #3627
@@8			Near   _TEXT:13D8		   4068	 #4070
@@9			Near   _TEXT:1455		   4198	 #4200
@CPU			Text   0101H
@CURSEG			Text   _TEXT			   #10	#14  #18  #22  #152  #1557  #1561  #4871  #4885	 #4965
@FILENAME		Text   SCALL
@WORDSIZE		Text   2			   #10	#14  #18  #22  #152  #1557  #1561  #4871  #4885	 #4965
B@			Byte   _BSS:0000		   #19
B@W			Word   _BSS:0000		   #20
D@			Byte   _DATA:0000		   #15
D@W			Word   _DATA:0000		   #16	1608  1620  1625  1630	1637
END_MSO			Near   _TEXT:043D		   #1205  1967	2172  2706  2874  3086	3214  3339  3823  4404
GETCURSORPOSITION	Near   _TEXT:00B0		   #314	 415  476  765	786
GET_PCB			Near   _TEXT:0482		   #1275  1609	1975  2225  2511  3201	3558  4645  4774
GET_SEM_POS		Near   _TEXT:1321		   #3922  4019	4100  4164  4334  4582
MINISO_COL		Byte   _DATA:0000		   #23	369  499  672
MINISO_COR		Byte   _DATA:0001		   #25	377  456  719  741
MINISO_ISKEY		Byte   _DATA:0003		   #29	569  574  624
MINISO_KEY		Byte   _DATA:0004		   #31	578  629
MINISO_PAG		Byte   _DATA:0002		   #27	295  321  460
NEXTSEMID		Word   _DATA:0005		   #33	4004  4009  4016  4018	4037  4039
S@			Byte   _DATA:0094		   1227	 1251  1965  2170  2704	 2872  3084  3212  3337	 3821  4402  #4886
SCROLL			Near   _TEXT:00C1		   #346	 444  522
SETCURSORPOSITION	Near   _TEXT:00A0		   #284	 538  694  830
_DISABLE		Near   ----:---- Extern		   1375	 1596  1955  2505  2827	 3074  3552  3745  4159	 4329  4639  4768 +
							   #5025
_ENABLE			Near   ----:---- Extern		   1222	 1508  1537  1923  1988	 2455  2539  2776  2937	 3475  3570  3709 +
							   3884	 4175  4296  4345  4528	 4550  4665  4738  4793	 4855  #5026
_END_MSO		Alias  END_MSO			   #4972
_FP_OFF			Near   ----:---- Extern		   1825	 #5022
_FP_SEG			Near   ----:---- Extern		   1810	 #5023
_GETCH			Near   ----:---- Extern		   1259	 #4991
_GETCURSORPOSITION	Alias  GETCURSORPOSITION	   #4974
_GET_PCB		Alias  GET_PCB			   #4971
_GET_SEM_POS		Alias  GET_SEM_POS		   #4967
_MINISO_COL		Alias  MINISO_COL		   #4989
_MINISO_CONTEXTSWITCH	Near   _TEXT:0391		   #1080  4969
_MINISO_COR		Alias  MINISO_COR		   #4988
_MINISO_DELCURTHREAD	Byte   _BSS:0006		   1111	 1117  1499  2185  2459	 3471  #4876  4979
_MINISO_FREE		Word   _DATA:0009		   #39	1457  1584  1646  1650	1655  2023  2029  2248	2254  2646  2653  +
							   3004	 3018  3115  3129  4980
_MINISO_INIT_PROCTABLE	Near   _TEXT:04D7		   #1365  5021
_MINISO_INIT_SEMTABLE	Near   _TEXT:04BC		   #1332  1381	5020
_MINISO_ISKEY		Alias  MINISO_ISKEY		   #4986
_MINISO_KEY		Alias  MINISO_KEY		   #4985
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 94
Symbol Table



_MINISO_NEXTTHREAD	Word   _BSS:0004		   1087	 1097  1103  1161  1194	 1503  2181  2772  2933	 3467  3874  4524 +
							   #4874  4978
_MINISO_OLDISR		Dword  _BSS:0000		   1213	 1214  1528  1529  #4872  4977
_MINISO_PAG		Alias  MINISO_PAG		   #4987
_MINISO_READY		Word   _DATA:0007		   #36	1092  1104  1125  1133	1141  1150  1162  1166	1175  1183  1386  +
							   1390	 1398  1406  1409  1415	 1418  1424  1432  1440	 1448  1667  1879 +
							   1901	 1915  2158  2164  2390	 2412  2427  2528  2590	 2677  2831  2835 +
							   2866	 3079  3103  3134  3165	 3175  3196  3246  3258	 3280  3294  3313 +
							   3322	 3331  3376  3382  3425	 3431  3441  3449  3457	 3500  3524  3633 +
							   3657	 3668  3749  4243  4269	 4280  4374  4806  4830	 4841  4981
_MINISO_RETURN_ADDR	Near   ----:---- Extern		   1797	 #4968
_MINISO_SCALL_TABLE	Word   _DATA:000B		   #42	179  190  204  217  231	 248  4976
_MINISO_SEM		Word   _BSS:01A7		   1350	 3940  3945  3995  4030	 4038  4047  4054  4061	 4111  4128  4190 +
							   4197	 4207  4219  4226  4234	 4360  4367  4418  4451	 4593  4609  #4880+
							   4984
_MINISO_THREAD		Word   _BSS:0007		   1096	 1129  1137  1145  1154	 1170  1179  1187  1295	 1301  1394  1402 +
							   1411	 1420  1428  1436  1444	 1452  1473  1481  1490	 1494  1654  1663 +
							   1671	 1678  1819  1834  1842	 1850  1858  1866  1874	 1883  1894  1903 +
							   1911	 1919  2009  2016  2025	 2037  2046  2065  2071	 2078  2087  2094 +
							   2109	 2118  2128  2145  2154	 2224  2241  2250  2269	 2277  2287  2295 +
							   2310	 2321  2327  2336  2344	 2354  2364  2377  2394	 2405  2414  2423 +
							   2432	 2440  2448  2526  2533	 2555  2572  2581  2594	 2607  2622  2637 +
							   2648	 2661  2685  2694  2717	 2725  2733  2742  2750	 2759  2768  2786 +
							   2797	 2839  2851  2860  2885	 2893  2901  2909  2919	 2928  2947  2960 +
							   2968	 2975  2983  2992  2996	 3006  3014  3036  3046	 3101  3108  3117 +
							   3125	 3138  3157  3163  3170	 3179  3186  3200  3230	 3238  3244  3251 +
							   3262	 3273  3282  3290  3298	 3306  3317  3326  3351	 3360  3368  3378 +
							   3386	 3400  3411  3417  3427	 3435  3445  3453  3462	 3504  3528  3588 +
							   3597	 3610  3617  3624  3637	 3645  3653  3661  3670	 3678  3687  3694 +
							   3702	 3758
_MK_FP			Near   ----:---- Extern		   864	985  1692  3024	 #5024
_NEXTSEMID		Alias  NEXTSEMID		   #4983
_PUTCH			Near   ----:---- Extern		   1245	 #4992
_PUTSTR			Near   ----:---- Extern		   1229	 1237  1253  #4990
_S@			Alias  S@			   #5028
_SCALL			Near   _TEXT:0000		   #157	 4970
_SCROLL			Alias  SCROLL			   #4973
_SC_CLRSCR		Near   _TEXT:01C0		   54  #653  5017
_SC_EXIT		Near   _TEXT:0E56		   106	1717  #3062  5004
_SC_FORK		Near   _TEXT:05D8		   90  #1566  5008
_SC_GETCH		Near   _TEXT:0170		   50  #559  5018
_SC_GETCOLOR		Near   _TEXT:01E2		   58  #712  5016
_SC_GETDATE		Near   _TEXT:0248		   78  #850  5011
_SC_GETPID		Near   _TEXT:10F5		   110	#3493  5003
_SC_GETPPID		Near   _TEXT:110A		   114	#3517  5002
_SC_GETTIME		Near   _TEXT:02F8		   82  #972  5010
_SC_GOTOXY		Near   _TEXT:021A		   74  #802  5012
_SC_KILL		Near   _TEXT:0825		   94  #1943  5007
_SC_PUTCH		Near   _TEXT:00DA		   46  #392  5019
_SC_REBOOT		Near   _TEXT:05B8		   86  1264  #1520  5009
_SC_RESUME		Near   _TEXT:172B		   150	#4758  4993
_SC_SEMCREATE		Near   _TEXT:1355		   126	#3975  4999
_SC_SEMDESTROY		Near   _TEXT:164C		   142	#4571  4995
_SC_SEMDOWN		Near   _TEXT:1506		   138	#4316  4996
_SC_SEMSET		Near   _TEXT:13E0		   130	#4089  4998
_SC_SEMUP		Near   _TEXT:1419		   134	#4146  4997
_SC_SENDSIGNAL		Near   _TEXT:111F		   118	#3541  5001
Turbo Assembler	 Version 3.1	    12/05/15 11:08:17	    Page 95
Symbol Table



_SC_SETCOLOR		Near   _TEXT:01ED		   62  #733  5015
_SC_STOP		Near   _TEXT:1684		   146	#4627  4994
_SC_WAIT		Near   _TEXT:0CDC		   102	#2814  5006
_SC_WAITPID		Near   _TEXT:0B21		   98  #2493  5005
_SC_WAITSIGNAL		Near   _TEXT:121F		   122	#3728  5000
_SC_WHEREX		Near   _TEXT:01FC		   66  #758  5014
_SC_WHEREY		Near   _TEXT:0209		   70  #779  5013
_SETCURSORPOSITION	Alias  SETCURSORPOSITION	   #4975
_SETVECT		Near   ----:---- Extern		   1217	 1532  #5027

Macro Name						   Cref	(defined at #)

$COMM							   #1

Groups & Segments	Bit Size Align	Combine	Class	   Cref	(defined at #)

DGROUP			Group				   #12	13  179	 190  204  217	231  248  295  321  369	 377  456  460	  +
							   499	569  574  578  624  629	 672  719  741	1087  1092  1096  1097	  +
							   1103	 1104  1111  1117  1125	 1129  1133  1137  1141	 1145  1150  1154 +
							   1161	 1162  1166  1170  1175	 1179  1183  1187  1194	 1213  1214  1227 +
							   1251	 1295  1301  1350  1386	 1390  1394  1398  1402	 1406  1409  1411 +
							   1415	 1418  1420  1424  1428	 1432  1436  1440  1444	 1448  1452  1457 +
							   1473	 1481  1490  1494  1499	 1503  1528  1529  1584	 1608  1620  1625 +
							   1630	 1637  1646  1650  1654	 1655  1663  1667  1671	 1678  1819  1834 +
							   1842	 1850  1858  1866  1874	 1879  1883  1894  1901	 1903  1911  1915 +
							   1919	 1965  2009  2016  2023	 2025  2029  2037  2046	 2065  2071  2078 +
							   2087	 2094  2109  2118  2128	 2145  2154  2158  2164	 2170  2181  2185 +
							   2224	 2241  2248  2250  2254	 2269  2277  2287  2295	 2310  2321  2327 +
							   2336	 2344  2354  2364  2377	 2390  2394  2405  2412	 2414  2423  2427 +
							   2432	 2440  2448  2459  2526	 2528  2533  2555  2572	 2581  2590  2594 +
							   2607	 2622  2637
  _BSS			16  01F7 Word	Public	BSS	   12  #18  #4871
  _DATA			16  0212 Word	Public	DATA	   12  #14  #22	 #1557	#4885
_TEXT			16  17BB Byte	Public	CODE	   #10	13  #152  156  283  313	 345  391  558	652  711  732  757  778	  +
							   801	849  971  1079	1204  1274  1331  1364	1519  #1561  1565  1942	  +
							   2492	 2813  3061  3492  3516	 3540  3727  3921  3974	 4088  4145  4315 +
							   4570	 4626  4757  #4965
